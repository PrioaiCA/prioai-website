<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Prio AI Dashboard - Manage your leads and account.">
    <title>Dashboard | Prio AI</title>
    <link rel="icon" type="image/png" href="/assets/icon_black.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/assets/styles.css">
    <style>
        .dashboard .container { max-width: 1500px; padding: 32px 48px; }
        .dashboard nav .container-lg { max-width: 1500px; padding: 0 48px; }
        
        .dashboard-loading { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; gap: 16px; }
        .dashboard-loading .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        .dashboard-content { display: none; }
        .dashboard-content.loaded { display: block; }
        .section-loading { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; gap: 12px; }
        .section-loading .spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        .section-loading-text { font-size: 0.875rem; color: var(--text-muted); }
        .tab-content.loading .table-container { display: none; }
        .tab-content.loading .section-loading { display: flex; }
        .tab-content:not(.loading) .section-loading { display: none; }
        .dashboard-tabs { display: flex; gap: 4px; margin-bottom: 24px; background: var(--bg-secondary); padding: 6px; border-radius: 12px; flex-wrap: wrap; }
        .tab-spacer { flex: 1; }
        .dashboard-tab { background: none; border: none; padding: 10px 20px; font-size: 0.875rem; color: var(--text-secondary); cursor: pointer; border-radius: 8px; transition: all 0.2s; font-family: inherit; font-weight: 500; white-space: nowrap; }
        .dashboard-tab:hover { color: var(--text-primary); background: rgba(255,255,255,0.05); }
        .dashboard-tab.active { background: var(--accent); color: white; box-shadow: 0 2px 8px rgba(79, 140, 255, 0.3); }
        .dashboard-tab-dropdown { position: relative; }
        .dashboard-tab-more { display: flex; align-items: center; gap: 4px; }
        .dropdown-arrow { font-size: 0.7rem; transition: transform 0.2s; }
        .dashboard-tab-dropdown.open .dropdown-arrow { transform: rotate(180deg); }
        .dropdown-menu { position: absolute; top: calc(100% + 8px); right: 0; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; min-width: 160px; padding: 6px; display: none; z-index: 100; box-shadow: 0 4px 16px rgba(0,0,0,0.3); }
        .dashboard-tab-dropdown.open .dropdown-menu { display: block; }
        .dropdown-item { display: block; width: 100%; padding: 10px 14px; text-align: left; background: none; border: none; color: var(--text-secondary); cursor: pointer; border-radius: 6px; font-size: 0.875rem; font-family: inherit; transition: all 0.2s; }
        .dropdown-item:hover { background: rgba(255,255,255,0.05); color: var(--text-primary); }
        .dropdown-item.active { background: var(--accent); color: white; }
        .leads-count-badge { display: inline-flex; align-items: center; justify-content: center; background: var(--accent); color: white; font-size: 0.875rem; font-weight: 600; padding: 4px 12px; border-radius: 20px; margin-left: 8px; min-width: 32px; }
        .leads-count-badge .badge-spinner { width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        .sortable-header { cursor: pointer; user-select: none; }
        .sortable-header:hover { color: var(--accent); }
        .sort-icon { display: inline-block; margin-left: 4px; opacity: 0.5; font-size: 0.75rem; }
        .sort-icon.active { opacity: 1; color: var(--accent); }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        .settings-section { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 16px; padding: 24px; margin-bottom: 24px; }
        .settings-section h3 { font-size: 1.125rem; margin-bottom: 16px; font-family: 'Outfit', sans-serif; }
        .settings-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        .feedback-types { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .feedback-type { padding: 10px 18px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 0.9375rem; }
        .feedback-type:hover { border-color: var(--accent); }
        .feedback-type.selected { background: rgba(59,130,246,0.15); border-color: var(--accent); color: var(--accent); }
        .file-upload-zone { border: 2px dashed var(--border); border-radius: 12px; padding: 48px; text-align: center; cursor: pointer; transition: all 0.2s; margin-bottom: 24px; }
        .file-upload-zone:hover { border-color: var(--accent); background: var(--bg-tertiary); }
        .file-upload-zone.dragover { border-color: var(--accent); background: rgba(59,130,246,0.1); }
        .file-upload-zone.uploading { pointer-events: none; opacity: 0.7; }
        .file-upload-zone input { display: none; }
        .file-upload-icon { font-size: 48px; margin-bottom: 16px; }
        .file-upload-zone p { color: var(--text-secondary); margin-bottom: 8px; }
        .file-upload-zone .supported { font-size: 0.875rem; color: var(--text-tertiary); }
        .template-download { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 24px; display: flex; align-items: center; justify-content: space-between; gap: 16px; flex-wrap: wrap; }
        .template-info h4 { margin-bottom: 4px; }
        .template-info p { color: var(--text-secondary); font-size: 0.875rem; }
        .upload-status { padding: 16px; border-radius: 8px; margin-top: 16px; }
        .upload-status.success { background: rgba(34,197,94,0.15); border: 1px solid rgba(34,197,94,0.3); color: #22C55E; }
        .upload-status.error { background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.3); color: #EF4444; }
        .upload-status.loading { background: rgba(59,130,246,0.15); border: 1px solid rgba(59,130,246,0.3); color: #3B82F6; }
        
        /* Analytics Date Pickers */
        #analyticsDatePicker:hover, #analyticsWeekPicker:hover, #analyticsMonthPicker:hover { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
        #analyticsDatePicker:focus, #analyticsWeekPicker:focus, #analyticsMonthPicker:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59,130,246,0.15); }
        #analyticsDateDisplay:hover { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
        
        /* Notification Bell */
        .notification-bell { position: relative; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px; padding: 8px 10px; cursor: pointer; transition: all 0.2s; }
        .notification-bell:hover { background: var(--bg-tertiary); border-color: var(--accent); }
        .notification-bell svg { width: 18px; height: 18px; color: var(--text-primary); display: block; }
        .notification-bell .notification-badge { position: absolute; top: -4px; right: -4px; background: #EF4444; color: white; font-size: 0.625rem; font-weight: 700; min-width: 18px; height: 18px; border-radius: 9px; display: flex; align-items: center; justify-content: center; padding: 0 4px; }
        .notification-bell .notification-badge:empty { display: none; }
        .notification-dropdown { position: absolute; top: 100%; right: 0; margin-top: 8px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; width: 360px; max-height: 480px; overflow-y: auto; box-shadow: 0 16px 48px rgba(0,0,0,0.4); z-index: 1000; display: none; }
        .notification-dropdown.active { display: block; }
        .notification-dropdown-header { display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid var(--border); }
        .notification-dropdown-header h4 { margin: 0; font-size: 1rem; }
        .notification-dropdown-header button { background: none; border: none; color: var(--accent); cursor: pointer; font-size: 0.75rem; }
        .notification-item { padding: 12px 16px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s; }
        .notification-item:hover { background: var(--bg-tertiary); }
        .notification-item:last-child { border-bottom: none; }
        .notification-item.unread { background: rgba(59,130,246,0.08); }
        .notification-item .notification-icon { display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 8px; margin-right: 12px; font-size: 1rem; }
        .notification-item .notification-icon.booked { background: rgba(34,197,94,0.2); }
        .notification-item .notification-icon.callback { background: rgba(59,130,246,0.2); }
        .notification-item .notification-icon.stats { background: rgba(168,85,247,0.2); }
        .notification-item .notification-icon.reminder { background: rgba(245,158,11,0.2); }
        .notification-item .notification-content { display: inline-block; vertical-align: middle; }
        .notification-item .notification-title { font-weight: 500; font-size: 0.875rem; margin-bottom: 2px; }
        .notification-item .notification-time { font-size: 0.75rem; color: var(--text-muted); }
        .notification-empty { padding: 40px 16px; text-align: center; color: var(--text-muted); }
        
        /* Header badges */
        .dashboard-header-top { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px; margin-bottom: 12px; padding: 8px 0; }
        .dashboard-header-info { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
        .user-phone { display: flex; flex-direction: column; gap: 2px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 10px 16px; font-size: 0.875rem; }
        .user-phone .phone-label { font-size: 0.625rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); }
        .user-phone .phone-number { display: flex; align-items: center; gap: 8px; font-weight: 500; }
        .user-phone svg { width: 14px; height: 14px; color: var(--accent); }
        
        /* Calls usage badge */
        .calls-usage { display: flex; flex-direction: column; gap: 4px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 10px 16px; min-width: 140px; }
        .calls-usage .usage-label { font-size: 0.625rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); }
        .calls-usage .usage-text { font-size: 0.875rem; font-weight: 600; }
        .calls-usage .usage-bar { height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden; margin-top: 2px; }
        .calls-usage .usage-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #8B5CF6); border-radius: 3px; transition: width 0.3s; }
        .calls-usage.warning .usage-bar-fill { background: linear-gradient(90deg, #F59E0B, #EF4444); }
        
        /* Analytics button */
        .analytics-btn { display: flex; flex-direction: column; gap: 2px; background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary)); border: 1px solid var(--accent); border-radius: 8px; padding: 10px 20px; cursor: pointer; transition: all 0.2s; text-decoration: none; }
        .analytics-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59,130,246,0.3); }
        .analytics-btn .btn-label { font-size: 0.625rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); }
        .analytics-btn .btn-value { font-size: 1.25rem; font-weight: 700; color: var(--accent); font-family: 'Outfit', sans-serif; display: flex; align-items: center; gap: 8px; }
        .analytics-btn .btn-value svg { width: 16px; height: 16px; }
        
        /* Section header */
        .dashboard-section-header h2 { font-size: 1.375rem; font-family: 'Outfit', sans-serif; margin-bottom: 4px; }
        
        /* Search box fix */
        .dashboard-filters { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .dashboard-filters input[type="search"] { min-width: 240px; width: 240px; padding: 10px 14px; }
        
        /* Table styles */
        .leads-table { width: 100%; border-collapse: collapse; }
        .leads-table tbody tr { cursor: pointer; transition: background 0.15s; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .leads-table tbody tr:hover { background: var(--bg-tertiary); }
        .leads-table th, .leads-table td { white-space: nowrap; }
        .leads-table .col-phone { min-width: 140px; }
        .leads-table .col-lastCalled { min-width: 110px; }
        .leads-table .col-bookedTime { min-width: 140px; }
        .leads-table .col-summary { white-space: normal; min-width: 200px; max-width: 350px; }
        .leads-table .col-notes { white-space: normal; min-width: 150px; max-width: 250px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .notes-cell { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; max-width: 200px; }
        .summary-text { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .prio-table .summary-text { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; max-width: 250px; }
        .leads-table .col-notes { white-space: normal; min-width: 150px; max-width: 250px; }
        
        /* Edit Lead button */
        .btn-edit-lead { background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(139,92,246,0.1)); color: var(--accent); border: 1px solid rgba(59,130,246,0.3); padding: 8px 16px; border-radius: 8px; font-size: 0.8125rem; font-weight: 500; cursor: pointer; transition: all 0.2s; white-space: nowrap; display: inline-flex; align-items: center; gap: 6px; }
        .btn-edit-lead:hover { background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(139,92,246,0.2)); border-color: var(--accent); transform: translateY(-1px); }
        .btn-edit-lead svg { width: 14px; height: 14px; }
        .search-result-item { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .search-result-item:hover { border-color: var(--accent); background: rgba(79, 140, 255, 0.05); }
        .search-result-item .lead-info { display: flex; flex-direction: column; gap: 4px; }
        .search-result-item .lead-name { font-weight: 600; font-size: 1rem; }
        .search-result-item .lead-phone { color: var(--text-secondary); font-size: 0.875rem; }
        .search-result-item .lead-status { }
        
        /* Take over button */
        .btn-takeover { background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(59,130,246,0.1)); color: #22C55E; border: 1px solid rgba(34,197,94,0.3); padding: 8px 14px; border-radius: 8px; font-size: 0.8125rem; font-weight: 500; cursor: pointer; transition: all 0.2s; white-space: nowrap; display: inline-flex; align-items: center; gap: 6px; }
        .btn-takeover:hover { background: linear-gradient(135deg, rgba(34,197,94,0.2), rgba(59,130,246,0.2)); border-color: #22C55E; transform: translateY(-1px); }
        .btn-takeover svg { width: 14px; height: 14px; }
        
        /* Column toggle */
        .column-toggle-wrapper { position: relative; }
        .column-toggle-btn { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 8px 16px; font-size: 0.875rem; cursor: pointer; display: flex; align-items: center; gap: 8px; color: var(--text-primary); }
        .column-toggle-btn:hover { border-color: var(--accent); }
        .column-dropdown { position: absolute; top: 100%; left: 0; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 8px 0; min-width: 180px; z-index: 100; display: none; margin-top: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .column-dropdown.active { display: block; }
        .column-option { display: flex; align-items: center; padding: 10px 16px; cursor: pointer; font-size: 0.875rem; gap: 8px; }
        .column-option:hover { background: var(--bg-tertiary); }
        .column-option input { width: 16px; height: 16px; margin: 0; accent-color: var(--accent); cursor: pointer; flex-shrink: 0; }
        .column-option span { white-space: nowrap; }
        
        /* Analytics styles */
        .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .analytics-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
        .analytics-card .label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
        .analytics-card .value { font-size: 1.75rem; font-weight: 700; font-family: 'Outfit', sans-serif; }
        .analytics-period-tabs { display: flex; gap: 8px; background: var(--bg-secondary); padding: 4px; border-radius: 8px; }
        .analytics-period-tab { background: none; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.875rem; color: var(--text-secondary); transition: all 0.2s; }
        .analytics-period-tab:hover { color: var(--text-primary); }
        .analytics-period-tab.active { background: var(--accent); color: white; }
        .analytics-table { width: 100%; border-collapse: collapse; border-radius: 8px; overflow: hidden; }
        .analytics-table th { padding: 12px 16px; text-align: left; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; }
        .analytics-table td { padding: 12px 16px; border-bottom: 1px solid var(--border); font-size: 0.875rem; }
        .analytics-table td:nth-child(3) { max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .analytics-lead-row:hover { background: rgba(255,255,255,0.05); }
        .booked-table { background: #14532d; }
        .booked-table th { background: #166534; color: #22c55e; }
        .booked-table td { color: var(--text-primary); border-color: #1f1f1f; }
        .booked-table td:last-child { color: #22c55e; }
        .interested-table { background: #172554; }
        .interested-table th { background: #1e3a8a; color: #3B82F6; }
        .interested-table td { color: var(--text-primary); border-color: #1f1f1f; }
        .interested-table td:last-child { color: #3B82F6; }
        .timeline-table { background: #451a03; }
        .timeline-table th { background: #78350f; color: #f59e0b; }
        .timeline-table td { color: var(--text-primary); border-color: #1f1f1f; }
        .timeline-table td:last-child { color: #f59e0b; }
        .outcome-pill { display: inline-block; background: var(--bg-tertiary); color: var(--text-secondary); padding: 6px 12px; border-radius: 16px; font-size: 0.8125rem; }
        .chart-container { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 24px; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .chart-header h3 { margin: 0; }
        
        /* Status breakdown cards */
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; }
        .status-card { background: var(--bg-tertiary); padding: 14px; border-radius: 10px; text-align: center; border: 1px solid transparent; }
        .status-card.highlight { border-color: var(--accent); background: rgba(59,130,246,0.08); }
        .status-card .status-count { font-size: 1.5rem; font-weight: 700; font-family: 'Outfit', sans-serif; }
        .status-card .status-name { font-size: 0.625rem; color: var(--text-secondary); text-transform: uppercase; margin-top: 4px; display: flex; align-items: center; justify-content: center; gap: 4px; }
        
        /* Info tooltip */
        .info-icon { display: inline-flex; align-items: center; justify-content: center; cursor: help; position: relative; }
        .info-icon svg { width: 14px; height: 14px; color: var(--text-secondary); }
        .info-icon:hover svg { color: var(--accent); }
        .info-icon .info-tip { visibility: hidden; opacity: 0; position: absolute; bottom: calc(100% + 8px); left: 50%; transform: translateX(-50%); background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-primary); padding: 10px 12px; border-radius: 8px; font-size: 0.75rem; width: 200px; z-index: 100; line-height: 1.4; font-weight: 400; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: opacity 0.2s, visibility 0.2s; text-transform: none; }
        .info-icon:hover .info-tip { visibility: visible; opacity: 1; }
        
        /* Pipeline table */
        .pipeline-table { width: 100%; border-collapse: collapse; }
        .pipeline-table th, .pipeline-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); font-size: 0.875rem; }
        .pipeline-table th { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); font-weight: 600; }
        .pipeline-table tbody tr:hover { background: var(--bg-secondary); }
        .pipeline-table .summary-cell { max-width: 280px; white-space: normal; color: var(--text-secondary); }
        .pipeline-table .summary-text { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .pipeline-table .summary-text.expanded { -webkit-line-clamp: unset; display: block; }
        
        /* Lead Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 16px; max-width: 800px; width: 95%; max-height: 90vh; overflow-y: auto; position: relative; }
        .modal-header { padding: 20px 24px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .modal-header h2 { font-size: 1.5rem; font-family: 'Outfit', sans-serif; margin: 0; }
        .modal-close { background: none; border: none; font-size: 28px; cursor: pointer; color: var(--text-secondary); padding: 0; line-height: 1; }
        .modal-close:hover { color: var(--text-primary); }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 16px 24px; display: flex; gap: 12px; justify-content: flex-end; border-top: 1px solid var(--border); flex-wrap: wrap; }
        
        /* Modal navigation arrows */
        .modal-nav { position: fixed; top: 50%; transform: translateY(-50%); background: var(--accent); border: 2px solid var(--accent); width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1001; transition: all 0.2s; color: white; }
        .modal-nav:hover { background: var(--accent); border-color: white; box-shadow: 0 0 12px rgba(79, 140, 255, 0.5); }
        .modal-nav:disabled { opacity: 0.3; cursor: not-allowed; background: var(--bg-secondary); border-color: var(--border); color: var(--text-muted); }
        .modal-nav:disabled:hover { background: var(--bg-secondary); border-color: var(--border); color: var(--text-muted); box-shadow: none; }
        .modal-nav svg { width: 24px; height: 24px; stroke: currentColor; }
        .modal-nav-prev { left: calc(50% - 480px); }
        .modal-nav-next { right: calc(50% - 480px); }
        @media(max-width: 1100px) { .modal-nav-prev { left: 8px; } .modal-nav-next { right: 8px; } }
        
        /* Lead info grid */
        .lead-info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin: 20px 0; }
        .lead-info-item { background: var(--bg-tertiary); border-radius: 8px; padding: 12px; }
        .lead-info-item label { display: block; font-size: 0.6875rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); margin-bottom: 4px; }
        .lead-info-item .value { font-size: 0.9375rem; color: var(--text-primary); }
        .lead-info-full { grid-column: span 2; }
        
        /* Notes tooltip */
        .info-tooltip { position: relative; display: inline-flex; align-items: center; margin-left: 6px; cursor: help; }
        .info-icon { font-size: 1rem; color: var(--text-muted); opacity: 0.7; transition: all 0.2s; }
        .info-tooltip:hover .info-icon { color: var(--accent); opacity: 1; }
        .info-tooltip .tooltip-text { visibility: hidden; opacity: 0; position: absolute; bottom: calc(100% + 8px); left: 50%; transform: translateX(-50%); background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-primary); padding: 10px 12px; border-radius: 8px; font-size: 0.75rem; width: 220px; z-index: 100; line-height: 1.4; font-weight: 400; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: opacity 0.2s, visibility 0.2s; }
        .info-tooltip:hover .tooltip-text { visibility: visible; opacity: 1; }
        
        /* Agent notes section */
        .agent-notes-section { margin: 20px 0; }
        .agent-notes-section h3 { font-size: 1rem; margin-bottom: 8px; display: flex; align-items: center; }
        .agent-notes-section textarea { width: 100%; min-height: 100px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-tertiary); color: var(--text-primary); font-family: inherit; font-size: 0.9375rem; resize: vertical; }
        .agent-notes-section textarea:focus { outline: none; border-color: var(--accent); }
        .notes-required { font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px; }
        
        /* Transcript section */
        .transcript-section { margin-top: 20px; }
        .transcript-section h3 { font-size: 1rem; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; color: var(--text-secondary); }
        .transcript-content { max-height: 300px; overflow-y: auto; background: var(--bg-tertiary); border-radius: 8px; padding: 16px; font-size: 0.875rem; line-height: 1.6; white-space: pre-wrap; color: var(--text-secondary); }
        .transcript-content.large-font { font-size: 1.0625rem; line-height: 1.8; }
        .btn-transcript-expand { background: none; border: 1px solid var(--border); border-radius: 4px; padding: 4px 10px; cursor: pointer; color: var(--text-secondary); transition: all 0.2s; font-size: 0.75rem; margin-left: auto; }
        .btn-transcript-expand:hover { border-color: var(--accent); color: var(--accent); background: rgba(79, 140, 255, 0.1); }
        .transcript-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 24px; }
        .transcript-modal.active { display: flex; }
        .transcript-modal-content { background: var(--bg-secondary); border-radius: 16px; width: 100%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; }
        .transcript-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border); }
        .transcript-modal-header h3 { font-size: 1.25rem; }
        .transcript-modal-body { padding: 24px; overflow-y: auto; flex: 1; font-size: 1rem; line-height: 1.8; white-space: pre-wrap; }
        .transcript-name { font-weight: 600; color: var(--text-primary); }
        .transcript-ai { color: var(--accent); }
        .btn-transcript-size { background: none; border: 1px solid var(--border); border-radius: 4px; padding: 4px 8px; cursor: pointer; color: var(--text-secondary); transition: all 0.2s; }
        .btn-transcript-size:hover { border-color: var(--accent); color: var(--accent); }
        .btn-transcript-size.active { background: var(--accent); border-color: var(--accent); color: white; }
        .btn-report-bug { background: none; border: 1px solid var(--border); border-radius: 6px; padding: 6px 12px; cursor: pointer; color: var(--text-muted); transition: all 0.2s; font-size: 0.8125rem; }
        .btn-report-bug:hover { color: #EF4444; border-color: #EF4444; }
        .btn-prio { background: linear-gradient(135deg, #F59E0B, #D97706); border: none; border-radius: 8px; padding: 8px 16px; cursor: pointer; color: white; font-size: 0.8125rem; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-prio:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4); }
        .btn-prio.is-prio { background: linear-gradient(135deg, #10B981, #059669); }
        .btn-edit-inline { background: none; border: none; cursor: pointer; font-size: 0.75rem; padding: 2px 4px; opacity: 0.6; transition: opacity 0.2s; }
        .btn-edit-inline:hover { opacity: 1; }
        .btn-sm { padding: 6px 12px; font-size: 0.8125rem; }
        .prio-tab { background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.2)) !important; border: 1px solid rgba(245, 158, 11, 0.3) !important; }
        .prio-tab.active { background: linear-gradient(135deg, #F59E0B, #D97706) !important; color: white !important; border-color: #F59E0B !important; }
        .prio-table th:nth-child(1), .prio-table td:nth-child(1) { min-width: 100px; } /* First Name */
        .prio-table th:nth-child(2), .prio-table td:nth-child(2) { min-width: 100px; } /* Last Name */
        .prio-table th:nth-child(3), .prio-table td:nth-child(3) { min-width: 140px; } /* Phone */
        .prio-table th:nth-child(4), .prio-table td:nth-child(4) { min-width: 110px; } /* Last Called */
        .prio-table th:nth-child(5), .prio-table td:nth-child(5) { min-width: 140px; } /* Booked Time */
        .prio-table th:nth-child(6), .prio-table td:nth-child(6) { white-space: normal; min-width: 200px; max-width: 300px; } /* Summary */
        .prio-table th:nth-child(7), .prio-table td:nth-child(7) { white-space: normal; min-width: 150px; max-width: 200px; } /* Notes */
        .prio-table th:nth-child(8), .prio-table td:nth-child(8) { min-width: 100px; } /* Action */
        .btn-remove-prio { background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.4); border-radius: 6px; padding: 6px 14px; cursor: pointer; color: #EF4444; font-size: 0.8125rem; font-weight: 500; transition: all 0.2s; }
        .btn-remove-prio:hover { background: #EF4444; border-color: #EF4444; color: white; }
        .btn-schedule-inline { background: var(--accent); border: none; border-radius: 4px; padding: 4px 10px; cursor: pointer; color: white; font-size: 0.75rem; font-weight: 500; transition: all 0.2s; }
        .btn-schedule-inline:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-delete-booking { background: none; border: none; cursor: pointer; font-size: 0.875rem; padding: 2px 6px; color: #ef4444; opacity: 0.7; transition: all 0.2s; vertical-align: middle; margin-left: 6px; font-weight: bold; }
        .btn-delete-booking:hover { opacity: 1; transform: scale(1.2); }
        .btn-delete-booking-modal { background: none; border: none; cursor: pointer; font-size: 0.875rem; padding: 2px 6px; color: #ef4444; opacity: 0.7; transition: all 0.2s; vertical-align: middle; margin-left: 6px; font-weight: bold; }
        .btn-delete-booking-modal:hover { opacity: 1; transform: scale(1.2); }
        .btn-gcal { background: none; border: none; cursor: pointer; font-size: 1rem; padding: 2px 6px; opacity: 0.7; transition: opacity 0.2s; vertical-align: middle; }
        .btn-gcal:hover { opacity: 1; }
        .schedule-modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1100; opacity: 0; visibility: hidden; transition: all 0.2s; }
        .schedule-modal-overlay.active { opacity: 1; visibility: visible; }
        .schedule-modal { background: var(--bg-secondary); border-radius: 16px; padding: 24px; max-width: 420px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .schedule-modal h3 { margin-bottom: 16px; font-size: 1.25rem; }
        .schedule-modal .form-group { margin-bottom: 16px; }
        .schedule-modal label { display: block; margin-bottom: 8px; font-size: 0.875rem; color: var(--text-secondary); font-weight: 500; }
        .schedule-modal-actions { display: flex; gap: 12px; margin-top: 20px; }
        .schedule-modal-actions button { flex: 1; padding: 12px; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .schedule-modal .btn-cancel { background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); }
        .schedule-modal .btn-save { background: var(--accent); border: none; color: white; }
        .schedule-modal .btn-save:hover { opacity: 0.9; }
        .schedule-modal .gcal-section { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }
        
        /* Calendar Picker */
        .calendar-picker { background: var(--bg-primary); border-radius: 12px; padding: 16px; border: 1px solid var(--border); }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .calendar-header button { background: none; border: none; color: var(--text-primary); cursor: pointer; padding: 8px; border-radius: 6px; font-size: 1.25rem; }
        .calendar-header button:hover { background: var(--bg-tertiary); }
        .calendar-month { font-weight: 600; font-size: 1rem; }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; margin-bottom: 8px; }
        .calendar-weekdays span { font-size: 0.75rem; color: var(--text-muted); font-weight: 500; padding: 8px 0; }
        .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; font-size: 0.875rem; transition: all 0.15s; border: none; background: none; color: var(--text-primary); }
        .calendar-day:hover:not(.disabled):not(.selected) { background: var(--bg-tertiary); }
        .calendar-day.selected { background: var(--accent); color: white; font-weight: 600; }
        .calendar-day.today:not(.selected) { border: 2px solid var(--accent); }
        .calendar-day.disabled { color: var(--text-muted); opacity: 0.4; cursor: not-allowed; }
        .calendar-day.other-month { opacity: 0.3; }
        
        /* Time Picker */
        .time-picker { display: flex; gap: 12px; align-items: center; }
        .time-select-group { display: flex; align-items: center; gap: 4px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; }
        .time-select { background: none; border: none; color: var(--text-primary); font-size: 1.25rem; font-weight: 600; width: 50px; text-align: center; cursor: pointer; }
        .time-select:focus { outline: none; }
        .time-separator { font-size: 1.25rem; font-weight: 600; color: var(--text-muted); }
        .time-period { display: flex; flex-direction: column; gap: 4px; }
        .time-period button { padding: 6px 12px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-secondary); border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 600; transition: all 0.15s; }
        .time-period button.active { background: var(--accent); color: white; border-color: var(--accent); }
        .time-period button:hover:not(.active) { background: var(--bg-tertiary); }
        
        /* Quick time slots */
        .time-slots { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 12px; }
        .time-slot { padding: 10px 8px; border: 1px solid var(--border); background: var(--bg-primary); border-radius: 8px; cursor: pointer; font-size: 0.8125rem; text-align: center; transition: all 0.15s; color: var(--text-primary); }
        .time-slot:hover { border-color: var(--accent); background: rgba(59,130,246,0.1); }
        .time-slot.selected { background: var(--accent); color: white; border-color: var(--accent); }
        
        /* Schedule button in modal */
        .btn-schedule-modal { background: var(--accent); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500; display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s; }
        .btn-schedule-modal:hover { opacity: 0.9; }
        .btn-add-gcal { display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 12px; background: #4285F4; border: none; border-radius: 8px; color: white; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        
        /* Voice Input Button */
        .notes-toolbar { position: absolute; right: 12px; bottom: 12px; display: flex; gap: 8px; align-items: center; }
        .voice-input-btn { width: 36px; height: 36px; border-radius: 50%; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .voice-input-btn:hover { background: var(--accent); color: white; border-color: var(--accent); }
        .voice-input-btn.recording { background: #EF4444; color: white; border-color: #EF4444; animation: pulse-recording 1.5s infinite; }
        .polish-notes-btn { background: linear-gradient(135deg, #8B5CF6, #EC4899); border: none; color: white; padding: 8px 12px; border-radius: 8px; font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 4px; }
        .polish-notes-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .polish-notes-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .polish-notes-btn.loading { animation: shimmer 1.5s infinite; }
        .save-note-btn { background: var(--accent); border: none; color: white; padding: 8px 12px; border-radius: 8px; font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 4px; }
        .save-note-btn:hover { opacity: 0.9; }
        .save-note-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        /* Note item styling */
        .note-item { display: flex; flex-direction: column; gap: 4px; padding: 10px 12px; background: var(--bg-secondary); border-radius: 6px; font-size: 0.8125rem; }
        .note-item-header { display: flex; justify-content: space-between; align-items: center; }
        .note-item-time { color: var(--text-muted); font-size: 0.75rem; }
        .note-item-actions { display: flex; gap: 4px; }
        .note-item-actions button { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 2px 6px; font-size: 0.75rem; opacity: 0.6; transition: all 0.2s; }
        .note-item-actions button:hover { opacity: 1; color: var(--accent); }
        .note-item-text { color: var(--text-primary); line-height: 1.5; white-space: pre-wrap; font-size: 0.9375rem; }
        @keyframes shimmer { 0% { background-position: -200% center; } 100% { background-position: 200% center; } }
        
        /* Polish Preview Modal */
        .polish-preview-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1200; opacity: 0; visibility: hidden; transition: all 0.2s; }
        .polish-preview-modal.active { opacity: 1; visibility: visible; }
        .polish-preview-content { background: var(--bg-secondary); border-radius: 16px; padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .polish-preview-content h3 { margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .polish-comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
        .polish-box { background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; padding: 12px; }
        .polish-box-label { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px; font-weight: 600; text-transform: uppercase; }
        .polish-box-text { font-size: 0.875rem; line-height: 1.6; white-space: pre-wrap; }
        .polish-actions { display: flex; gap: 12px; }
        .polish-actions button { flex: 1; padding: 12px; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .polish-accept { background: #22C55E; border: none; color: white; }
        .polish-accept:hover { background: #16A34A; }
        .polish-reject { background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); }
        @media (max-width: 600px) { .polish-comparison { grid-template-columns: 1fr; } }
        @keyframes pulse-recording { 0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); } 50% { box-shadow: 0 0 0 8px rgba(239,68,68,0); } }
        
        /* Admin Panel */
        .admin-panel { background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(59,130,246,0.1)); border: 1px solid rgba(139,92,246,0.3); border-radius: 12px; padding: 16px; margin-bottom: 24px; }
        .admin-panel-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .admin-badge { background: linear-gradient(135deg, #8B5CF6, #3B82F6); color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; }
        .admin-panel select { flex: 1; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary); font-family: inherit; font-size: 0.875rem; }
        .admin-panel select:focus { outline: none; border-color: var(--accent); }
        .admin-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-top: 12px; }
        .admin-stat { background: var(--bg-primary); padding: 12px; border-radius: 8px; text-align: center; }
        .admin-stat-value { font-size: 1.5rem; font-weight: 700; color: var(--accent); }
        .admin-stat-label { font-size: 0.75rem; color: var(--text-muted); }
        .btn-add-gcal:hover { background: #3367D6; }
        .btn-add-gcal svg { width: 20px; height: 20px; }
        .toast-notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 16px 24px; z-index: 3000; box-shadow: 0 8px 32px rgba(0,0,0,0.4); display: none; align-items: center; gap: 12px; max-width: 400px; }
        .toast-notification.active { display: flex; animation: toastSlide 0.3s ease; }
        .toast-notification.warning { border-color: #F59E0B; }
        .toast-notification.error { border-color: #EF4444; }
        .toast-notification.success { border-color: #10B981; }
        .toast-notification .toast-icon { font-size: 1.25rem; }
        .toast-notification .toast-message { flex: 1; font-size: 0.9375rem; }
        .toast-notification .toast-close { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.25rem; padding: 0 4px; }
        @keyframes toastSlide { from { opacity: 0; transform: translateX(-50%) translateY(-20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        
        /* Save & Send Back button */
        .btn-send-back { background: linear-gradient(135deg, #8B5CF6, #3B82F6); color: white; border: none; padding: 10px 18px; border-radius: 8px; font-size: 0.875rem; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; font-weight: 500; }
        .btn-send-back:hover { transform: scale(1.02); box-shadow: 0 4px 12px rgba(139,92,246,0.4); }
        .btn-send-back:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-send-back svg { width: 16px; height: 16px; }
        
        /* Confirm modals */
        .confirm-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 1003; }
        .confirm-modal.active { display: flex; }
        .confirm-modal-content { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 16px; padding: 24px; max-width: 420px; width: 90%; text-align: center; }
        .confirm-modal-content h3 { margin-bottom: 12px; font-family: 'Outfit', sans-serif; }
        .confirm-modal-content p { color: var(--text-secondary); margin-bottom: 20px; font-size: 0.9375rem; line-height: 1.5; }
        .confirm-btns { display: flex; gap: 12px; }
        .confirm-btns button { flex: 1; }
        
        /* Follow up modal */
        .followup-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 1002; }
        .followup-modal.active { display: flex; }
        .followup-modal-content { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 16px; padding: 24px; max-width: 360px; width: 90%; }
        .followup-modal-content h3 { margin-bottom: 8px; font-family: 'Outfit', sans-serif; display: flex; align-items: center; gap: 8px; }
        
        /* Followup modal button styles */
        .followup-reason-btn, .followup-period-btn, .followup-time-btn {
            padding: 14px 16px;
            border-radius: 12px;
            border: 2px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            font-weight: 500;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .followup-reason-btn { justify-content: flex-start; }
        .followup-reason-btn:hover, .followup-period-btn:hover, .followup-time-btn:hover {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.08);
        }
        .followup-reason-btn.selected, .followup-period-btn.selected, .followup-time-btn.selected {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .calendar-container { background: var(--bg-primary); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-weight: 600; }
        .calendar-nav { background: none; border: none; color: var(--text-secondary); font-size: 1.25rem; cursor: pointer; padding: 4px 12px; border-radius: 6px; transition: all 0.2s; }
        .calendar-nav:hover { background: var(--bg-secondary); color: var(--text-primary); }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px; }
        .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 0.875rem; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .calendar-day:hover:not(.disabled):not(.selected) { background: var(--bg-secondary); }
        .calendar-day.selected { background: var(--accent); color: white; }
        .calendar-day.today { border-color: var(--accent); }
        .calendar-day.disabled { color: var(--text-muted); opacity: 0.4; cursor: not-allowed; }
        .calendar-day.other-month { color: var(--text-muted); opacity: 0.3; }
        .time-options { display: flex; gap: 8px; }
        .time-option { flex: 1; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; padding: 14px 8px; cursor: pointer; text-align: center; transition: all 0.2s; font-family: inherit; color: var(--text-primary); font-size: 0.9375rem; }
        .time-option:hover { border-color: var(--accent); }
        .time-option.selected { background: var(--accent); border-color: var(--accent); color: white; }
        
        /* Profile Page - Clean & Compact */
        .profile-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 16px; padding: 24px; margin-bottom: 20px; }
        .profile-card-header { display: flex; align-items: center; gap: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
        .profile-avatar { width: 72px; height: 72px; border-radius: 50%; background: var(--bg-tertiary); border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 1.75rem; font-weight: 600; color: var(--accent); overflow: hidden; flex-shrink: 0; }
        .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .profile-header-info { flex: 1; }
        .profile-header-info h2 { font-size: 1.25rem; font-family: 'Outfit', sans-serif; margin-bottom: 4px; }
        .profile-header-info p { color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 8px; }
        .profile-header-actions { display: flex; gap: 8px; }
        .profile-header-actions input { display: none; }
        .profile-btn-sm { background: var(--bg-tertiary); border: 1px solid var(--border); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8125rem; color: var(--text-primary); transition: all 0.2s; }
        .profile-btn-sm:hover { border-color: var(--accent); }
        .profile-btn-sm.danger { color: #EF4444; }
        .profile-btn-sm.danger:hover { border-color: #EF4444; }
        
        .profile-info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        .profile-info-item { background: var(--bg-tertiary); border-radius: 8px; padding: 14px; }
        .profile-info-item .label { font-size: 0.6875rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); margin-bottom: 4px; }
        .profile-info-item .value { font-size: 0.9375rem; color: var(--text-primary); font-weight: 500; }
        
        .profile-section { margin-bottom: 20px; }
        .profile-section:last-child { margin-bottom: 0; }
        .profile-section-title { font-size: 0.8125rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); margin-bottom: 12px; }
        .profile-form-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px; }
        .profile-form-row.single { grid-template-columns: 1fr; }
        .profile-form-group label { display: block; font-size: 0.8125rem; font-weight: 500; margin-bottom: 6px; color: var(--text-secondary); }
        .profile-form-group input, .profile-form-group select { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 0.9375rem; }
        .profile-form-group input:focus, .profile-form-group select:focus { outline: none; border-color: var(--accent); }
        
        .profile-danger-zone { border-color: rgba(239,68,68,0.3); }
        .profile-danger-zone h3 { color: #EF4444; }
        
        /* Responsive */
        @media(max-width:768px) { 
            .profile-form-row, .profile-info-grid { grid-template-columns: 1fr; } 
            .template-download { flex-direction: column; text-align: center; }
            .dashboard-header-top { flex-direction: column; align-items: flex-start; }
            .analytics-grid { grid-template-columns: repeat(2, 1fr); }
            .dashboard-header-info { width: 100%; justify-content: space-between; flex-wrap: wrap; }
            .lead-info-grid { grid-template-columns: 1fr; }
            .lead-info-full { grid-column: span 1; }
            .modal-footer { justify-content: stretch; }
            .modal-footer button { flex: 1; }
            .dashboard-filters input[type="search"] { min-width: 180px; width: 100%; }
            .profile-card-header { flex-direction: column; text-align: center; }
            .profile-header-info { text-align: center; }
            .dashboard-tabs { flex-wrap: wrap; gap: 8px; }
            .dashboard-tab { padding: 8px 12px; font-size: 0.8rem; }
            .analytics-period-tabs { flex-wrap: wrap; }
            .analytics-period-tab { padding: 6px 12px; font-size: 0.8rem; }
            .notification-dropdown { width: 300px; right: -100px; }
            .leads-table-wrapper { overflow-x: auto; }
            .leads-table { min-width: 800px; }
            #analyticsPickerRow select, #analyticsPickerRow input { width: 100%; }
        }
        @media(max-width:480px) {
            .analytics-grid { grid-template-columns: 1fr; }
            .status-grid { grid-template-columns: repeat(2, 1fr); }
            .dashboard-header-info { flex-direction: column; align-items: stretch; }
            .analytics-btn, .calls-usage, .user-phone { width: 100%; justify-content: center; }
            .notification-dropdown { width: calc(100vw - 24px); right: 0; left: auto; }
            .modal-body { padding: 16px; }
            .modal-header { padding: 16px; }
            .modal-footer { padding: 16px; flex-direction: column; }
            .modal-footer button { width: 100%; }
            h1 { font-size: 1.25rem; }
            .dashboard-section { padding: 16px; }
        }
        
        /* Help/FAQ Section */
        .help-search-container { position: relative; margin-bottom: 24px; }
        .help-search-container input { width: 100%; padding: 14px 20px 14px 48px; border: 1px solid var(--border); border-radius: 12px; background: var(--bg-primary); color: var(--text-primary); font-size: 1rem; }
        .help-search-container input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
        .help-search-container input::placeholder { color: var(--text-muted); }
        .help-search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-muted); pointer-events: none; }
        .help-search-icon svg { width: 20px; height: 20px; }
        
        /* Share Lead Popup - Modal Style */
        .btn-share-lead { background: rgba(59,130,246,0.15); border: 1px solid rgba(59,130,246,0.4); color: var(--accent); width: 24px; height: 24px; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; vertical-align: middle; }
        .btn-share-lead:hover { border-color: var(--accent); color: white; background: var(--accent); transform: scale(1.1); }
        .btn-shared-indicator { background: none; border: none; color: var(--text-muted); cursor: pointer; opacity: 0.7; transition: all 0.2s; font-size: 14px; vertical-align: middle; padding: 2px 4px; border-radius: 4px; }
        .btn-shared-indicator:hover { opacity: 1; background: rgba(255,255,255,0.1); }
        .col-sharing { text-align: center; }
        .col-sharing button { display: block; margin: 0 auto; }
        .share-popup-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1999; display: none; }
        .share-popup-overlay.active { display: block; }
        .share-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 16px; padding: 24px; min-width: 320px; max-width: 380px; box-shadow: 0 16px 48px rgba(0,0,0,0.5); z-index: 2000; display: none; }
        .share-popup.active { display: block; }
        .share-popup-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .share-popup-header h4 { font-size: 1.125rem; font-weight: 600; }
        .share-popup-close { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.5rem; padding: 0; line-height: 1; }
        .share-popup-close:hover { color: var(--text-primary); }
        .share-popup-agents { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; max-height: 280px; overflow-y: auto; }
        .share-agent-option { display: flex; align-items: center; gap: 10px; padding: 12px 14px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; transition: all 0.2s; }
        .share-agent-option:hover { border-color: var(--accent); background: rgba(59,130,246,0.05); }
        .share-agent-option.selected { border-color: var(--accent); background: rgba(59,130,246,0.1); }
        .share-agent-option input { display: none; }
        .share-agent-radio { width: 18px; height: 18px; border: 2px solid var(--border); border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
        .share-agent-option.selected .share-agent-radio { border-color: var(--accent); }
        .share-agent-option.selected .share-agent-radio::after { content: ''; width: 10px; height: 10px; background: var(--accent); border-radius: 50%; }
        .share-agent-name { font-weight: 500; font-size: 0.9375rem; }
        .share-popup-actions { display: flex; gap: 10px; }
        .share-popup-actions button { flex: 1; padding: 12px; border-radius: 10px; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .btn-share-confirm { background: var(--accent); border: none; color: white; }
        .btn-share-confirm:hover { opacity: 0.9; }
        .btn-share-confirm:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-share-cancel { background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); }
        .btn-share-cancel:hover { background: var(--bg-primary); }
        
        /* Share Info Popup */
        .share-info-content { padding: 4px 0; }
        .share-info-label { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .share-info-name { font-size: 0.9375rem; font-weight: 500; color: var(--text-primary); padding: 8px 12px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 12px; }
        .btn-stop-sharing { width: 100%; padding: 12px; background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.3); color: #EF4444; border-radius: 10px; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .btn-stop-sharing:hover { background: #EF4444; color: white; }
        
        /* Modal Share Info Row */
        .modal-share-info { display: none; align-items: center; gap: 10px; padding: 10px 16px; background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.2); border-radius: 8px; font-size: 0.875rem; cursor: pointer; transition: all 0.2s; margin-top: 12px; }
        .modal-share-info:hover { background: rgba(59,130,246,0.15); }
        .modal-share-text { color: var(--text-secondary); flex: 1; display: flex; align-items: center; gap: 8px; }
        .modal-share-text strong { color: var(--text-primary); font-weight: 500; }
        .modal-share-edit { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px 8px; font-size: 0.875rem; border-radius: 4px; transition: all 0.2s; }
        .modal-share-info.not-shared { background: rgba(59,130,246,0.05); border-style: dashed; }
        .modal-share-info.not-shared .modal-share-text { color: var(--text-muted); }
        .modal-share-edit:hover { background: rgba(255,255,255,0.1); color: var(--text-primary); }
        .modal-share-info.shared-with-me { background: rgba(139,92,246,0.1); border-color: rgba(139,92,246,0.2); }
        
        /* Single Lead Import Form */
        .import-tabs { display: flex; gap: 4px; margin-bottom: 24px; background: var(--bg-tertiary); padding: 4px; border-radius: 10px; }
        .import-tab { flex: 1; padding: 12px 16px; background: none; border: none; color: var(--text-secondary); cursor: pointer; border-radius: 8px; font-size: 0.875rem; font-weight: 500; transition: all 0.2s; }
        .import-tab:hover { color: var(--text-primary); }
        .import-tab.active { background: var(--bg-secondary); color: var(--text-primary); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .import-panel { display: none; }
        .import-panel.active { display: block; }
        .single-lead-form { max-width: 500px; }
        .single-lead-form .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .single-lead-form .form-group { margin-bottom: 16px; }
        .single-lead-form label { display: block; margin-bottom: 6px; font-size: 0.875rem; font-weight: 500; }
        .single-lead-form label .required { color: #EF4444; margin-left: 2px; }
        .single-lead-form label .optional { color: var(--text-muted); font-weight: 400; font-size: 0.75rem; }
        .single-lead-form input, .single-lead-form select { width: 100%; padding: 12px 14px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary); font-size: 0.9375rem; }
        .single-lead-form input:focus, .single-lead-form select:focus { outline: none; border-color: var(--accent); }
        .single-lead-form input.error { border-color: #EF4444; }
        .single-lead-form .form-hint { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }
        .single-lead-form .form-error-msg { font-size: 0.75rem; color: #EF4444; margin-top: 4px; display: none; }
        .single-lead-form .form-error-msg.visible { display: block; }
        @media (max-width: 500px) { .single-lead-form .form-row { grid-template-columns: 1fr; } }
        .help-categories { display: flex; flex-direction: column; gap: 16px; }
        .help-category { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .help-category-header { display: flex; align-items: center; gap: 12px; padding: 16px 20px; cursor: pointer; transition: background 0.2s; }
        .help-category-header:hover { background: var(--bg-tertiary); }
        .help-category-icon { font-size: 1.5rem; }
        .help-category-title { flex: 1; font-weight: 600; font-size: 1rem; }
        .help-category-count { background: var(--bg-tertiary); color: var(--text-secondary); padding: 2px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; }
        .help-category-arrow { color: var(--text-muted); transition: transform 0.2s; }
        .help-category-arrow svg { width: 20px; height: 20px; }
        .help-category.open .help-category-arrow { transform: rotate(180deg); }
        .help-category-content { display: none; border-top: 1px solid var(--border); }
        .help-category.open .help-category-content { display: block; }
        .help-item { border-bottom: 1px solid var(--border); }
        .help-item:last-child { border-bottom: none; }
        .help-item-header { display: flex; align-items: center; gap: 12px; padding: 14px 20px; cursor: pointer; transition: background 0.2s; }
        .help-item-header:hover { background: rgba(59,130,246,0.05); }
        .help-item-question { flex: 1; font-weight: 500; font-size: 0.9375rem; color: var(--text-primary); }
        .help-item-toggle { color: var(--accent); font-size: 1.25rem; font-weight: 300; transition: transform 0.2s; }
        .help-item.open .help-item-toggle { transform: rotate(45deg); }
        .help-item-answer { display: none; padding: 0 20px 16px 20px; color: var(--text-secondary); font-size: 0.9375rem; line-height: 1.7; }
        .help-item.open .help-item-answer { display: block; }
        .help-item-answer p { margin-bottom: 12px; }
        .help-item-answer p:last-child { margin-bottom: 0; }
        .help-item-answer ul { margin: 8px 0 12px 20px; }
        .help-item-answer li { margin-bottom: 6px; }
        .help-item-answer code { background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px; font-size: 0.875rem; color: var(--accent); }
        .help-item-answer .help-tip { background: rgba(59,130,246,0.1); border-left: 3px solid var(--accent); padding: 12px 16px; border-radius: 0 8px 8px 0; margin: 12px 0; font-size: 0.875rem; }
        .help-item-answer .help-warning { background: rgba(245,158,11,0.1); border-left: 3px solid #F59E0B; padding: 12px 16px; border-radius: 0 8px 8px 0; margin: 12px 0; font-size: 0.875rem; }
        .help-no-results { text-align: center; padding: 48px 24px; color: var(--text-muted); }
        .help-no-results svg { width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.5; }
        .help-highlight { background: rgba(245,158,11,0.3); padding: 0 2px; border-radius: 2px; }
        .help-quick-links { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 32px; }
        .help-quick-link { display: flex; align-items: center; gap: 10px; padding: 14px 16px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; transition: all 0.2s; }
        .help-quick-link:hover { border-color: var(--accent); background: rgba(59,130,246,0.05); transform: translateY(-2px); }
        .help-quick-link-icon { font-size: 1.25rem; }
        .help-quick-link-text { font-size: 0.875rem; font-weight: 500; }
        
        .col-hidden { display: none !important; }
    </style>
</head>
<body>
<nav>
    <div class="container-lg">
        <a href="/" class="logo">
            <img src="/assets/logo_black.png" alt="Prio AI" class="logo-img logo-light">
            <img src="/assets/logo_white.png" alt="Prio AI" class="logo-img logo-dark">
        </a>
        <ul class="nav-links">
            <li><a href="/#solution">Solution</a></li>
            <li><a href="/#how-it-works">How It Works</a></li>
            <li><a href="/#pricing">Pricing</a></li>
            <li><a href="/#faq">FAQ</a></li>
        </ul>
        <div class="nav-right">
            <button class="theme-toggle" id="themeToggle">
                <svg class="sun-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                <svg class="moon-icon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </button>
            <div class="user-menu">
                <button class="user-menu-btn" id="userMenuBtn">
                    <span class="user-avatar" id="userAvatar">U</span>
                    <span id="userDisplayName">Account</span>
                </button>
                <div class="user-dropdown" id="userDropdown">
                    <a href="/dashboard/">Dashboard</a>
                    <a href="#" id="settingsLink">Profile</a>
                    <a href="#" id="feedbackLink"> Feedback</a>
                    <div class="divider"></div>
                    <button class="logout" id="logoutBtn">Log Out</button>
                </div>
            </div>
            <button class="mobile-menu-btn" id="mobileMenuBtn"><span></span><span></span><span></span></button>
        </div>
    </div>
</nav>

<div class="mobile-menu" id="mobileMenu">
    <button class="mobile-menu-close" id="mobileMenuClose">&times;</button>
    <a href="/#solution">Solution</a>
    <a href="/#how-it-works">How It Works</a>
    <a href="/#pricing">Pricing</a>
    <a href="/#faq">FAQ</a>
    <a href="/dashboard/" class="btn btn-primary">Dashboard</a>
    <button class="btn btn-secondary" id="mobileLogoutBtn">Log Out</button>
</div>

<!-- Share Lead Popup -->
<!-- Share Popup Overlay -->
<div class="share-popup-overlay" id="sharePopupOverlay"></div>

<div class="share-popup" id="shareLeadPopup">
    <div class="share-popup-header">
        <h4>Share Prospect With</h4>
        <button class="share-popup-close" id="sharePopupClose">&times;</button>
    </div>
    <div class="share-popup-agents" id="shareAgentsList">
        <!-- Agents will be populated dynamically -->
    </div>
    <div class="share-popup-actions">
        <button class="btn-share-cancel" id="sharePopupCancel">Cancel</button>
        <button class="btn-share-confirm" id="sharePopupConfirm" disabled>Share</button>
    </div>
</div>

<!-- Share Info Popup (for viewing shared prospect details) -->
<div class="share-popup" id="shareInfoPopup">
    <div class="share-popup-header">
        <h4 id="shareInfoTitle">Shared Prospect</h4>
        <button class="share-popup-close" id="shareInfoClose">&times;</button>
    </div>
    <div class="share-info-content" id="shareInfoContent">
        <!-- Content populated dynamically -->
    </div>
</div>

<div class="toast-notification" id="toastNotification">
    <span class="toast-icon"></span>
    <span class="toast-message" id="toastMessage"></span>
    <button class="toast-close" id="toastClose">&times;</button>
</div>

<div class="dashboard-loading" id="dashboardLoading">
    <div class="spinner"></div>
    <p style="color:var(--text-secondary)">Loading your dashboard...</p>
</div>

<div class="dashboard dashboard-content" id="dashboardContent">
    <div class="container">
        <div class="dashboard-header">
            <div class="dashboard-header-top">
                <h1 style="display:flex;align-items:center;gap:12px;">
                    <span><span id="welcomeMessage">Welcome back</span>, <span id="dashboardUserName">Agent</span>!</span>
                    <div class="notification-bell" id="notificationBell">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                        <span class="notification-badge" id="notificationBadge"></span>
                        <div class="notification-dropdown" id="notificationDropdown">
                            <div class="notification-dropdown-header">
                                <h4>Notifications</h4>
                                <button id="markAllReadBtn">Mark all read</button>
                            </div>
                            <div id="notificationList">
                                <div class="notification-empty">No notifications yet</div>
                            </div>
                        </div>
                    </div>
                </h1>
                <div class="dashboard-header-info">
                    <button class="analytics-btn" id="goToAnalyticsBtn">
                        <span class="btn-label">Total Leads</span>
                        <span class="btn-value">
                            <span id="headerTotalLeads">0</span>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                        </span>
                    </button>
                    <div class="calls-usage" id="callsUsage" style="display:none;">
                        <span class="usage-label">Monthly Calls</span>
                        <span class="usage-text"><span id="callsUsed">0</span> / <span id="callsLimit">1000</span></span>
                        <div class="usage-bar">
                            <div class="usage-bar-fill" id="callsBarFill" style="width:0%"></div>
                        </div>
                    </div>
                    <div class="user-phone" id="userPhoneDisplay" style="display:none;">
                        <span class="phone-label">AI Phone #</span>
                        <span class="phone-number">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                            <span id="retellPhoneNumber">-</span>
                        </span>
                    </div>
                </div>
            </div>
            <p>Here's your lead activity overview</p>
        </div>

        <!-- Admin Panel (only visible for info@prioai.ca) -->
        <div class="admin-panel" id="adminPanel" style="display:none;">
            <div class="admin-panel-header">
                <span class="admin-badge"> ADMIN</span>
                <select id="adminClientSelect">
                    <option value="">Select a client to view...</option>
                </select>
                <button class="btn btn-primary btn-sm" id="adminViewBtn" style="padding:10px 16px;">View Dashboard</button>
            </div>
            <div class="admin-stats" id="adminStats" style="display:none;">
                <div class="admin-stat">
                    <div class="admin-stat-value" id="adminTotalLeads">0</div>
                    <div class="admin-stat-label">Total Leads</div>
                </div>
                <div class="admin-stat">
                    <div class="admin-stat-value" id="adminTotalCalls">0</div>
                    <div class="admin-stat-label">Total Calls</div>
                </div>
                <div class="admin-stat">
                    <div class="admin-stat-value" id="adminBookedLeads">0</div>
                    <div class="admin-stat-label">Booked</div>
                </div>
                <div class="admin-stat">
                    <div class="admin-stat-value" id="adminClientStatus">-</div>
                    <div class="admin-stat-label">Status</div>
                </div>
            </div>
        </div>

        <div class="dashboard-tabs">
            <button class="dashboard-tab prio-tab active" data-tab="prio">
                <img src="/assets/icon_white.png" alt="Prio" style="height:14px;width:auto;vertical-align:middle;margin-right:4px;">PRIO
            </button>
            <button class="dashboard-tab" data-tab="leads"> Prospects</button>
            <button class="dashboard-tab" data-tab="pipeline"> AI Pipeline</button>
            <button class="dashboard-tab" data-tab="search"> Search</button>
            <button class="dashboard-tab" data-tab="analytics"> Analytics</button>
            <button class="dashboard-tab" data-tab="upload"> Import Leads</button>
            <div class="tab-spacer"></div>
            <button class="dashboard-tab" data-tab="profile"> Profile</button>
            <button class="dashboard-tab" data-tab="feedback"> Feedback</button>
            <button class="dashboard-tab" data-tab="help"> Help</button>
        </div>

        <!-- Tab: Leads -->
        <div class="tab-panel" id="tab-leads">
            <div class="dashboard-section">
                <div class="dashboard-section-header">
                    <h2>Your Prospects <span id="leadsCount" class="leads-count-badge"><span class="badge-spinner"></span></span></h2>
                    <div class="dashboard-filters">
                        <input type="search" id="searchLeads" placeholder="Search by name or phone...">
                        <div class="column-toggle-wrapper">
                            <button class="column-toggle-btn" id="columnToggleBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3h7a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-7m0-18H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h7m0-18v18"></path></svg>
                                Columns
                            </button>
                            <div class="column-dropdown" id="columnDropdown"></div>
                        </div>
                        <select id="filterStatus">
                            <option value="">All Statuses</option>
                            <option value="Booked">Booked</option>
                            <option value="Callback">Callback</option>
                        </select>
                        <select id="filterTimeframe">
                            <option value="0">Today</option>
                            <option value="7">Last 7 days</option>
                            <option value="30">Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="" selected>All time</option>
                        </select>
                        <select id="filterShared">
                            <option value="" selected>All Prospects</option>
                            <option value="owned">My Prospects</option>
                            <option value="shared_by_me">Shared By You</option>
                            <option value="not_shared">Not Shared</option>
                            <option value="shared_with_me">Shared With Me</option>
                        </select>
                    </div>
                </div>
                
                <div class="leads-table-wrapper" id="leadsTableWrapper">
                    <table class="leads-table">
                        <thead>
                            <tr>
                                <th class="col-firstName sortable-header" data-sort="firstName">First Name <span class="sort-icon"></span></th>
                                <th class="col-lastName col-hidden">Last Name</th>
                                <th class="col-phone">Phone</th>
                                <th class="col-status sortable-header" data-sort="status">Status <span class="sort-icon"></span></th>
                                <th class="col-lastCalled sortable-header" data-sort="lastCalled">Last Called <span class="sort-icon"></span></th>
                                <th class="col-bookedTime sortable-header" data-sort="bookedTime">Booked / Callback Time <span class="sort-icon"></span></th>
                                <th class="col-summary">Summary</th>
                                <th class="col-notes col-hidden">Your Notes</th>
                                <th class="col-sharing">Sharing</th>
                            </tr>
                        </thead>
                        <tbody id="leadsTableBody">
                            <tr id="leadsLoadingRow" style="display:none;">
                                <td colspan="9" style="text-align:center;padding:40px;">
                                    <div class="spinner" style="margin:0 auto 12px;"></div>
                                    <span style="color:var(--text-muted);font-size:0.875rem;">Loading prospects...</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="empty-state" id="emptyState" style="display:none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:64px;height:64px;margin-bottom:16px;opacity:0.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    <h3>No leads found</h3>
                    <p>Try adjusting your filters or upload a lead list to get started.</p>
                </div>
            </div>
        </div>

        <!-- Tab: PRIO -->
        <div class="tab-panel active" id="tab-prio">
            <div class="dashboard-section">
                <div class="dashboard-section-header">
                    <h2><img src="/assets/icon_white.png" alt="Prio" style="height:20px;width:auto;vertical-align:middle;margin-right:8px;">Your Prio Prospects <span id="prioCount" class="leads-count-badge"><span class="badge-spinner"></span></span></h2>
                    <div class="dashboard-filters">
                        <input type="search" id="searchPrio" placeholder="Search priority leads...">
                        <select id="filterPrioOwnership">
                            <option value="" selected>All Prospects</option>
                            <option value="owned">My Prospects</option>
                            <option value="shared_by_me">Shared By You</option>
                            <option value="not_shared">Not Shared</option>
                            <option value="shared_with_me">Shared With Me</option>
                        </select>
                        <select id="filterPrioTimeframe">
                            <option value="0">Today</option>
                            <option value="7">Last 7 days</option>
                            <option value="30">Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="" selected>All time</option>
                        </select>
                    </div>
                </div>
                
                <div class="leads-table-wrapper" id="prioTableWrapper">
                    <table class="leads-table prio-table">
                        <thead>
                            <tr>
                                <th>First Name</th>
                                <th>Last Name</th>
                                <th>Phone</th>
                                <th>Last Called</th>
                                <th>Booked / Callback Time</th>
                                <th>Summary</th>
                                <th>Your Notes</th>
                                <th class="col-sharing">Sharing</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="prioTableBody">
                            <tr id="prioLoadingRow" style="display:none;">
                                <td colspan="9" style="text-align:center;padding:40px;">
                                    <div class="spinner" style="margin:0 auto 12px;"></div>
                                    <span style="color:var(--text-muted);font-size:0.875rem;">Loading prio prospects...</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="empty-state" id="prioEmpty" style="display:none;">
                    <div style="font-size:3rem;margin-bottom:16px;"></div>
                    <h3>No Prio Prospects Yet</h3>
                    <p style="color:var(--text-secondary);">Click "PRIO LEAD" on any lead to mark it as a priority opportunity.</p>
                </div>
            </div>
        </div>

        <!-- Tab: AI Pipeline -->
        <div class="tab-panel" id="tab-pipeline">
            <div class="dashboard-section">
                <div class="dashboard-section-header">
                    <h2> AI Pipeline <span id="pipelineCount" class="leads-count-badge"></span></h2>
                    <div class="dashboard-filters">
                        <input type="search" id="searchPipeline" placeholder="Search by name...">
                        <select id="filterPipelineStatus">
                            <option value="">All Statuses</option>
                            <option value="Timeline">Timeline</option>
                            <option value="Follow Up">Follow Up</option>
                        </select>
                        <select id="filterPipelineTimeframe">
                            <option value="0">Today</option>
                            <option value="7">Last 7 days</option>
                            <option value="30">Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="" selected>All time</option>
                        </select>
                    </div>
                </div>
                <p style="color:var(--text-secondary);font-size:0.9375rem;margin-bottom:20px;">These leads are interested but the AI is handling follow-ups. Click any row to view details or take over.</p>
                
                <div style="overflow-x:auto;">
                    <table class="pipeline-table leads-table">
                        <thead>
                            <tr>
                                <th class="sortable-header" data-sort-pipeline="name">Name <span class="sort-icon"></span></th>
                                <th>Phone</th>
                                <th class="sortable-header" data-sort-pipeline="status">Status <span class="sort-icon"></span></th>
                                <th>Summary</th>
                                <th class="sortable-header" data-sort-pipeline="lastCalled">Last Called <span class="sort-icon"></span></th>
                                <th class="sortable-header" data-sort-pipeline="nextCall">Next AI Call <span class="sort-icon"></span></th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="pipelineTableBody"></tbody>
                    </table>
                </div>
                <div id="pipelineEmpty" style="display:none;text-align:center;padding:40px;color:var(--text-secondary);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:48px;height:48px;margin-bottom:12px;opacity:0.5"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                    <p>No leads in the AI pipeline matching your filters</p>
                </div>
            </div>
        </div>

        <!-- Tab: Search Lead -->
        <div class="tab-panel" id="tab-search">
            <div class="search-lead-container">
                <h2> Search Lead</h2>
                <p style="color:var(--text-secondary);margin-bottom:24px;">Search by name or last 4 digits of phone number.</p>
                
                <div class="search-lead-box">
                    <div class="search-input-wrapper" style="display:flex;gap:12px;max-width:500px;">
                        <input type="text" id="searchLeadPhone" placeholder="Enter name or last 4 digits of phone..." style="flex:1;padding:12px 16px;border:1px solid var(--border);border-radius:8px;background:var(--bg-secondary);color:var(--text-primary);font-size:1rem;">
                        <button class="btn btn-primary" id="searchLeadBtn" style="padding:12px 24px;">Search</button>
                    </div>
                    <p class="form-error" id="searchLeadError" style="margin-top:8px;"></p>
                </div>

                <!-- Multiple results list -->
                <div id="searchLeadMultiple" style="display:none;margin-top:24px;">
                    <h4 style="margin-bottom:12px;color:var(--text-secondary);">Multiple leads found - click to view:</h4>
                    <div id="searchLeadList" style="display:flex;flex-direction:column;gap:8px;"></div>
                </div>

                <div id="searchLeadResults" style="display:none;margin-top:32px;">
                    <div class="search-lead-card" style="background:var(--bg-secondary);border:1px solid var(--border);border-radius:12px;padding:24px;">
                        <div class="search-lead-header" style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;flex-wrap:wrap;gap:16px;">
                            <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap;">
                                <div>
                                    <h3 id="searchLeadName" style="font-size:1.5rem;margin-bottom:4px;"></h3>
                                    <p id="searchLeadPhone2" style="color:var(--text-secondary);font-size:0.875rem;"></p>
                                </div>
                                <button class="btn-takeover" id="searchLeadTakeOver" style="display:none;">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg>
                                    Take Over
                                </button>
                            </div>
                            <span id="searchLeadStatus" class="status-badge"></span>
                        </div>

                        <div class="search-lead-info" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:16px;margin-bottom:24px;padding:16px;background:var(--bg-primary);border-radius:8px;">
                            <div><span style="color:var(--text-muted);font-size:0.75rem;display:block;">Email</span><span id="searchLeadEmail" style="font-weight:500;"></span></div>
                            <div><span style="color:var(--text-muted);font-size:0.75rem;display:block;">Total Calls</span><span id="searchLeadCalls" style="font-weight:500;"></span></div>
                            <div><span style="color:var(--text-muted);font-size:0.75rem;display:block;">Last Call</span><span id="searchLeadLastCall" style="font-weight:500;"></span></div>
                            <div id="searchLeadNextCallContainer"><span style="color:var(--text-muted);font-size:0.75rem;display:block;">Next Call</span><span id="searchLeadNextCall" style="font-weight:500;"></span></div>
                            <div><span style="color:var(--text-muted);font-size:0.75rem;display:block;">Booked / Callback Time</span><span id="searchLeadBookedTime" style="font-weight:500;"></span></div>
                        </div>

                        <div class="search-lead-section" style="margin-bottom:24px;">
                            <h4 style="font-size:0.875rem;color:var(--text-muted);margin-bottom:8px;"> Client Notes</h4>
                            <textarea id="searchLeadNotesInput" style="width:100%;min-height:100px;padding:16px;border-radius:8px;background:var(--bg-primary);border:1px solid var(--border);color:var(--text-primary);font-family:inherit;font-size:0.9375rem;resize:vertical;" placeholder="Add notes about this lead..."></textarea>
                            <div style="display:flex;justify-content:flex-end;margin-top:12px;">
                                <button class="btn btn-primary" id="searchLeadSaveNotes" style="padding:8px 20px;">Save Changes</button>
                            </div>
                            <p id="searchLeadSaveStatus" style="margin-top:8px;font-size:0.875rem;"></p>
                        </div>

                        <div class="search-lead-section" id="searchLeadOutcomeSection" style="margin-bottom:24px;display:none;">
                            <h4 style="font-size:0.875rem;color:var(--text-muted);margin-bottom:8px;"> Last Outcome</h4>
                            <div id="searchLeadOutcome" style="background:var(--bg-primary);padding:16px;border-radius:8px;"></div>
                        </div>

                        <div class="search-lead-section" style="margin-bottom:24px;">
                            <h4 style="font-size:0.875rem;color:var(--text-muted);margin-bottom:8px;"> AI Summary</h4>
                            <div id="searchLeadSummary" style="background:var(--bg-primary);padding:16px;border-radius:8px;white-space:pre-wrap;"></div>
                        </div>

                        <div class="search-lead-section" id="searchLeadTranscriptSection" style="margin-bottom:24px;">
                            <h4 style="font-size:0.875rem;color:var(--text-muted);margin-bottom:8px;"> Latest Transcript</h4>
                            <div id="searchLeadTranscript" style="background:var(--bg-primary);padding:16px;border-radius:8px;white-space:pre-wrap;max-height:400px;overflow-y:auto;font-size:0.875rem;resize:vertical;"></div>
                        </div>

                        <div class="search-lead-section">
                            <h4 style="font-size:0.875rem;color:var(--text-muted);margin-bottom:12px;"> Call History</h4>
                            <div id="searchLeadHistory" style="display:flex;flex-direction:column;gap:12px;"></div>
                        </div>
                    </div>
                </div>

                <div id="searchLeadEmpty" style="display:none;text-align:center;padding:40px;color:var(--text-secondary);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:48px;height:48px;margin-bottom:12px;opacity:0.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                    <p id="searchLeadEmptyText">No lead found with that phone number</p>
                </div>
            </div>
        </div>

        <!-- Tab: Analytics -->
        <div class="tab-panel" id="tab-analytics">
            <!-- Header with tabs -->
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:16px;">
                <h2 style="margin:0;font-size:1.5rem;"> Performance Summary</h2>
                <div class="analytics-period-tabs">
                    <button class="analytics-period-tab active" data-period="daily">Daily</button>
                    <button class="analytics-period-tab" data-period="weekly">Weekly</button>
                    <button class="analytics-period-tab" data-period="monthly">Monthly</button>
                    <button class="analytics-period-tab" data-period="all">All Time</button>
                </div>
            </div>
            
            <!-- Date Picker Row - Modern Design -->
            <div id="analyticsPickerRow" style="margin-bottom:24px;display:flex;align-items:center;gap:12px;position:relative;">
                <div id="analyticsDateDisplay" style="background:linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));border:1px solid var(--border);border-radius:12px;padding:14px 20px;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:10px;position:relative;" onclick="toggleAnalyticsCalendar()">
                    <span style="font-size:1.25rem;"></span>
                    <span id="analyticsDateText" style="font-size:0.9375rem;font-weight:500;color:var(--text-primary);"></span>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;color:var(--text-muted);"><path d="m6 9 6 6 6-6"/></svg>
                </div>
                <input type="date" id="analyticsDatePicker" style="display:none;">
                <select id="analyticsWeekPicker" style="background:linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));border:1px solid var(--border);border-radius:12px;padding:14px 20px;color:var(--text-primary);font-size:0.9375rem;cursor:pointer;display:none;transition:all 0.2s;"></select>
                <select id="analyticsMonthPicker" style="background:linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));border:1px solid var(--border);border-radius:12px;padding:14px 20px;color:var(--text-primary);font-size:0.9375rem;cursor:pointer;display:none;transition:all 0.2s;"></select>
                <span id="analyticsAllTimeLabel" style="background:linear-gradient(135deg, rgba(59,130,246,0.1), rgba(59,130,246,0.05));border:1px solid rgba(59,130,246,0.3);border-radius:12px;padding:14px 20px;color:var(--accent);font-size:0.9375rem;display:none;"> Dec 2025  Present</span>
            </div>
            
            <!-- Analytics Calendar Popup -->
            <div id="analyticsCalendarPopup" style="display:none;position:absolute;top:100%;left:0;z-index:100;background:var(--bg-primary);border:1px solid var(--border);border-radius:16px;padding:20px;box-shadow:0 8px 32px rgba(0,0,0,0.3);min-width:300px;margin-top:8px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                    <button type="button" id="analyticsCalPrev" style="background:var(--bg-tertiary);border:1px solid var(--border);border-radius:8px;padding:8px 12px;cursor:pointer;color:var(--text-primary);font-size:1.25rem;"></button>
                    <span id="analyticsCalMonthYear" style="font-weight:600;color:var(--text-primary);"></span>
                    <button type="button" id="analyticsCalNext" style="background:var(--bg-tertiary);border:1px solid var(--border);border-radius:8px;padding:8px 12px;cursor:pointer;color:var(--text-primary);font-size:1.25rem;"></button>
                </div>
                <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px;text-align:center;margin-bottom:8px;">
                    <span style="font-size:0.75rem;color:var(--text-muted);padding:8px;">Su</span>
                    <span style="font-size:0.75rem;color:var(--text-muted);padding:8px;">Mo</span>
                    <span style="font-size:0.75rem;color:var(--text-muted);padding:8px;">Tu</span>
                    <span style="font-size:0.75rem;color:var(--text-muted);padding:8px;">We</span>
                    <span style="font-size:0.75rem;color:var(--text-muted);padding:8px;">Th</span>
                    <span style="font-size:0.75rem;color:var(--text-muted);padding:8px;">Fr</span>
                    <span style="font-size:0.75rem;color:var(--text-muted);padding:8px;">Sa</span>
                </div>
                <div id="analyticsCalDays" style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px;"></div>
            </div>
            
            <!-- Key Metrics -->
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:32px;">
                <div style="background:linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));border-radius:12px;padding:24px;text-align:center;">
                    <div style="color:var(--accent);font-size:2.5rem;font-weight:700;" id="analyticsTotalCalls">0</div>
                    <div style="color:var(--text-secondary);font-size:0.875rem;text-transform:uppercase;">Calls</div>
                </div>
                <div style="background:linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));border-radius:12px;padding:24px;text-align:center;">
                    <div style="color:#22c55e;font-size:2.5rem;font-weight:700;" id="analyticsQualifiedConvos">0</div>
                    <div style="color:var(--text-secondary);font-size:0.875rem;text-transform:uppercase;">Conversations</div>
                </div>
            </div>
            
            <!-- Active Pipeline - MOVED TO TOP -->
            <div style="margin-bottom:32px;">
                <h3 style="color:var(--text-secondary);font-size:0.75rem;font-weight:600;text-transform:uppercase;margin:0 0 16px 0;">Active Pipeline</h3>
                <div style="background:var(--bg-tertiary);border-radius:8px;padding:20px;text-align:center;">
                    <div style="color:var(--text-primary);font-size:2rem;font-weight:700;" id="analyticsActivePipeline">0</div>
                    <div style="color:var(--text-secondary);font-size:0.875rem;">Active Leads</div>
                </div>
            </div>
            
            <!-- Qualified Breakdown -->
            <div style="margin-bottom:32px;">
                <h3 style="color:var(--text-secondary);font-size:0.75rem;font-weight:600;text-transform:uppercase;margin:0 0 16px 0;">Qualified Breakdown</h3>
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;">
                    <div style="background:#14532d;border-radius:8px;padding:16px;text-align:center;">
                        <div style="color:#22c55e;font-size:1.5rem;font-weight:700;" id="analyticsBooked">0</div>
                        <div style="color:#22c55e;font-size:0.75rem;">Booked</div>
                    </div>
                    <div style="background:#172554;border-radius:8px;padding:16px;text-align:center;">
                        <div style="color:#3B82F6;font-size:1.5rem;font-weight:700;" id="analyticsInterested">0</div>
                        <div style="color:#3B82F6;font-size:0.75rem;">Interested</div>
                    </div>
                    <div style="background:#451a03;border-radius:8px;padding:16px;text-align:center;">
                        <div style="color:#f59e0b;font-size:1.5rem;font-weight:700;" id="analyticsTimeline">0</div>
                        <div style="color:#f59e0b;font-size:0.75rem;">Timeline</div>
                    </div>
                    <div style="background:var(--bg-tertiary);border-radius:8px;padding:16px;text-align:center;">
                        <div style="color:var(--text-secondary);font-size:1.5rem;font-weight:700;" id="analyticsNotInterested">0</div>
                        <div style="color:var(--text-secondary);font-size:0.75rem;">Not Interested</div>
                    </div>
                </div>
            </div>
            
            <!-- Other Outcomes -->
            <div style="margin-bottom:32px;" id="analyticsOtherOutcomes">
                <h3 style="color:var(--text-secondary);font-size:0.75rem;font-weight:600;text-transform:uppercase;margin:0 0 12px 0;">Other Outcomes</h3>
                <div id="analyticsOtherPills" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
            </div>
            
            <!-- Booked Appointments Table -->
            <div id="analyticsBookedSection" style="margin-bottom:32px;display:none;">
                <h3 style="color:#22c55e;font-size:1.25rem;font-weight:600;margin:0 0 8px 0;">Booked Appointments</h3>
                <p style="color:var(--text-secondary);font-size:0.875rem;margin:0 0 16px 0;">These leads have confirmed meetings scheduled.</p>
                <div style="overflow-x:auto;">
                    <table class="analytics-table booked-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Summary</th>
                                <th>Meeting</th>
                            </tr>
                        </thead>
                        <tbody id="analyticsBookedTable"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Interested Leads Table -->
            <div id="analyticsInterestedSection" style="margin-bottom:32px;display:none;">
                <h3 style="color:#3B82F6;font-size:1.25rem;font-weight:600;margin:0 0 8px 0;">Interested Leads</h3>
                <p style="color:var(--text-secondary);font-size:0.875rem;margin:0 0 16px 0;">You'll call these leads back within 90 days.</p>
                <div style="overflow-x:auto;">
                    <table class="analytics-table interested-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Summary</th>
                                <th>Callback</th>
                            </tr>
                        </thead>
                        <tbody id="analyticsInterestedTable"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Timeline Leads Table -->
            <div id="analyticsTimelineSection" style="margin-bottom:32px;display:none;">
                <h3 style="color:#f59e0b;font-size:1.25rem;font-weight:600;margin:0 0 8px 0;">Timeline Leads</h3>
                <p style="color:var(--text-secondary);font-size:0.875rem;margin:0 0 16px 0;">90+ days out. Prio AI will follow up to re-engage and book.</p>
                <div style="overflow-x:auto;">
                    <table class="analytics-table timeline-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Summary</th>
                                <th>Callback</th>
                            </tr>
                        </thead>
                        <tbody id="analyticsTimelineTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Import Leads -->
        <div class="tab-panel" id="tab-upload">
            <div class="dashboard-section">
                <h3 style="margin-bottom:8px;"> Import Leads</h3>
                <p style="color:var(--text-secondary);margin-bottom:20px;">Add new leads to your account. Choose to add a single lead or upload multiple leads at once.</p>
                
                <!-- Import Method Tabs -->
                <div class="import-tabs">
                    <button class="import-tab active" data-import="single"> Single Lead</button>
                    <button class="import-tab" data-import="bulk"> Bulk Upload</button>
                </div>
                
                <!-- Single Lead Form -->
                <div class="import-panel active" id="importSingle">
                    <div class="single-lead-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>First Name <span class="required">*</span></label>
                                <input type="text" id="singleLeadFirstName" placeholder="John" required>
                                <p class="form-error-msg" id="singleLeadFirstNameError">First name is required</p>
                            </div>
                            <div class="form-group">
                                <label>Last Name <span class="optional">(optional)</span></label>
                                <input type="text" id="singleLeadLastName" placeholder="Smith">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Phone Number <span class="required">*</span></label>
                            <input type="tel" id="singleLeadPhone" placeholder="(416) 555-1234">
                            <p class="form-hint">Canadian format: 10 digits (e.g., 416-555-1234 or +1 416 555 1234)</p>
                            <p class="form-error-msg" id="singleLeadPhoneError">Valid Canadian phone number required</p>
                        </div>
                        
                        <div class="form-group">
                            <label>Interest <span class="required">*</span></label>
                            <select id="singleLeadInterest" required>
                                <option value="">Select interest...</option>
                                <option value="Buy">Buying</option>
                                <option value="Sell">Selling</option>
                                <option value="Both">Both (Buying & Selling)</option>
                            </select>
                            <p class="form-error-msg" id="singleLeadInterestError">Please select an interest</p>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Email <span class="optional">(optional)</span></label>
                                <input type="email" id="singleLeadEmail" placeholder="john@example.com">
                            </div>
                            <div class="form-group">
                                <label>Max Call Attempts <span class="optional">(optional)</span></label>
                                <select id="singleLeadMaxAttempts">
                                    <option value="">Default (5)</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                </select>
                            </div>
                        </div>
                        
                        <p class="form-success" id="singleLeadSuccess" style="margin-bottom:12px;"></p>
                        <p class="form-error" id="singleLeadError" style="margin-bottom:12px;"></p>
                        
                        <button class="btn btn-primary" id="submitSingleLeadBtn" style="width:100%;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px;"><path d="M12 5v14M5 12h14"/></svg>
                            Add Lead
                        </button>
                    </div>
                </div>
                
                <!-- Bulk Upload -->
                <div class="import-panel" id="importBulk">
                    <div class="template-download" style="margin-bottom:24px;">
                        <div class="template-info">
                            <h4> Download Template First</h4>
                            <p>CSV file with columns: First Name, Last Name, Phone, Context (optional), Interest (optional)</p>
                        </div>
                        <button class="btn btn-secondary" id="downloadTemplateBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                            Download Template
                        </button>
                    </div>
                    
                    <div class="file-upload-zone" id="fileUploadZone">
                        <input type="file" id="leadFileInput" accept=".csv,.xlsx,.xls">
                        <div class="file-upload-icon"></div>
                        <p><strong>Click to upload</strong> or drag and drop</p>
                        <p class="supported">CSV, XLSX, or XLS (max 10MB)</p>
                    </div>
                    
                    <div id="uploadStatus"></div>
                </div>
            </div>
        </div>

        <!-- Tab: Profile (renamed from Settings) -->
        <div class="tab-panel" id="tab-profile">
            <!-- Profile Card -->
            <div class="profile-card">
                <div class="profile-card-header">
                    <div class="profile-avatar" id="profileAvatar">
                        <span id="profileInitial">U</span>
                    </div>
                    <div class="profile-header-info">
                        <h2 id="profileName">-</h2>
                        <p id="profileEmail">-</p>
                        <div class="profile-header-actions">
                            <input type="file" id="profilePicInput" accept="image/*">
                            <button class="profile-btn-sm" id="profileUploadBtn">Upload Photo</button>
                            <button class="profile-btn-sm danger" id="profileRemoveBtn" style="display:none;">Remove</button>
                        </div>
                    </div>
                </div>
                
                <div class="profile-info-grid">
                    <div class="profile-info-item">
                        <div class="label">Plan</div>
                        <div class="value" id="profilePlan">-</div>
                    </div>
                    <div class="profile-info-item">
                        <div class="label">Status</div>
                        <div class="value" id="profileStatus">-</div>
                    </div>
                </div>
            </div>
            
            <!-- Display Name -->
            <div class="profile-card">
                <div class="profile-section-title">Display Name</div>
                <form id="displayForm">
                    <div class="profile-form-row single">
                        <div class="profile-form-group">
                            <label for="settingsDisplayName">How should we greet you?</label>
                            <input type="text" id="settingsDisplayName" placeholder="e.g. Sahib">
                        </div>
                    </div>
                    <p class="form-success" id="displaySuccess"></p>
                    <p class="form-error" id="displayError"></p>
                    <button type="submit" class="btn btn-primary" id="saveDisplayBtn">Save</button>
                </form>
            </div>
            
            <!-- Calling Preferences -->
            <div class="profile-card">
                <div class="profile-section-title">Calling Preferences</div>
                <form id="settingsForm">
                    <div class="profile-form-row">
                        <div class="profile-form-group">
                            <label for="settingsPhone">Your Phone Number</label>
                            <input type="tel" id="settingsPhone" placeholder="+1 (555) 123-4567">
                        </div>
                        <div class="profile-form-group">
                            <label for="settingsCalendar">Calendar Email</label>
                            <input type="email" id="settingsCalendar" placeholder="calendar@gmail.com">
                        </div>
                    </div>
                    <div class="profile-form-row">
                        <div class="profile-form-group">
                            <label for="settingsStart">Available Start</label>
                            <select id="settingsStart">
                                <option value="8:00 AM">8:00 AM</option>
                                <option value="9:00 AM">9:00 AM</option>
                                <option value="10:00 AM">10:00 AM</option>
                                <option value="11:00 AM">11:00 AM</option>
                                <option value="12:00 PM">12:00 PM</option>
                            </select>
                        </div>
                        <div class="profile-form-group">
                            <label for="settingsEnd">Available End</label>
                            <select id="settingsEnd">
                                <option value="5:00 PM">5:00 PM</option>
                                <option value="6:00 PM">6:00 PM</option>
                                <option value="7:00 PM">7:00 PM</option>
                                <option value="8:00 PM">8:00 PM</option>
                                <option value="9:00 PM">9:00 PM</option>
                            </select>
                        </div>
                    </div>
                    <p class="form-success" id="settingsSuccess"></p>
                    <p class="form-error" id="settingsError"></p>
                    <button type="submit" class="btn btn-primary" id="saveSettingsBtn">Save Changes</button>
                </form>
            </div>
            
            <!-- Change Password -->
            <div class="profile-card">
                <div class="profile-section-title">Change Password</div>
                <form id="passwordForm">
                    <div class="profile-form-row">
                        <div class="profile-form-group">
                            <label for="newPassword">New Password</label>
                            <input type="password" id="newPassword" placeholder="Min. 8 characters" minlength="8">
                        </div>
                        <div class="profile-form-group">
                            <label for="confirmNewPassword">Confirm Password</label>
                            <input type="password" id="confirmNewPassword" placeholder="Confirm new password" minlength="8">
                        </div>
                    </div>
                    <p class="form-success" id="passwordSuccess"></p>
                    <p class="form-error" id="passwordError"></p>
                    <button type="submit" class="btn btn-secondary" id="changePasswordBtn">Update Password</button>
                </form>
            </div>
            
            <!-- Billing -->
            <div class="profile-card">
                <div class="profile-section-title"> Billing & Subscription</div>
                <p style="color:var(--text-secondary);font-size:0.875rem;margin-bottom:16px;">Manage your subscription, update payment methods, or view invoices.</p>
                <div style="display:flex;flex-wrap:wrap;gap:12px;">
                    <button class="btn btn-primary" id="manageBillingBtn">Manage Subscription</button>
                    <button class="btn btn-secondary" onclick="window.open('https://billing.stripe.com/p/login/test_xxx', '_blank')">View Invoices</button>
                </div>
                <p id="billingStatus" style="margin-top:12px;font-size:0.875rem;"></p>
            </div>
            
            <!-- Danger Zone -->
            <div class="profile-card profile-danger-zone">
                <div class="profile-section-title" style="color:#EF4444;">Danger Zone</div>
                <p style="color:var(--text-secondary);font-size:0.875rem;margin-bottom:12px;">Need to pause or cancel your subscription?</p>
                <button class="btn btn-secondary" onclick="window.location.href='mailto:info@prioai.ca?subject=Account Change Request'">Contact Support</button>
            </div>
        </div>

        <!-- Tab: Feedback -->
        <div class="tab-panel" id="tab-feedback">
            <div class="dashboard-section">
                <h3>Share Your Feedback</h3>
                <p style="color:var(--text-secondary);margin-bottom:24px;">We'd love to hear from you! Your feedback helps us improve Prio AI.</p>
                
                <form id="feedbackForm">
                    <label style="display:block;margin-bottom:12px;font-weight:500;">What type of feedback do you have?</label>
                    <div class="feedback-types">
                        <div class="feedback-type" data-type="suggestion"> Suggestion</div>
                        <div class="feedback-type" data-type="bug"> Bug Report</div>
                        <div class="feedback-type" data-type="praise"> Praise</div>
                        <div class="feedback-type" data-type="question"> Question</div>
                    </div>
                    <input type="hidden" id="feedbackType" value="">
                    
                    <div class="form-group">
                        <label for="feedbackMessage">Your Message</label>
                        <textarea id="feedbackMessage" rows="5" placeholder="Tell us what's on your mind..." required></textarea>
                    </div>
                    
                    <p class="form-success" id="feedbackSuccess"></p>
                    <p class="form-error" id="feedbackError"></p>
                    <button type="submit" class="btn btn-primary" id="submitFeedbackBtn">Send Feedback</button>
                </form>
            </div>
        </div>

        <!-- Tab: Help -->
        <div class="tab-panel" id="tab-help">
            <div class="dashboard-section">
                <h3 style="margin-bottom:8px;"> Help Center</h3>
                <p style="color:var(--text-secondary);margin-bottom:24px;">Everything you need to know about using Prio AI effectively.</p>
                
                <!-- Search Bar -->
                <div class="help-search-container">
                    <span class="help-search-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg></span>
                    <input type="text" id="helpSearchInput" placeholder="Search for help topics...">
                </div>
                
                <!-- Quick Links -->
                <div class="help-quick-links">
                    <div class="help-quick-link" data-topic="prio-leads">
                        <span class="help-quick-link-icon"></span>
                        <span class="help-quick-link-text">PRIO Leads</span>
                    </div>
                    <div class="help-quick-link" data-topic="notes">
                        <span class="help-quick-link-icon"></span>
                        <span class="help-quick-link-text">Adding Notes</span>
                    </div>
                    <div class="help-quick-link" data-topic="scheduling">
                        <span class="help-quick-link-icon"></span>
                        <span class="help-quick-link-text">Scheduling</span>
                    </div>
                    <div class="help-quick-link" data-topic="sharing">
                        <span class="help-quick-link-icon"></span>
                        <span class="help-quick-link-text">Sharing Leads</span>
                    </div>
                    <div class="help-quick-link" data-topic="ai-pipeline">
                        <span class="help-quick-link-icon"></span>
                        <span class="help-quick-link-text">AI Pipeline</span>
                    </div>
                </div>
                
                <!-- No Results Message -->
                <div class="help-no-results" id="helpNoResults" style="display:none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                    <p>No results found for "<span id="helpSearchTerm"></span>"</p>
                    <p style="font-size:0.875rem;">Try different keywords or browse categories below.</p>
                </div>
                
                <!-- FAQ Categories -->
                <div class="help-categories" id="helpCategories">
                    
                    <!-- Getting Started -->
                    <div class="help-category" data-category="getting-started">
                        <div class="help-category-header">
                            <span class="help-category-icon"></span>
                            <span class="help-category-title">Getting Started</span>
                            <span class="help-category-count">4</span>
                            <span class="help-category-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg></span>
                        </div>
                        <div class="help-category-content">
                            <div class="help-item" data-keywords="dashboard overview tabs navigation">
                                <div class="help-item-header">
                                    <span class="help-item-question">How do I navigate the dashboard?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>The dashboard has several tabs at the top to help you manage your leads:</p>
                                    <ul>
                                        <li><strong>PRIO</strong>  Your priority leads that need immediate attention</li>
                                        <li><strong>Prospects</strong>  All your leads in one searchable table</li>
                                        <li><strong>AI Pipeline</strong>  Leads currently being nurtured by the AI</li>
                                        <li><strong>Search</strong>  Find any lead by name or phone number</li>
                                        <li><strong>Analytics</strong>  View your performance metrics</li>
                                        <li><strong>Import Leads</strong>  Add single leads or bulk upload via CSV</li>
                                    </ul>
                                    <div class="help-tip"> Tip: The PRIO tab is your most important view  check it daily for hot leads!</div>
                                </div>
                            </div>
                            <div class="help-item" data-keywords="lead status booked callback interested timeline dnc">
                                <div class="help-item-header">
                                    <span class="help-item-question">What do the different lead statuses mean?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>Each lead has a status that tells you where they are in your pipeline:</p>
                                    <ul>
                                        <li><strong>Booked</strong>  Meeting scheduled with you</li>
                                        <li><strong>Callback</strong>  Lead wants YOU to call them personally</li>
                                        <li><strong>Interested</strong>  Showed interest but no meeting yet</li>
                                        <li><strong>Timeline</strong>  Has a future timeline (e.g., "looking in 6 months")</li>
                                        <li><strong>Follow Up</strong>  AI is continuing to nurture this lead</li>
                                        <li><strong>Not Interested</strong>  Declined or not a fit</li>
                                        <li><strong>DNC</strong>  Do Not Call - requested removal</li>
                                        <li><strong>Wrong Number</strong>  Invalid or disconnected number</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="help-item" data-keywords="calls usage limit monthly allowance">
                                <div class="help-item-header">
                                    <span class="help-item-question">How do I check my call usage?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>Your call usage is displayed at the top right of the dashboard. You'll see:</p>
                                    <ul>
                                        <li>Number of calls used this month</li>
                                        <li>Your monthly allowance</li>
                                        <li>A progress bar showing usage percentage</li>
                                    </ul>
                                    <div class="help-warning"> When you reach 80% of your limit, the bar turns orange to alert you.</div>
                                </div>
                            </div>
                            <div class="help-item" data-keywords="phone number caller id twilio">
                                <div class="help-item-header">
                                    <span class="help-item-question">What phone number does the AI call from?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>You have a dedicated phone number assigned to your account. This number is displayed at the top of your dashboard next to your name.</p>
                                    <p>When leads call back, they'll reach Sarah (the AI) who can help them or schedule a callback with you.</p>
                                    <div class="help-tip"> Tip: Save this number in your phone as "Prio AI" so you recognize incoming callbacks!</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PRIO Leads -->
                    <div class="help-category" data-category="prio-leads">
                        <div class="help-category-header">
                            <span class="help-category-icon"></span>
                            <span class="help-category-title">PRIO Leads</span>
                            <span class="help-category-count">4</span>
                            <span class="help-category-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg></span>
                        </div>
                        <div class="help-category-content">
                            <div class="help-item" data-keywords="prio priority star mark important">
                                <div class="help-item-header">
                                    <span class="help-item-question">What is a PRIO lead?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>PRIO (Priority) leads are your hottest opportunities that need immediate attention. They appear in a dedicated tab so you never miss them.</p>
                                    <p>The AI automatically marks leads as PRIO when they:</p>
                                    <ul>
                                        <li>Book a meeting with you</li>
                                        <li>Request a personal callback</li>
                                        <li>Show high buying intent</li>
                                    </ul>
                                    <p>You can also manually mark any lead as PRIO.</p>
                                </div>
                            </div>
                            <div class="help-item" data-keywords="prio mark add priority lead button">
                                <div class="help-item-header">
                                    <span class="help-item-question">How do I mark a lead as PRIO?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>To mark a lead as PRIO:</p>
                                    <ul>
                                        <li>Click on any lead to open the detail modal</li>
                                        <li>Click the yellow <strong>" PRIO LEAD"</strong> button at the top</li>
                                        <li>The lead will now appear in your PRIO tab</li>
                                    </ul>
                                    <div class="help-tip"> Tip: Mark leads as PRIO when you identify them as high-potential during manual follow-up!</div>
                                </div>
                            </div>
                            <div class="help-item" data-keywords="unprio remove priority lead">
                                <div class="help-item-header">
                                    <span class="help-item-question">How do I remove a lead from PRIO?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>To remove a lead from PRIO:</p>
                                    <ul>
                                        <li>Go to the PRIO tab</li>
                                        <li>Find the lead in the table</li>
                                        <li>Click the red <strong>"Unprio"</strong> button on the right</li>
                                    </ul>
                                    <p>The lead will be removed from PRIO but will still exist in your Prospects tab.</p>
                                </div>
                            </div>
                            <div class="help-item" data-keywords="shared lead chain icon link multiple agents">
                                <div class="help-item-header">
                                    <span class="help-item-question">What does the chain icon () next to a lead mean?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>The chain icon <strong></strong> indicates a <strong>shared lead</strong>.</p>
                                    <p>This means the lead was originally assigned to another agent but has been shared with you (or vice versa). This can happen when:</p>
                                    <ul>
                                        <li>A lead requests a different agent</li>
                                        <li>Team leads redistribute leads</li>
                                        <li>Collaboration is needed on a deal</li>
                                    </ul>
                                    <div class="help-tip"> Tip: Be aware that another agent may also be working this lead. Coordinate to avoid confusion!</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notes & Documentation -->
                    <div class="help-category" data-category="notes">
                        <div class="help-category-header">
                            <span class="help-category-icon"></span>
                            <span class="help-category-title">Notes & Documentation</span>
                            <span class="help-category-count">5</span>
                            <span class="help-category-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg></span>
                        </div>
                        <div class="help-category-content">
                            <div class="help-item" data-keywords="notes add save lead information">
                                <div class="help-item-header">
                                    <span class="help-item-question">How do I add notes to a lead?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>To add notes to a lead:</p>
                                    <ul>
                                        <li>Click on a lead to open the detail modal</li>
                                        <li>Scroll to the <strong>" Your Notes"</strong> section</li>
                                        <li>Type your note in the text box</li>
                                        <li>Click <strong>" Save"</strong> to save the note</li>
                                    </ul>
                                    <p>Your notes are timestamped and stored in order, so you can track your interaction history.</p>
                                </div>
                            </div>
                            <div class="help-item" data-keywords="polish ai notes clean rewrite improve">
                                <div class="help-item-header">
                                    <span class="help-item-question">What does "Polish" do?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>The <strong>" Polish"</strong> button uses AI to clean up your notes before saving.</p>
                                    <p>It will:</p>
                                    <ul>
                                        <li>Fix grammar and spelling</li>
                                        <li>Improve clarity and readability</li>
                                        <li>Format the note professionally</li>
                                        <li>Keep all the important details</li>
                                    </ul>
                                    <div class="help-tip"> Tip: Great for quickly jotting notes during a call  the AI will clean them up for you!</div>
                                </div>
                            </div>
                            <div class="help-item" data-keywords="voice input microphone speech text dictate">
                                <div class="help-item-header">
                                    <span class="help-item-question">Can I use voice input for notes?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>Yes! Click the <strong>microphone icon </strong> next to the notes input to use voice-to-text.</p>
                                    <ul>
                                        <li>Click once to start recording (icon turns red)</li>
                                        <li>Speak your notes naturally</li>
                                        <li>Click again to stop recording</li>
                                        <li>Your speech will be transcribed into the text box</li>
                                    </ul>
                                    <div class="help-warning"> Note: Voice input requires microphone permission in your browser.</div>
                                </div>
                            </div>
                            <div class="help-item" data-keywords="edit note update change modify">
                                <div class="help-item-header">
                                    <span class="help-item-question">How do I edit an existing note?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>To edit a previously saved note:</p>
                                    <ul>
                                        <li>Find the note in the "Your Notes" section</li>
                                        <li>Click the <strong> edit icon</strong> next to the note</li>
                                        <li>The note text will load into the input box</li>
                                        <li>Make your changes and click Save</li>
                                    </ul>
                                    <p>The note's timestamp will update to when you edited it.</p>
                                </div>
                            </div>
                            <div class="help-item" data-keywords="notes ai context future calls information">
                                <div class="help-item-header">
                                    <span class="help-item-question">Do my notes get used by the AI?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>Yes! When you send a lead back to the AI, your notes are provided as context.</p>
                                    <p>This means the AI will:</p>
                                    <ul>
                                        <li>Know about your previous conversations</li>
                                        <li>Reference important details you noted</li>
                                        <li>Provide a more personalized experience for the lead</li>
                                    </ul>
                                    <div class="help-tip"> Tip: Add detailed notes before sending back to AI  the more context, the better the AI conversation!</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Scheduling & Meetings -->
                    <div class="help-category" data-category="scheduling">
                        <div class="help-category-header">
                            <span class="help-category-icon"></span>
                            <span class="help-category-title">Scheduling & Meetings</span>
                            <span class="help-category-count">4</span>
                            <span class="help-category-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg></span>
                        </div>
                        <div class="help-category-content">
                            <div class="help-item" data-keywords="schedule meeting book appointment calendar">
                                <div class="help-item-header">
                                    <span class="help-item-question">How do I schedule a meeting with a lead?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>There are two ways to schedule a meeting:</p>
                                    <p><strong>From the table:</strong></p>
                                    <ul>
                                        <li>Click the blue <strong>"Schedule"</strong> button in the Booked/Callback Time column</li>
                                    </ul>
                                    <p><strong>From the lead modal:</strong></p>
                                    <ul>
                                        <li>Click on a lead to open the detail modal</li>
                                        <li>Click <strong>" Schedule Meeting"</strong> below the Booked Time field</li>
                                        <li>Select a date and time</li>
                                        <li>Click <strong>"Confirm Booking"</strong></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="help-item" data-keywords="change booked time edit reschedule meeting">
                                <div class="help-item-header">
                                    <span class="help-item-question">How do I change a booked time?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>To change an existing booked time:</p>
                                    <ul>
                                        <li>Click on the lead to open the detail modal</li>
                                        <li>Find the <strong>"Booked / Callback Time"</strong> field</li>
                                        <li>Click the <strong> edit icon</strong> next to the time</li>
                                        <li>Select a new date and time</li>
                                        <li>Click confirm to save</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="help-item" data-keywords="google calendar add event gcal">
                                <div class="help-item-header">
                                    <span class="help-item-question">Can I add meetings to Google Calendar?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>Yes! When a lead has a booked time, you'll see a <strong> calendar icon</strong> next to the time.</p>
                                    <p>Click it to open Google Calendar with the event pre-filled, including:</p>
                                    <ul>
                                        <li>Lead's name in the title</li>
                                        <li>Their phone number</li>
                                        <li>The scheduled date and time</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="help-item" data-keywords="log call attempt track manual calls">
                                <div class="help-item-header">
                                    <span class="help-item-question">How do I log my own call attempts?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>To track when you've manually called a lead:</p>
                                    <ul>
                                        <li>Open the lead detail modal</li>
                                        <li>Scroll to <strong>" Your Call Attempts"</strong> section</li>
                                        <li>Click <strong>"+ Log Call Attempt"</strong></li>
                                    </ul>
                                    <p>This logs the current date/time and updates the "Last Called" field.</p>
                                    <div class="help-tip"> Tip: Log your attempts to keep accurate records of all contact with leads!</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Pipeline -->
                    <div class="help-category" data-category="ai-pipeline">
                        <div class="help-category-header">
                            <span class="help-category-icon"></span>
                            <span class="help-category-title">AI Pipeline & Automation</span>
                            <span class="help-category-count">4</span>
                            <span class="help-category-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg></span>
                        </div>
                        <div class="help-category-content">
                            <div class="help-item" data-keywords="ai pipeline automation nurture follow up">
                                <div class="help-item-header">
                                    <span class="help-item-question">What is the AI Pipeline?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>The AI Pipeline shows leads that are being automatically nurtured by Sarah (the AI).</p>
                                    <p>These are leads with status <strong>"Timeline"</strong> or <strong>"Follow Up"</strong> who:</p>
                                    <ul>
                                        <li>Have shown interest but aren't ready to meet yet</li>
                                        <li>Have a future timeline (e.g., "buying in spring")</li>
                                        <li>Requested follow-up at a later date</li>
                                    </ul>
                                    <p>The AI will continue calling them at appropriate intervals until they convert or opt out.</p>
                                </div>
                            </div>
                            <div class="help-item" data-keywords="send back ai return automation follow up">
                                <div class="help-item-header">
                                    <span class="help-item-question">How do I send a lead back to the AI?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>If you've been working a lead manually and want the AI to take over:</p>
                                    <ul>
                                        <li>Open the lead detail modal</li>
                                        <li>Add notes about your conversations (important!)</li>
                                        <li>Click the purple <strong>" Send Back to AI"</strong> button</li>
                                        <li>Select when the AI should follow up</li>
                                        <li>Add any additional context</li>
                                        <li>Confirm the handoff</li>
                                    </ul>
                                    <div class="help-warning"> Important: Always add notes before sending back! The AI uses them for context.</div>
                                </div>
                            </div>
                            <div class="help-item" data-keywords="take over lead ai manual control">
                                <div class="help-item-header">
                                    <span class="help-item-question">How do I take over a lead from the AI?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>To take a lead out of the AI pipeline and handle it yourself:</p>
                                    <ul>
                                        <li>Go to the <strong>AI Pipeline</strong> tab</li>
                                        <li>Find the lead you want</li>
                                        <li>Click the <strong>"Take Over"</strong> button</li>
                                    </ul>
                                    <p>The lead will be removed from AI automation. You can also mark it as PRIO to add it to your priority list.</p>
                                </div>
                            </div>
                            <div class="help-item" data-keywords="next call date ai schedule when">
                                <div class="help-item-header">
                                    <span class="help-item-question">How does the AI decide when to call?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>The AI uses smart retry logic based on lead responses:</p>
                                    <ul>
                                        <li><strong>New leads:</strong> Called immediately when uploaded</li>
                                        <li><strong>No answer:</strong> Retry after 6 hours, then 24h, 48h, 72h</li>
                                        <li><strong>Timeline leads:</strong> Follow up closer to their stated timeframe</li>
                                        <li><strong>Interested leads:</strong> Follow up within your specified window</li>
                                    </ul>
                                    <p>The "Next AI Call" column shows when each lead will be called next.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Searching & Filtering -->
                    <div class="help-category" data-category="searching">
                        <div class="help-category-header">
                            <span class="help-category-icon"></span>
                            <span class="help-category-title">Searching & Filtering</span>
                            <span class="help-category-count">3</span>
                            <span class="help-category-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg></span>
                        </div>
                        <div class="help-category-content">
                            <div class="help-item" data-keywords="search find lead phone name lookup">
                                <div class="help-item-header">
                                    <span class="help-item-question">How do I search for a specific lead?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>You can search for leads in two ways:</p>
                                    <p><strong>Quick search (in tables):</strong></p>
                                    <ul>
                                        <li>Use the search box above any table</li>
                                        <li>Type a name or phone number</li>
                                        <li>Results filter in real-time</li>
                                    </ul>
                                    <p><strong>Dedicated Search tab:</strong></p>
                                    <ul>
                                        <li>Go to the <strong> Search</strong> tab</li>
                                        <li>Enter a name or last 4 digits of phone</li>
                                        <li>View detailed lead information</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="help-item" data-keywords="filter status date timeframe sort">
                                <div class="help-item-header">
                                    <span class="help-item-question">How do I filter leads by status or date?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>Most tables have filter dropdowns:</p>
                                    <ul>
                                        <li><strong>Status filter:</strong> Show only leads with a specific status</li>
                                        <li><strong>Timeframe filter:</strong> Show leads called within a certain period (today, 7 days, 30 days, etc.)</li>
                                    </ul>
                                    <p>You can also click column headers to sort the table by that column.</p>
                                </div>
                            </div>
                            <div class="help-item" data-keywords="columns show hide customize table">
                                <div class="help-item-header">
                                    <span class="help-item-question">Can I customize which columns are shown?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>Yes! In the Prospects tab:</p>
                                    <ul>
                                        <li>Click the <strong>"Columns"</strong> button above the table</li>
                                        <li>Check or uncheck columns to show/hide them</li>
                                        <li>Your preferences are saved automatically</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Import Leads -->
                    <div class="help-category" data-category="uploading">
                        <div class="help-category-header">
                            <span class="help-category-icon"></span>
                            <span class="help-category-title">Importing Leads</span>
                            <span class="help-category-count">4</span>
                            <span class="help-category-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg></span>
                        </div>
                        <div class="help-category-content">
                            <div class="help-item" data-keywords="add single lead one import form">
                                <div class="help-item-header">
                                    <span class="help-item-question">How do I add a single lead?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>To add one lead at a time:</p>
                                    <ul>
                                        <li>Go to the <strong> Import Leads</strong> tab</li>
                                        <li>Make sure <strong>" Single Lead"</strong> is selected</li>
                                        <li>Fill in the required fields: First Name, Phone Number, Interest</li>
                                        <li>Optionally add Last Name, Email, and Max Call Attempts</li>
                                        <li>Click <strong>"Add Lead"</strong></li>
                                    </ul>
                                    <div class="help-tip"> Tip: Great for adding referrals or hot leads that need immediate attention!</div>
                                </div>
                            </div>
                            <div class="help-item" data-keywords="upload csv import leads file bulk multiple">
                                <div class="help-item-header">
                                    <span class="help-item-question">How do I upload multiple leads at once?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>To upload multiple leads via CSV:</p>
                                    <ul>
                                        <li>Go to the <strong> Import Leads</strong> tab</li>
                                        <li>Click <strong>" Bulk Upload"</strong></li>
                                        <li>Download the CSV template first</li>
                                        <li>Fill in your lead data following the template format</li>
                                        <li>Drag & drop your file or click to browse</li>
                                    </ul>
                                    <div class="help-tip"> Tip: Always use the template to ensure proper formatting!</div>
                                </div>
                            </div>
                            <div class="help-item" data-keywords="csv format columns required fields">
                                <div class="help-item-header">
                                    <span class="help-item-question">What format should my CSV be in?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>Your CSV should include these columns:</p>
                                    <ul>
                                        <li><strong>First Name</strong> (required)</li>
                                        <li><strong>Last Name</strong> (optional)</li>
                                        <li><strong>Phone</strong> (required)  format: 10 digits or with country code</li>
                                        <li><strong>Email</strong> (optional)</li>
                                    </ul>
                                    <div class="help-warning"> Phone numbers must be valid Canadian/US numbers (10-11 digits).</div>
                                </div>
                            </div>
                            <div class="help-item" data-keywords="upload after happens processing time">
                                <div class="help-item-header">
                                    <span class="help-item-question">What happens after I import leads?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>After importing:</p>
                                    <ul>
                                        <li>Leads are validated and deduplicated</li>
                                        <li>They appear in your Prospects tab within minutes</li>
                                        <li>The AI begins calling them during the next calling window</li>
                                        <li>You'll see them move through statuses as calls are made</li>
                                    </ul>
                                    <p>Calling windows are typically 10am-1pm and 4pm-7pm to maximize pickup rates.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sharing Leads -->
                    <div class="help-category" data-category="sharing">
                        <div class="help-category-header">
                            <span class="help-category-icon"></span>
                            <span class="help-category-title">Sharing Leads</span>
                            <span class="help-category-count">3</span>
                            <span class="help-category-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg></span>
                        </div>
                        <div class="help-category-content">
                            <div class="help-item" data-keywords="share lead plus button another agent collaborate">
                                <div class="help-item-header">
                                    <span class="help-item-question">How do I share a lead with another agent?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>To share a lead with a colleague:</p>
                                    <ul>
                                        <li>Find the lead in your PRIO or Prospects table</li>
                                        <li>Click the <strong>+ button</strong> next to their name</li>
                                        <li>Select which agent to share with</li>
                                        <li>Click <strong>"Share"</strong></li>
                                    </ul>
                                    <p>The other agent will now see this lead in their dashboard with a  chain icon.</p>
                                    <div class="help-warning"> Each lead can only be shared with one other agent at a time.</div>
                                </div>
                            </div>
                            <div class="help-item" data-keywords="chain icon shared lead link symbol">
                                <div class="help-item-header">
                                    <span class="help-item-question">What does the chain icon () mean?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>The chain icon <strong></strong> indicates a <strong>shared lead</strong>.</p>
                                    <p>If you see this icon, it means:</p>
                                    <ul>
                                        <li>The lead is shared between you and another agent</li>
                                        <li>Either you shared it with them, or they shared it with you</li>
                                        <li>Both agents can view and work on this lead</li>
                                    </ul>
                                    <div class="help-tip"> Tip: Hover over the icon to see who the lead is shared with!</div>
                                </div>
                            </div>
                            <div class="help-item" data-keywords="stop sharing remove unshare lead">
                                <div class="help-item-header">
                                    <span class="help-item-question">How do I stop sharing a lead?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>Only the original owner of a lead can stop sharing it.</p>
                                    <p>To stop sharing:</p>
                                    <ul>
                                        <li>Find the shared lead (shows  icon)</li>
                                        <li>Click the <strong> button</strong> next to the chain icon</li>
                                        <li>Confirm you want to stop sharing</li>
                                    </ul>
                                    <p>The other agent will no longer see this lead in their dashboard.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Troubleshooting -->
                    <div class="help-category" data-category="troubleshooting">
                        <div class="help-category-header">
                            <span class="help-category-icon"></span>
                            <span class="help-category-title">Troubleshooting</span>
                            <span class="help-category-count">3</span>
                            <span class="help-category-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg></span>
                        </div>
                        <div class="help-category-content">
                            <div class="help-item" data-keywords="lead not showing missing disappeared">
                                <div class="help-item-header">
                                    <span class="help-item-question">Why isn't my lead showing up?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>If you can't find a lead:</p>
                                    <ul>
                                        <li><strong>Check filters:</strong> Make sure you're not filtering by a status that excludes them</li>
                                        <li><strong>Use Search tab:</strong> Search by name or last 4 phone digits</li>
                                        <li><strong>Check timeframe:</strong> The table might be filtered to recent leads only</li>
                                        <li><strong>Clear search:</strong> Make sure the search box is empty</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="help-item" data-keywords="report issue bug problem wrong">
                                <div class="help-item-header">
                                    <span class="help-item-question">How do I report an issue with a lead?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>If you notice something wrong with a lead (wrong status, incorrect booking, etc.):</p>
                                    <ul>
                                        <li>Open the lead detail modal</li>
                                        <li>Click the <strong>" Report"</strong> button at the top</li>
                                        <li>Describe the issue</li>
                                        <li>Our team will investigate and fix it</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="help-item" data-keywords="contact support help email">
                                <div class="help-item-header">
                                    <span class="help-item-question">How do I contact support?</span>
                                    <span class="help-item-toggle">+</span>
                                </div>
                                <div class="help-item-answer">
                                    <p>You can reach us through:</p>
                                    <ul>
                                        <li><strong>Feedback tab:</strong> Use the  Feedback tab to send us a message</li>
                                        <li><strong>Email:</strong> Contact us at <a href="mailto:info@prioai.ca" style="color:var(--accent);">info@prioai.ca</a></li>
                                    </ul>
                                    <p>We typically respond within 24 hours on business days.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Navigation Arrows -->
<button class="modal-nav modal-nav-prev" id="modalPrev" style="display:none;">
    <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
</button>
<button class="modal-nav modal-nav-next" id="modalNext" style="display:none;">
    <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
</button>

<!-- Lead Detail Modal -->
<div class="modal-overlay" id="leadModal">
    <div class="modal">
        <div class="modal-header">
            <div style="display:flex;flex-direction:column;gap:8px;">
                <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                    <h2 id="modalLeadName">Lead Name</h2>
                    <button class="btn-prio" id="prioLeadBtn" title="Mark as priority lead">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                        PRIO LEAD
                    </button>
                    <button class="btn-send-back" id="sendBackToAIBtn" style="padding:8px 14px;font-size:0.8125rem;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M12 2a10 10 0 1 0 10 10H12V2z"/><circle cx="12" cy="12" r="3"/></svg>
                        Send Back to AI
                    </button>
                </div>
                <!-- Sharing Info Row -->
                <div id="modalShareInfo" class="modal-share-info">
                    <span id="modalShareText" class="modal-share-text"></span>
                    <button id="modalShareEditBtn" class="modal-share-edit" title="Edit sharing"></button>
                </div>
            </div>
            <div style="display:flex;align-items:center;gap:8px;">
                <button class="btn-report-bug" id="reportBugBtn" title="Report an issue with this lead"> Report</button>
                <button class="modal-close" id="modalClose" style="font-size:2rem;width:40px;height:40px;">&times;</button>
            </div>
        </div>
        <div class="modal-body">
            <div class="lead-info-grid">
                <div class="lead-info-item">
                    <label>Phone</label>
                    <div class="value" id="modalPhone">-</div>
                </div>
                <div class="lead-info-item">
                    <label>Status</label>
                    <div class="value"><span id="modalStatus" class="status-badge">-</span></div>
                </div>
                <div class="lead-info-item">
                    <label>Last Called</label>
                    <div class="value" id="modalLastCalled">-</div>
                </div>
                <div class="lead-info-item">
                    <label>Booked / Callback Time <button class="btn-edit-inline" id="editBookedTimeBtn" title="Edit booked time"></button></label>
                    <div class="value" id="modalBookedTime">-</div>
                    <div id="modalScheduleBtn" style="display:none;">
                        <button class="btn-schedule-modal" onclick="openScheduleFromModal()"> Schedule Meeting</button>
                    </div>
                </div>
                <div class="lead-info-item lead-info-full">
                    <label>Call Summary</label>
                    <div class="value" id="modalCallSummary">-</div>
                </div>
            </div>
            
            <div class="agent-notes-section">
                <h3>
                     Your Notes
                    <span class="info-tooltip" title="These notes sync to our database and will be used as context for future AI conversations if you send this lead back to the AI caller.">
                        <span class="info-icon"></span>
                        <span class="tooltip-text">These notes sync to our database and will be used as context for future AI conversations if you send this lead back to the AI caller.</span>
                    </span>
                    <span style="margin-left:auto;font-size:1rem;font-weight:600;color:var(--text-primary);" id="clientNotesCount">0</span>
                </h3>
                <div id="clientNotesList" style="display:flex;flex-direction:column;gap:8px;max-height:200px;overflow-y:auto;margin-bottom:12px;"></div>
                <textarea id="agentNotesInput" placeholder="Add a new note..." style="min-height:100px;margin-bottom:12px;"></textarea>
                <div class="notes-actions" style="display:flex;gap:8px;align-items:center;justify-content:center;">
                    <button id="voiceInputBtn" class="voice-input-btn" title="Voice to text (click to start)" style="padding:10px 12px;border-radius:8px;background:var(--bg-tertiary);border:1px solid var(--border);cursor:pointer;transition:all 0.2s;">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" style="color:var(--text-primary);"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>
                    </button>
                    <button id="polishNotesBtn" class="polish-notes-btn" title="Polish note with AI" style="padding:10px 14px;border-radius:8px;background:linear-gradient(135deg, #8B5CF6, #7C3AED);border:none;color:white;font-size:0.8125rem;font-weight:600;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:6px;">
                         Polish
                    </button>
                    <button id="saveNoteBtn" class="save-note-btn" title="Save note" style="padding:10px 14px;border-radius:8px;background:var(--accent);border:none;color:white;font-size:0.8125rem;font-weight:600;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:6px;">
                         Save
                    </button>
                </div>
                <input type="hidden" id="editingNoteIndex" value="-1">
            </div>
            
            <div class="client-attempts-section" style="margin-top:20px;padding:16px;background:var(--bg-primary);border-radius:8px;border:1px solid var(--border);">
                <h3 style="font-size:0.875rem;color:var(--text-muted);margin-bottom:12px;display:flex;align-items:center;gap:8px;">
                     Your Call Attempts
                    <span style="margin-left:auto;font-size:1rem;font-weight:600;color:var(--text-primary);" id="clientAttemptCount">0</span>
                </h3>
                <div id="clientAttemptsList" style="display:flex;flex-direction:column;gap:8px;max-height:150px;overflow-y:auto;margin-bottom:12px;"></div>
                <button class="btn btn-secondary btn-sm" id="addClientAttemptBtn" style="width:100%;">
                    + Log Call Attempt
                </button>
            </div>
            
            <div class="transcript-section">
                <h3>
                     Call Transcript
                    <div style="margin-left:auto;display:flex;gap:8px;">
                        <button class="btn-transcript-size" id="transcriptSizeBtn" title="Larger text">Aa</button>
                        <button class="btn-transcript-expand" id="transcriptExpandBtn" title="Open full transcript"> Expand</button>
                    </div>
                </h3>
                <div class="transcript-content" id="modalTranscript">No transcript available</div>
            </div>
        </div>
        </div>
    </div>
</div>

<!-- Transcript Popup Modal -->
<div class="transcript-modal" id="transcriptModal">
    <div class="transcript-modal-content">
        <div class="transcript-modal-header">
            <h3> Full Transcript</h3>
            <button class="modal-close" id="transcriptModalClose">&times;</button>
        </div>
        <div class="transcript-modal-body" id="transcriptModalBody">
        </div>
    </div>
</div>

<!-- Schedule Booking Modal -->
<div class="schedule-modal-overlay" id="scheduleModal">
    <div class="schedule-modal">
        <h3> Schedule Meeting</h3>
        <p id="scheduleLeadName" style="color:var(--text-secondary);margin-bottom:16px;font-size:0.875rem;"></p>
        
        <div class="form-group">
            <label>Select Date</label>
            <div class="calendar-picker" id="calendarPicker">
                <div class="calendar-header">
                    <button id="calendarPrev"></button>
                    <span class="calendar-month" id="calendarMonth"></span>
                    <button id="calendarNext"></button>
                </div>
                <div class="calendar-weekdays">
                    <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                </div>
                <div class="calendar-days" id="calendarDays"></div>
            </div>
        </div>
        
        <div class="form-group">
            <label>Select Time</label>
            <div class="time-picker-row" style="display:flex;gap:12px;align-items:center;">
                <select id="scheduleHour" style="flex:1;padding:12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-primary);color:var(--text-primary);font-size:1rem;">
                    <option value="9">9 AM</option>
                    <option value="10">10 AM</option>
                    <option value="11">11 AM</option>
                    <option value="12">12 PM</option>
                    <option value="13">1 PM</option>
                    <option value="14">2 PM</option>
                    <option value="15">3 PM</option>
                    <option value="16">4 PM</option>
                    <option value="17">5 PM</option>
                    <option value="18">6 PM</option>
                    <option value="19">7 PM</option>
                    <option value="20">8 PM</option>
                </select>
                <span style="color:var(--text-muted);">:</span>
                <select id="scheduleMinute" style="flex:1;padding:12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-primary);color:var(--text-primary);font-size:1rem;">
                    <option value="0">00</option>
                    <option value="15">15</option>
                    <option value="30">30</option>
                    <option value="45">45</option>
                </select>
            </div>
        </div>
        
        <div class="schedule-modal-actions">
            <button class="btn-cancel" id="scheduleCancelBtn">Cancel</button>
            <button class="btn-save" id="scheduleSaveBtn">Save Booking</button>
        </div>
        <p style="text-align:center;font-size:0.75rem;color:var(--text-muted);margin-top:12px;">
             Event will be automatically added to your Google Calendar
        </p>
    </div>
</div>

<!-- Confirm Close Modal -->
<div class="confirm-modal" id="confirmCloseModal">
    <div class="confirm-modal-content">
        <h3> Unsaved Note</h3>
        <p>You have an unsaved note in the text box. Do you want to save it before closing?</p>
        <div class="confirm-btns" style="flex-direction:column;gap:8px;">
            <button class="btn btn-primary" id="confirmSaveClose">Save Note & Close</button>
            <button class="btn btn-secondary" id="confirmKeepEditing">Keep Editing</button>
            <button class="btn" id="confirmDiscard" style="background:transparent;color:var(--text-muted);border:none;">Discard & Close</button>
        </div>
    </div>
</div>

<!-- Take Over Confirmation Modal -->
<div class="confirm-modal" id="takeoverModal">
    <div class="confirm-modal-content">
        <h3> Take Over This Lead?</h3>
        <p>By taking over this lead, the <strong>AI will no longer follow up</strong> with them. You will be responsible for reaching out and handling this lead yourself.</p>
        <p style="font-size:0.8125rem;color:var(--accent);margin-top:-8px;">The lead will appear in your Leads tab as "Callback".</p>
        <div class="confirm-btns">
            <button class="btn btn-secondary" id="takeoverCancel">Cancel</button>
            <button class="btn btn-primary" id="takeoverConfirm">Yes, Take Over</button>
        </div>
    </div>
</div>

<!-- Follow Up Modal -->
<div class="followup-modal" id="followupModal">
    <div class="followup-modal-content" style="max-width:440px;">
        <h3> Send Back to AI</h3>
        <p style="color:var(--text-secondary);margin-bottom:20px;">Why are you sending this lead back?</p>
        
        <!-- Reason Selection -->
        <div style="margin-bottom:24px;">
            <label style="font-size:0.75rem;color:var(--text-muted);margin-bottom:12px;display:block;text-transform:uppercase;letter-spacing:0.5px;">Reason</label>
            <div id="followupReasons" style="display:flex;flex-direction:column;gap:10px;">
                <button type="button" class="followup-reason-btn" data-reason="no_longer_interested">
                    <span style="font-size:1.125rem;"></span>
                    <span>No longer interested</span>
                </button>
                <button type="button" class="followup-reason-btn" data-reason="did_not_pickup">
                    <span style="font-size:1.125rem;"></span>
                    <span>Did not pick up</span>
                </button>
                <button type="button" class="followup-reason-btn" data-reason="stopped_responding">
                    <span style="font-size:1.125rem;"></span>
                    <span>Stopped responding</span>
                </button>
            </div>
        </div>
        
        <!-- Callback Period Selection -->
        <div style="margin-bottom:24px;">
            <label style="font-size:0.75rem;color:var(--text-muted);margin-bottom:12px;display:block;text-transform:uppercase;letter-spacing:0.5px;">When should AI call back?</label>
            <div id="followupPeriods" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">
                <button type="button" class="followup-period-btn" data-months="3">3 months</button>
                <button type="button" class="followup-period-btn" data-months="6">6 months</button>
                <button type="button" class="followup-period-btn" data-months="9">9 months</button>
                <button type="button" class="followup-period-btn" data-months="12">12 months</button>
                <button type="button" class="followup-period-btn" data-months="custom" style="grid-column:span 2;"> Pick a date</button>
            </div>
        </div>
        
        <!-- Calendar (hidden by default) -->
        <div id="followupCalendarSection" style="display:none;margin-bottom:24px;">
            <div class="calendar-container">
                <div class="calendar-header">
                    <button type="button" class="calendar-nav" id="followupCalendarPrev"></button>
                    <span id="followupCalendarMonthYear"></span>
                    <button type="button" class="calendar-nav" id="followupCalendarNext"></button>
                </div>
                <div class="calendar-weekdays">
                    <span>Su</span><span>Mo</span><span>Tu</span><span>We</span><span>Th</span><span>Fr</span><span>Sa</span>
                </div>
                <div class="calendar-days" id="followupCalendarDays"></div>
            </div>
        </div>
        
        <!-- Time of Day Selection -->
        <div style="margin-bottom:24px;">
            <label style="font-size:0.75rem;color:var(--text-muted);margin-bottom:12px;display:block;text-transform:uppercase;letter-spacing:0.5px;">Preferred time of day</label>
            <div id="followupTimeOptions" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">
                <button type="button" class="followup-time-btn" data-time="morning"> Morning</button>
                <button type="button" class="followup-time-btn selected" data-time="afternoon"> Afternoon</button>
                <button type="button" class="followup-time-btn" data-time="evening"> Evening</button>
            </div>
        </div>
        
        <p class="form-error" id="followupError"></p>
        <div style="display:flex;gap:12px;margin-top:24px;">
            <button class="btn btn-secondary" style="flex:1;padding:14px;" id="followupCancel">Cancel</button>
            <button class="btn btn-primary" style="flex:1;padding:14px;" id="followupConfirm">Send to AI</button>
        </div>
    </div>
</div>

<footer>
    <div class="container">
        <div class="footer-content">
            <div>
                <div class="footer-logo">
                    <img src="/assets/logo_black.png" alt="Prio AI" class="logo-img logo-light">
                    <img src="/assets/logo_white.png" alt="Prio AI" class="logo-img logo-dark">
                </div>
                <div class="footer-links">
                    <a href="/terms/">Terms of Service</a>
                    <a href="/privacy/">Privacy Policy</a>
                    <a href="/contact/">Contact Us</a>
                </div>
            </div>
            <div class="footer-info">
                <a href="mailto:info@prioai.ca">info@prioai.ca</a>
                <p>&copy; 2025 Prio AI. All rights reserved.</p>
            </div>
        </div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
var SUPABASE_URL = "https://bflmikgoafdffezrfpgb.supabase.co";
var SUPABASE_KEY = "sb_publishable_e4DbIJ2T-9QAMtXzYo4o8Q_x135R40k";
var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

var AIRTABLE_TOKEN = 'pat7G7IDgOiR6rbLQ.3a9db22c5170b90305b7504a63e6933bd54011b028ac384f3d29e9ad7bcdc0c3';
var AIRTABLE_BASE = 'applOjDjhH0RqLtBH';
var AIRTABLE_CLIENTS_TABLE = 'tblMptC862PyL7Znw';
var AIRTABLE_LEADS_TABLE = 'tblLpN4wceakfNFpq';
var AIRTABLE_CALLS_TABLE = 'tblvB5OpG0b5mVix3';
var UPLOAD_WEBHOOK = 'https://n8n.prioai.ca/webhook/lead-file-upload';

var currentUser = null;
var currentUserEmail = null;
var currentUserRecord = null;
var allLeads = [];
var displayedLeads = [];
var filteredLeads = [];
var prioLeads = [];
var filteredPrioLeads = [];
var currentSort = { field: null, direction: 'asc' };
var pipelineLeads = [];

// Admin functionality
var ADMIN_EMAIL = 'info@prioai.ca';
var isAdmin = false;
var viewingAsClient = null; // Email of client being viewed (null = viewing own data)
var allClients = [];
var filteredPipelineLeads = [];
var currentLeadId = null;
var currentLeadIndex = -1;
var originalNotes = '';
var originalClientAttempts = [];
var originalClientNotes = [];
var editingNoteIndex = -1;
var pendingTakeoverId = null;

var pendingTakeoverBtn = null;
var monthlyPlanLimit = 1000;
var callsThisMonth = 0;
var totalCallsAllTime = 0;
var welcomeMessages = [
    "Welcome back",
    "Good to see you",
    "Ready to close deals",
    "Let's get to work",
    "Your leads are waiting",
    "Back in action",
    "Time to follow up"
];

function setRandomWelcome() {
    var el = document.getElementById('welcomeMessage');
    if (el) el.textContent = welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];
}

// Toast notification
function showToast(message, type) {
    var toast = document.getElementById('toastNotification');
    var msgEl = document.getElementById('toastMessage');
    var iconEl = toast.querySelector('.toast-icon');
    
    msgEl.textContent = message;
    toast.className = 'toast-notification active';
    if (type === 'warning') { toast.classList.add('warning'); iconEl.textContent = ''; }
    else if (type === 'error') { toast.classList.add('error'); iconEl.textContent = ''; }
    else if (type === 'success') { toast.classList.add('success'); iconEl.textContent = ''; }
    else { iconEl.textContent = ''; }
    
    // Auto-hide after 4 seconds
    setTimeout(function() { toast.classList.remove('active'); }, 4000);
}

document.getElementById('toastClose').addEventListener('click', function() {
    document.getElementById('toastNotification').classList.remove('active');
});

var columnConfig = [
    { key: 'firstName', label: 'First Name', default: true },
    { key: 'lastName', label: 'Last Name', default: false },
    { key: 'phone', label: 'Phone', default: true },
    { key: 'status', label: 'Status', default: true },
    { key: 'lastCalled', label: 'Last Called', default: true },
    { key: 'bookedTime', label: 'Booked / Callback Time', default: true },
    { key: 'summary', label: 'Summary', default: true },
    { key: 'notes', label: 'Your Notes', default: true }
];

var columnVisibility = {};
columnConfig.forEach(function(c) { columnVisibility[c.key] = c.default; });

function buildColumnDropdown() {
    var dropdown = document.getElementById('columnDropdown');
    dropdown.innerHTML = columnConfig.map(function(c) {
        return '<div class="column-option"><input type="checkbox" data-col="' + c.key + '"' + (columnVisibility[c.key] ? ' checked' : '') + '><span>' + c.label + '</span></div>';
    }).join('');
    dropdown.querySelectorAll('input').forEach(function(input) {
        input.addEventListener('change', function() {
            columnVisibility[this.dataset.col] = this.checked;
            updateColumnVisibility();
            renderLeads();
        });
    });
}
buildColumnDropdown();

var statusInfo = {
    'Booked': { highlight: true, tip: 'Lead has booked a meeting with you' },
    'Callback': { highlight: true, tip: 'Lead requested a personal callback from you' },
    'Follow Up': { highlight: true, tip: 'Scheduled for AI to follow up on a specific date' },
    'Timeline': { highlight: false, tip: 'Interested but not ready yet, AI will nurture' },
    'Retry': { highlight: false, tip: 'AI will retry calling this lead' },
    'Closed': { highlight: false, tip: 'Lead is not interested or unreachable' },
    'DNC': { highlight: false, tip: 'Do Not Call - removed from call list' }
};
var statusOrder = ['Booked', 'Callback', 'Follow Up', 'Timeline', 'Retry', 'Closed', 'DNC'];

// Tab navigation helper function
function switchToTab(tabId) {
    document.querySelectorAll('.dashboard-tab').forEach(function(t) { t.classList.remove('active'); });
    document.querySelectorAll('.tab-panel').forEach(function(p) { p.classList.remove('active'); });
    var tabBtn = document.querySelector('.dashboard-tab[data-tab="' + tabId + '"]');
    var tabPanel = document.getElementById('tab-' + tabId);
    if (tabBtn && tabPanel) {
        tabBtn.classList.add('active');
        tabPanel.classList.add('active');
        if (tabId === 'analytics') updateAnalytics();
        if (tabId === 'pipeline') renderPipeline();
        if (tabId === 'prio') renderPrio();
    }
}

// Switch analytics period tab
function switchAnalyticsPeriod(period) {
    document.querySelectorAll('.analytics-period-tab').forEach(function(t) { t.classList.remove('active'); });
    var periodTab = document.querySelector('.analytics-period-tab[data-period="' + period + '"]');
    if (periodTab) {
        periodTab.classList.add('active');
        currentAnalyticsPeriod = period;
        showAnalyticsPicker(period);
        updateAnalytics();
    }
}

// Open lead by record ID
function openLeadByRecordId(recordId) {
    // Check in allLeads
    var leadIndex = allLeads.findIndex(function(l) { return l.id === recordId; });
    if (leadIndex !== -1) {
        filteredLeads = allLeads;
        openLeadModal(leadIndex);
        return true;
    }
    return false;
}

// Handle URL hash on page load
function handleHashChange() {
    var hash = window.location.hash.replace('#', '');
    if (!hash) return;
    
    // Handle analytics period: #analytics-daily, #analytics-weekly, etc.
    if (hash.startsWith('analytics-')) {
        var period = hash.replace('analytics-', '');
        switchToTab('analytics');
        setTimeout(function() { switchAnalyticsPeriod(period); }, 100);
        return;
    }
    
    // Handle individual lead: #lead-recXXXXXXX
    if (hash.startsWith('lead-')) {
        var recordId = hash.replace('lead-', '');
        // Wait for leads to load, then open
        var checkLeads = function() {
            if (allLeads.length > 0) {
                if (openLeadByRecordId(recordId)) {
                    // Lead found and opened
                } else {
                    console.log('Lead not found:', recordId);
                }
            } else {
                setTimeout(checkLeads, 200);
            }
        };
        checkLeads();
        return;
    }
    
    // Handle main tabs
    if (document.querySelector('.dashboard-tab[data-tab="' + hash + '"]')) {
        switchToTab(hash);
    }
}

// Listen for hash changes (back/forward buttons)
window.addEventListener('hashchange', handleHashChange);

// Tab navigation - main tabs
document.querySelectorAll('.dashboard-tab[data-tab]').forEach(function(tab) {
    tab.addEventListener('click', function() {
        var tabId = this.dataset.tab;
        if (!tabId) return;
        window.location.hash = tabId;
        switchToTab(tabId);
    });
});

document.getElementById('goToAnalyticsBtn').addEventListener('click', function() {
    window.location.hash = 'analytics';
    switchToTab('analytics');
});

document.getElementById('settingsLink').addEventListener('click', function(e) {
    e.preventDefault();
    window.location.hash = 'profile';
    switchToTab('profile');
    document.getElementById('userDropdown').classList.remove('active');
});

document.getElementById('feedbackLink').addEventListener('click', function(e) {
    e.preventDefault();
    window.location.hash = 'feedback';
    switchToTab('feedback');
    document.getElementById('userDropdown').classList.remove('active');
});

// Column toggle
document.getElementById('columnToggleBtn').addEventListener('click', function(e) {
    e.stopPropagation();
    document.getElementById('columnDropdown').classList.toggle('active');
});
document.addEventListener('click', function(e) {
    if (!e.target.closest('.column-toggle-wrapper')) document.getElementById('columnDropdown').classList.remove('active');
});

function updateColumnVisibility() {
    Object.keys(columnVisibility).forEach(function(col) {
        document.querySelectorAll('.col-' + col).forEach(function(cell) {
            if (columnVisibility[col]) cell.classList.remove('col-hidden');
            else cell.classList.add('col-hidden');
        });
    });
}

// Feedback type
document.querySelectorAll('.feedback-type').forEach(function(type) {
    type.addEventListener('click', function() {
        document.querySelectorAll('.feedback-type').forEach(function(t) { t.classList.remove('selected'); });
        this.classList.add('selected');
        document.getElementById('feedbackType').value = this.dataset.type;
    });
});

// Profile picture
document.getElementById('profileUploadBtn').addEventListener('click', function() {
    document.getElementById('profilePicInput').click();
});

document.getElementById('profilePicInput').addEventListener('change', async function() {
    if (this.files && this.files[0]) {
        var file = this.files[0];
        if (file.size > 10 * 1024 * 1024) { showToast('Image too large. Max 10MB.', 'error'); return; }
        var reader = new FileReader();
        reader.onload = async function(e) {
            var base64 = e.target.result;
            try {
                var result = await supabase.auth.updateUser({ data: { profile_picture: base64 } });
                if (!result.error) updateProfilePicture(base64);
            } catch (err) { console.error(err); }
        };
        reader.readAsDataURL(file);
    }
});

document.getElementById('profileRemoveBtn').addEventListener('click', async function() {
    try {
        var result = await supabase.auth.updateUser({ data: { profile_picture: null } });
        if (!result.error) updateProfilePicture(null);
    } catch (err) { console.error(err); }
});

function updateProfilePicture(url) {
    var avatar = document.getElementById('profileAvatar');
    var removeBtn = document.getElementById('profileRemoveBtn');
    var navAvatar = document.getElementById('userAvatar');
    if (url) {
        avatar.innerHTML = '<img src="' + url + '" alt="Profile">';
        removeBtn.style.display = 'inline-block';
        navAvatar.innerHTML = '<img src="' + url + '" alt="" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">';
    } else {
        var name = document.getElementById('dashboardUserName').textContent || 'U';
        avatar.innerHTML = '<span id="profileInitial">' + name.charAt(0).toUpperCase() + '</span>';
        removeBtn.style.display = 'none';
        navAvatar.textContent = name.charAt(0).toUpperCase();
    }
}

function updateUserUI(user) {
    var displayName = user.user_metadata?.display_name || user.user_metadata?.full_name || user.email.split('@')[0] || 'User';
    var profilePic = user.user_metadata?.profile_picture;
    document.getElementById('dashboardUserName').textContent = displayName.split(' ')[0];
    document.getElementById('userDisplayName').textContent = displayName;
    document.getElementById('settingsDisplayName').value = user.user_metadata?.display_name || '';
    document.getElementById('profileInitial').textContent = displayName.charAt(0).toUpperCase();
    if (profilePic) updateProfilePicture(profilePic);
    else document.getElementById('userAvatar').textContent = displayName.charAt(0).toUpperCase();
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    return new Date(dateStr).toLocaleDateString('en-CA', { month: 'short', day: 'numeric', year: 'numeric' });
}

function formatDateTime(dateStr) {
    if (!dateStr) return '-';
    return new Date(dateStr).toLocaleDateString('en-CA', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
}

function formatPhone(phone) {
    if (!phone) return '-';
    var cleaned = phone.toString().replace(/\D/g, '');
    if (cleaned.length === 11 && cleaned[0] === '1') cleaned = cleaned.slice(1);
    if (cleaned.length === 10) return '(' + cleaned.slice(0,3) + ') ' + cleaned.slice(3,6) + '-' + cleaned.slice(6);
    return phone;
}

// Get most recent timestamp between AI calls and client manual calls
function getMostRecentLastCalled(fields) {
    var aiLastCall = fields['Last Call Timestamp'] ? new Date(fields['Last Call Timestamp']) : null;
    var clientLastCall = fields['Client Last Call Timestamp'] ? new Date(fields['Client Last Call Timestamp']) : null;
    
    if (!aiLastCall && !clientLastCall) return null;
    if (!aiLastCall) return clientLastCall;
    if (!clientLastCall) return aiLastCall;
    
    return aiLastCall > clientLastCall ? aiLastCall : clientLastCall;
}

function getLastNoteText(notesData) {
    if (!notesData) return '-';
    try {
        var parsed = JSON.parse(notesData);
        if (Array.isArray(parsed) && parsed.length > 0) {
            return parsed[parsed.length - 1].text || '-';
        }
    } catch (e) {
        // Legacy plain text - return as is
        return String(notesData);
    }
    return '-';
}

function getStatusClass(status) {
    if (!status) return '';
    var s = status.toLowerCase();
    if (s.includes('booked')) return 'meeting-booked';
    if (s.includes('callback')) return 'callback';
    return '';
}

function showDashboard() {
    document.getElementById('dashboardLoading').style.display = 'none';
    document.getElementById('dashboardContent').classList.add('loaded');
    setRandomWelcome();
}

function getPlanLimit(plan) {
    if (!plan) return 1000;
    var p = plan.toLowerCase();
    if (p.includes('enterprise')) return 10000;
    if (p.includes('professional')) return 3000;
    return 1000;
}

function updateCallsUsage() {
    var usageEl = document.getElementById('callsUsage');
    var usedEl = document.getElementById('callsUsed');
    var limitEl = document.getElementById('callsLimit');
    var barEl = document.getElementById('callsBarFill');
    usedEl.textContent = callsThisMonth;
    limitEl.textContent = monthlyPlanLimit;
    var pct = Math.min((callsThisMonth / monthlyPlanLimit) * 100, 100);
    barEl.style.width = pct + '%';
    if (pct >= 80) usageEl.classList.add('warning');
    else usageEl.classList.remove('warning');
    usageEl.style.display = 'flex';
}

async function fetchUserData() {
    var filterFormula = encodeURIComponent('LOWER({Email})="' + currentUserEmail.toLowerCase() + '"');
    var response = await fetch('https://api.airtable.com/v0/' + AIRTABLE_BASE + '/' + AIRTABLE_CLIENTS_TABLE + '?filterByFormula=' + filterFormula, {
        headers: { 'Authorization': 'Bearer ' + AIRTABLE_TOKEN }
    });
    var data = await response.json();
    if (data.records && data.records.length > 0) {
        currentUserRecord = data.records[0];
        populateSettings();
        var retellPhone = currentUserRecord.fields['Retell Phone'];
        if (retellPhone) {
            document.getElementById('retellPhoneNumber').textContent = formatPhone(retellPhone);
            document.getElementById('userPhoneDisplay').style.display = 'flex';
        }
        monthlyPlanLimit = getPlanLimit(currentUserRecord.fields['Monthly Plan']);
        // Get calls this month from rollup field
        callsThisMonth = currentUserRecord.fields['Calls This Month'] || 0;
        // Get total calls from rollup field (if exists) or we'll calculate later
        totalCallsAllTime = currentUserRecord.fields['Total Calls'] || 0;
        updateCallsUsage();
    }
    return data;
}

function populateSettings() {
    if (!currentUserRecord) return;
    var f = currentUserRecord.fields;
    var agentName = f['Agent Name'] || '-';
    document.getElementById('profileName').textContent = agentName;
    document.getElementById('profileEmail').textContent = f['Email'] || '-';
    document.getElementById('profilePlan').textContent = f['Monthly Plan'] || 'Starter';
    document.getElementById('profileStatus').textContent = f['Status'] || 'Unpaid';
    document.getElementById('settingsPhone').value = f['Phone'] || '';
    document.getElementById('settingsCalendar').value = f['Google Calendar Email'] || '';
    if (f['Available Start']) document.getElementById('settingsStart').value = f['Available Start'];
    if (f['Available End']) document.getElementById('settingsEnd').value = f['Available End'];
}

async function fetchAllLeads() {
    try {
        var email = (viewingAsClient || currentUserEmail).toLowerCase();
        // Include leads where user is primary client OR in Shared With
        var filterFormula = 'OR(FIND("' + email + '", LOWER(ARRAYJOIN({Client Email}))), FIND("' + email + '", LOWER(ARRAYJOIN({Shared With Email}))))';
        var allRecords = [];
        var offset = null;
        do {
            var url = 'https://api.airtable.com/v0/' + AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '?filterByFormula=' + encodeURIComponent(filterFormula) + '&pageSize=100';
            if (offset) url += '&offset=' + offset;
            var response = await fetch(url, { headers: { 'Authorization': 'Bearer ' + AIRTABLE_TOKEN } });
            var data = await response.json();
            if (data.records) allRecords = allRecords.concat(data.records);
            offset = data.offset;
        } while (offset);
        
        // Mark which leads are shared (not primary owner)
        allRecords.forEach(function(lead) {
            var clientEmails = lead.fields['Client Email'] || [];
            if (typeof clientEmails === 'string') clientEmails = [clientEmails];
            lead.isShared = !clientEmails.some(function(e) { return (e || '').toLowerCase() === email; });
        });
        
        allLeads = allRecords;
        document.getElementById('headerTotalLeads').textContent = allLeads.length;
        
        pipelineLeads = allLeads.filter(function(l) {
            var s = (l.fields['Status'] || '').toLowerCase();
            return s === 'timeline' || s === 'follow up';
        }).sort(function(a, b) {
            return new Date(b.fields['Last Call Timestamp'] || 0) - new Date(a.fields['Last Call Timestamp'] || 0);
        });
        
        // If we don't have total calls from Clients table, sum Attempts from all leads
        if (!totalCallsAllTime) {
            totalCallsAllTime = allLeads.reduce(function(sum, l) { 
                return sum + (parseInt(l.fields['Attempts']) || 0); 
            }, 0);
        }
    } catch (err) {
        console.error('Error fetching all leads:', err);
    }
}

async function fetchDisplayedLeads() {
    // Show loading spinner - with null checks
    var loadingRow = document.getElementById('leadsLoadingRow');
    var tableWrapper = document.getElementById('leadsTableWrapper');
    var emptyState = document.getElementById('emptyState');
    
    if (loadingRow) loadingRow.style.display = 'table-row';
    if (tableWrapper) tableWrapper.style.display = 'none';
    if (emptyState) emptyState.style.display = 'none';
    
    try {
        var email = (viewingAsClient || currentUserEmail).toLowerCase();
        // Include shared leads
        var filterFormula = 'AND(OR(FIND("' + email + '", LOWER(ARRAYJOIN({Client Email}))), FIND("' + email + '", LOWER(ARRAYJOIN({Shared With Email})))), OR({Status}="Booked", {Status}="Callback"))';
        var allRecords = [];
        var offset = null;
        
        // Paginate through all results
        do {
            var url = 'https://api.airtable.com/v0/' + AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '?filterByFormula=' + encodeURIComponent(filterFormula) + '&sort[0][field]=Last%20Call%20Timestamp&sort[0][direction]=desc&pageSize=100';
            if (offset) url += '&offset=' + offset;
            
            var response = await fetch(url, { headers: { 'Authorization': 'Bearer ' + AIRTABLE_TOKEN } });
            var data = await response.json();
            
            if (data.records) {
                allRecords = allRecords.concat(data.records);
            }
            offset = data.offset; // Will be undefined if no more pages
        } while (offset);
        
        // Mark which leads are shared
        allRecords.forEach(function(lead) {
            var clientEmails = lead.fields['Client Email'] || [];
            if (typeof clientEmails === 'string') clientEmails = [clientEmails];
            lead.isShared = !clientEmails.some(function(e) { return (e || '').toLowerCase() === email; });
        });
        
        displayedLeads = allRecords;
        console.log('Fetched ' + displayedLeads.length + ' leads (Booked/Callback)');
        
        // Hide loading spinner and show table
        if (loadingRow) loadingRow.style.display = 'none';
        if (tableWrapper) tableWrapper.style.display = 'block';
        renderLeads();
        updateAnalytics(); // Keep analytics in sync
    } catch (err) {
        console.error('Error fetching displayed leads:', err);
        if (loadingRow) loadingRow.style.display = 'none';
        if (emptyState) emptyState.style.display = 'block';
    }
}

function renderLeads() {
    var tbody = document.getElementById('leadsTableBody');
    var emptyState = document.getElementById('emptyState');
    var searchTerm = document.getElementById('searchLeads').value.toLowerCase();
    var statusFilter = document.getElementById('filterStatus').value;
    var timeframeFilter = document.getElementById('filterTimeframe').value;
    var sharedFilter = document.getElementById('filterShared').value;
    var now = new Date();
    var cutoffDate = null;
    if (timeframeFilter === '0') cutoffDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    else if (timeframeFilter) cutoffDate = new Date(now - (parseInt(timeframeFilter) * 24 * 60 * 60 * 1000));
    
    filteredLeads = displayedLeads.filter(function(lead) {
        var f = lead.fields;
        // Exclude PRIO leads from main Leads tab
        if (f['Is Prio'] === true) return false;
        
        // Shared filter logic
        var sharedWithEmailRaw = f['Shared With Email'];
        var sharedWithEmail = Array.isArray(sharedWithEmailRaw) ? (sharedWithEmailRaw[0] || '') : (sharedWithEmailRaw || '');
        var isOwned = !lead.isShared; // owned by current user
        var isSharedByMe = isOwned && sharedWithEmail; // owned AND shared with someone
        var isNotShared = isOwned && !sharedWithEmail; // owned AND not shared
        var isSharedWithMe = lead.isShared; // shared TO current user
        
        if (sharedFilter === 'owned' && !isOwned) return false;
        if (sharedFilter === 'shared_by_me' && !isSharedByMe) return false;
        if (sharedFilter === 'not_shared' && !isNotShared) return false;
        if (sharedFilter === 'shared_with_me' && !isSharedWithMe) return false;
        
        var firstName = (f['First Name'] || '').toLowerCase();
        var lastName = (f['Last Name'] || '').toLowerCase();
        var phone = (f['Phone #'] || '').toLowerCase();
        var status = f['Status'] || '';
        var lastCalled = f['Last Call Timestamp'] ? new Date(f['Last Call Timestamp']) : null;
        if (searchTerm && !firstName.includes(searchTerm) && !lastName.includes(searchTerm) && !phone.includes(searchTerm)) return false;
        if (statusFilter && !status.toLowerCase().includes(statusFilter.toLowerCase())) return false;
        if (cutoffDate && lastCalled && lastCalled < cutoffDate) return false;
        return true;
    });
    
    // Update leads count
    document.getElementById('leadsCount').textContent = filteredLeads.length;
    
    // Apply sorting if set
    if (currentSort.field) {
        filteredLeads.sort(function(a, b) {
            var valA, valB;
            var fA = a.fields;
            var fB = b.fields;
            
            switch(currentSort.field) {
                case 'firstName':
                    valA = (fA['First Name'] || '').toLowerCase();
                    valB = (fB['First Name'] || '').toLowerCase();
                    break;
                case 'status':
                    valA = (fA['Status'] || '').toLowerCase();
                    valB = (fB['Status'] || '').toLowerCase();
                    break;
                case 'lastCalled':
                    valA = fA['Last Call Timestamp'] ? new Date(fA['Last Call Timestamp']).getTime() : 0;
                    valB = fB['Last Call Timestamp'] ? new Date(fB['Last Call Timestamp']).getTime() : 0;
                    break;
                case 'bookedTime':
                    valA = fA['Booked Time'] ? new Date(fA['Booked Time']).getTime() : 0;
                    valB = fB['Booked Time'] ? new Date(fB['Booked Time']).getTime() : 0;
                    break;
                default:
                    return 0;
            }
            
            if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
            if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
            return 0;
        });
    }
    
    if (filteredLeads.length === 0) { tbody.innerHTML = ''; emptyState.style.display = 'block'; return; }
    
    emptyState.style.display = 'none';
    tbody.innerHTML = filteredLeads.map(function(lead, index) {
        var f = lead.fields;
        var firstName = f['First Name'] || '-';
        var lastName = f['Last Name'] || '-';
        var phone = formatPhone(f['Phone #']);
        var status = f['Status'] || '-';
        var lastCalled = formatDateTime(getMostRecentLastCalled(f));
        var bookedTime = f['Booked Time'] 
            ? formatDateTime(f['Booked Time'])
            : '<button class="btn-schedule-inline" data-index="' + index + '">Schedule</button>';
        var summary = String(f['Last Call Summary'] || '-');
        var notes = getLastNoteText(f['Client Notes']);
        var statusClass = getStatusClass(status);
        
        // Share indicator and button logic
        var sharedWithEmailRaw = f['Shared With Email'];
        var sharedWithEmail = Array.isArray(sharedWithEmailRaw) ? (sharedWithEmailRaw[0] || '') : (sharedWithEmailRaw || '');
        var shareHtml = '';
        if (lead.isShared) {
            // This lead is shared WITH current user - show clickable chain icon
            shareHtml = '<button class="btn-shared-indicator" data-lead-id="' + lead.id + '" data-is-owner="false" title="View sharing info"></button>';
        } else if (sharedWithEmail) {
            // This lead is owned by current user and shared with someone else
            shareHtml = '<button class="btn-shared-indicator" data-lead-id="' + lead.id + '" data-is-owner="true" data-shared-with="' + sharedWithEmail + '" title="View sharing info"></button>';
        } else {
            // Not shared - show + button to share
            shareHtml = '<button class="btn-share-lead" data-lead-id="' + lead.id + '" data-index="' + index + '" title="Share with another agent">+</button>';
        }
        
        var summaryHtml = summary.length > 100 
            ? '<div class="summary-text">' + summary + '</div>'
            : summary;
        return '<tr data-index="' + index + '"><td class="col-firstName">' + firstName + '</td><td class="col-lastName' + (columnVisibility.lastName ? '' : ' col-hidden') + '">' + lastName + '</td><td class="col-phone">' + phone + '</td><td class="col-status"><span class="status-badge ' + statusClass + '">' + status + '</span></td><td class="col-lastCalled">' + lastCalled + '</td><td class="col-bookedTime">' + bookedTime + '</td><td class="col-summary">' + summaryHtml + '</td><td class="col-notes' + (columnVisibility.notes ? '' : ' col-hidden') + '"><div class="notes-cell">' + notes + '</div></td><td class="col-sharing">' + shareHtml + '</td></tr>';
    }).join('');
    
    tbody.querySelectorAll('tr').forEach(function(row) {
        row.addEventListener('click', function(e) {
            if (!e.target.closest('.btn-schedule-inline') && !e.target.closest('.btn-share-lead') && !e.target.closest('.btn-shared-indicator')) openLeadModal(parseInt(this.dataset.index));
        });
    });
    tbody.querySelectorAll('.btn-share-lead').forEach(function(btn) {
        btn.addEventListener('click', function(e) { 
            e.stopPropagation(); 
            openSharePopup(this.dataset.leadId, this); 
        });
    });
    tbody.querySelectorAll('.btn-shared-indicator').forEach(function(btn) {
        btn.addEventListener('click', function(e) { 
            e.stopPropagation(); 
            openShareInfoPopup(this.dataset.leadId, this.dataset.isOwner === 'true', this.dataset.sharedWith || '', this); 
        });
    });
    tbody.querySelectorAll('.btn-schedule-inline').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            var idx = parseInt(this.dataset.index);
            var lead = filteredLeads[idx];
            if (lead) openScheduleModal(lead.id, lead.fields);
        });
    });
    updateColumnVisibility();
}

var currentPipelineSort = { field: null, direction: 'asc' };

function renderPipeline() {
    var tbody = document.getElementById('pipelineTableBody');
    var emptyState = document.getElementById('pipelineEmpty');
    var searchTerm = document.getElementById('searchPipeline').value.toLowerCase();
    var statusFilter = document.getElementById('filterPipelineStatus').value;
    var timeframeFilter = document.getElementById('filterPipelineTimeframe').value;
    var now = new Date();
    var cutoffDate = null;
    if (timeframeFilter === '0') cutoffDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    else if (timeframeFilter) cutoffDate = new Date(now - (parseInt(timeframeFilter) * 24 * 60 * 60 * 1000));
    
    filteredPipelineLeads = pipelineLeads.filter(function(lead) {
        var f = lead.fields;
        var firstName = (f['First Name'] || '').toLowerCase();
        var lastName = (f['Last Name'] || '').toLowerCase();
        var status = f['Status'] || '';
        var lastCalled = f['Last Call Timestamp'] ? new Date(f['Last Call Timestamp']) : null;
        if (searchTerm && !firstName.includes(searchTerm) && !lastName.includes(searchTerm)) return false;
        if (statusFilter && status !== statusFilter) return false;
        if (cutoffDate && lastCalled && lastCalled < cutoffDate) return false;
        return true;
    });
    
    // Update count badge
    document.getElementById('pipelineCount').textContent = filteredPipelineLeads.length;
    
    // Apply sorting
    if (currentPipelineSort.field) {
        filteredPipelineLeads.sort(function(a, b) {
            var valA, valB;
            var fA = a.fields;
            var fB = b.fields;
            switch(currentPipelineSort.field) {
                case 'name':
                    valA = (fA['First Name'] || '').toLowerCase();
                    valB = (fB['First Name'] || '').toLowerCase();
                    break;
                case 'status':
                    valA = (fA['Status'] || '').toLowerCase();
                    valB = (fB['Status'] || '').toLowerCase();
                    break;
                case 'lastCalled':
                    valA = fA['Last Call Timestamp'] ? new Date(fA['Last Call Timestamp']).getTime() : 0;
                    valB = fB['Last Call Timestamp'] ? new Date(fB['Last Call Timestamp']).getTime() : 0;
                    break;
                case 'nextCall':
                    valA = fA['Next Call Date'] ? new Date(fA['Next Call Date']).getTime() : 0;
                    valB = fB['Next Call Date'] ? new Date(fB['Next Call Date']).getTime() : 0;
                    break;
                default: return 0;
            }
            if (valA < valB) return currentPipelineSort.direction === 'asc' ? -1 : 1;
            if (valA > valB) return currentPipelineSort.direction === 'asc' ? 1 : -1;
            return 0;
        });
    }
    
    if (filteredPipelineLeads.length === 0) { tbody.innerHTML = ''; emptyState.style.display = 'block'; return; }
    
    emptyState.style.display = 'none';
    tbody.innerHTML = filteredPipelineLeads.map(function(lead, index) {
        var f = lead.fields;
        var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || '-';
        var phone = formatPhone(f['Phone #']);
        var status = f['Status'] || '-';
        var statusClass = getStatusClass(status);
        var summary = String(f['Last Call Summary'] || '-');
        var lastCalled = formatDateTime(getMostRecentLastCalled(f));
        var nextCall = formatDateTime(f['Next Call Date']);
        var summaryHtml = summary.length > 100 
            ? '<div class="summary-text">' + summary + '</div>'
            : summary;
        return '<tr data-pipeline-index="' + index + '" style="cursor:pointer;"><td>' + name + '</td><td>' + phone + '</td><td><span class="status-badge ' + statusClass + '">' + status + '</span></td><td class="summary-cell">' + summaryHtml + '</td><td>' + lastCalled + '</td><td>' + nextCall + '</td><td><button class="btn-takeover" data-id="' + lead.id + '"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg>Take Over</button></td></tr>';
    }).join('');
    
    // Row click to open modal
    tbody.querySelectorAll('tr').forEach(function(row) {
        row.addEventListener('click', function(e) {
            if (!e.target.closest('.btn-takeover')) {
                openPipelineLeadModal(parseInt(this.dataset.pipelineIndex));
            }
        });
    });
    
    tbody.querySelectorAll('.btn-takeover').forEach(function(btn) {
        btn.addEventListener('click', function(e) { e.stopPropagation(); showTakeoverConfirm(this.dataset.id, this); });
    });
}

// Open modal for pipeline lead
function openPipelineLeadModal(index) {
    if (index < 0 || index >= filteredPipelineLeads.length) return;
    var lead = filteredPipelineLeads[index];
    currentLeadId = lead.id;
    var f = lead.fields;
    var leadName = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Lead';
    document.getElementById('modalLeadName').textContent = leadName;
    document.getElementById('modalPhone').textContent = formatPhone(f['Phone #']);
    var statusEl = document.getElementById('modalStatus');
    var status = f['Status'] || '-';
    statusEl.textContent = status;
    statusEl.className = 'status-badge ' + getStatusClass(status);
    document.getElementById('modalLastCalled').textContent = formatDateTime(getMostRecentLastCalled(f));
    
    // Update booked time display
    var hasBookedTime = !!f['Booked Time'];
    document.getElementById('modalBookedTime').innerHTML = hasBookedTime ? formatDateTime(f['Booked Time']) + ' <button class="btn-delete-booking-modal" onclick="deleteBookingFromModal()" title="Remove booking"></button>' : '';
    document.getElementById('modalBookedTime').style.display = hasBookedTime ? 'block' : 'none';
    document.getElementById('modalScheduleBtn').style.display = hasBookedTime ? 'none' : 'block';
    document.getElementById('editBookedTimeBtn').style.display = hasBookedTime ? 'inline' : 'none';
    
    document.getElementById('modalCallSummary').textContent = f['Last Call Summary'] || 'No summary available';
    var notes = f['Client Notes'] || '';
    document.getElementById('agentNotesInput').value = notes;
    originalNotes = notes;
    
    // Update PRIO button and client attempts
    updatePrioButton(f['Is Prio']);
    updateClientAttempts(f['Client Attempts'] || [], true);
    
    var transcript = f['Transcript (from Calls)'] || '';
    if (Array.isArray(transcript)) transcript = transcript.join('\n\n---\n\n');
    document.getElementById('modalTranscript').innerHTML = formatTranscript(transcript, leadName) || 'No transcript available';
    // Hide nav arrows for pipeline modal
    document.getElementById('modalPrev').style.display = 'none';
    document.getElementById('modalNext').style.display = 'none';
    document.getElementById('leadModal').classList.add('active');
    document.body.style.overflow = 'hidden';
}

document.getElementById('searchPipeline').addEventListener('input', renderPipeline);
document.getElementById('filterPipelineStatus').addEventListener('change', renderPipeline);
document.getElementById('filterPipelineTimeframe').addEventListener('change', renderPipeline);

// Pipeline sorting
document.querySelectorAll('[data-sort-pipeline]').forEach(function(header) {
    header.addEventListener('click', function() {
        var field = this.dataset.sortPipeline;
        if (currentPipelineSort.field === field) {
            currentPipelineSort.direction = currentPipelineSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            currentPipelineSort.field = field;
            currentPipelineSort.direction = 'asc';
        }
        document.querySelectorAll('[data-sort-pipeline] .sort-icon').forEach(function(icon) {
            icon.textContent = '';
            icon.classList.remove('active');
        });
        var icon = this.querySelector('.sort-icon');
        icon.textContent = currentPipelineSort.direction === 'asc' ? '' : '';
        icon.classList.add('active');
        renderPipeline();
    });
});

function showTakeoverConfirm(leadId, btn) {
    pendingTakeoverId = leadId;
    pendingTakeoverBtn = btn;
    document.getElementById('takeoverModal').classList.add('active');
}

document.getElementById('takeoverCancel').addEventListener('click', function() {
    document.getElementById('takeoverModal').classList.remove('active');
    pendingTakeoverId = null;
    pendingTakeoverBtn = null;
    searchLeadTakeoverPending = false;
});

document.getElementById('takeoverConfirm').addEventListener('click', async function() {
    document.getElementById('takeoverModal').classList.remove('active');
    if (searchLeadTakeoverPending) {
        searchLeadTakeoverPending = false;
        await executeSearchLeadTakeover();
    } else if (pendingTakeoverId && pendingTakeoverBtn) {
        await takeOverLead(pendingTakeoverId, pendingTakeoverBtn);
    }
    pendingTakeoverId = null;
    pendingTakeoverBtn = null;
});

document.getElementById('takeoverModal').addEventListener('click', function(e) {
    if (e.target === this) { this.classList.remove('active'); pendingTakeoverId = null; pendingTakeoverBtn = null; searchLeadTakeoverPending = false; }
});

async function takeOverLead(leadId, btn) {
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner" style="width:14px;height:14px;border-width:2px;"></span>';
    try {
        var response = await fetch('https://api.airtable.com/v0/' + AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + leadId, {
            method: 'PATCH',
            headers: { 'Authorization': 'Bearer ' + AIRTABLE_TOKEN, 'Content-Type': 'application/json' },
            body: JSON.stringify({ fields: { 'Status': 'Callback' }})
        });
        if (response.ok) {
            btn.innerHTML = '';
            btn.style.color = '#22C55E';
            setTimeout(function() { fetchAllLeads().then(function() { fetchDisplayedLeads(); renderPipeline(); }); }, 800);
        } else throw new Error('Failed');
    } catch (err) { btn.innerHTML = 'Error'; btn.disabled = false; }
}

var currentAnalyticsPeriod = 'daily';
var analyticsCallsCache = null;
var analyticsCallsCacheTime = null;

async function fetchAnalyticsCalls() {
    // Cache for 2 minutes
    if (analyticsCallsCache && analyticsCallsCacheTime && (Date.now() - analyticsCallsCacheTime < 120000)) {
        return analyticsCallsCache;
    }
    
    // Get all lead IDs from allLeads (already filtered to this client)
    var leadIds = allLeads.map(function(l) { return l.id; });
    if (leadIds.length === 0) {
        console.log('Analytics: No leads available to fetch calls for');
        return [];
    }
    
    console.log('Analytics: Fetching calls for', leadIds.length, 'leads');
    
    var allCalls = [];
    var offset = null;
    var pageCount = 0;
    var maxPages = 100; // Up to 10000 calls max
    
    try {
        do {
            var url = 'https://api.airtable.com/v0/' + AIRTABLE_BASE + '/' + AIRTABLE_CALLS_TABLE + 
                '?pageSize=100&sort[0][field]=Timestamp&sort[0][direction]=desc';
            if (offset) url += '&offset=' + offset;
            
            var response = await fetch(url, {
                headers: { 'Authorization': 'Bearer ' + AIRTABLE_TOKEN }
            });
            var data = await response.json();
            
            if (data.records) {
                // Filter to only calls that belong to our leads
                var matchingCalls = data.records.filter(function(call) {
                    var callLeads = call.fields['Leads'] || [];
                    if (!Array.isArray(callLeads)) callLeads = [callLeads];
                    return callLeads.some(function(leadId) {
                        return leadIds.indexOf(leadId) !== -1;
                    });
                });
                allCalls = allCalls.concat(matchingCalls);
            }
            offset = data.offset;
            pageCount++;
        } while (offset && pageCount < maxPages);
        
        console.log('Analytics: Total calls fetched:', allCalls.length, '(pages:', pageCount + ')');
        analyticsCallsCache = allCalls;
        analyticsCallsCacheTime = Date.now();
        return allCalls;
    } catch (err) {
        console.error('Error fetching calls for analytics:', err);
        return [];
    }
}

async function updateAnalytics() {
    var now = new Date();
    var startDate, endDate;
    
    // Get picker values
    var datePicker = document.getElementById('analyticsDatePicker');
    var weekPicker = document.getElementById('analyticsWeekPicker');
    var monthPicker = document.getElementById('analyticsMonthPicker');
    
    // Calculate date range based on period
    switch (currentAnalyticsPeriod) {
        case 'daily':
            var selectedDate = datePicker.value ? new Date(datePicker.value + 'T00:00:00') : now;
            startDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), 0, 0, 0);
            endDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), 23, 59, 59);
            break;
        case 'weekly':
            var weekVal = weekPicker.value; // Format: "2025-12-01" (Monday date)
            if (weekVal) {
                startDate = new Date(weekVal + 'T00:00:00');
                endDate = new Date(startDate.getTime() + 6 * 24 * 60 * 60 * 1000);
                endDate.setHours(23, 59, 59);
            } else {
                // Default to current week
                var dayOfWeek = now.getDay();
                var mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + mondayOffset, 0, 0, 0);
                endDate = new Date(startDate.getTime() + 6 * 24 * 60 * 60 * 1000);
                endDate.setHours(23, 59, 59);
            }
            break;
        case 'monthly':
            var monthVal = monthPicker.value; // Format: "2026-01"
            if (monthVal) {
                var parts = monthVal.split('-');
                var year = parseInt(parts[0]);
                var month = parseInt(parts[1]) - 1;
                startDate = new Date(year, month, 1, 0, 0, 0);
                endDate = new Date(year, month + 1, 0, 23, 59, 59); // Last day of month
            } else {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0);
                endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
            }
            break;
        case 'all':
            startDate = new Date(2025, 11, 1, 0, 0, 0); // December 1, 2025
            endDate = now;
            break;
    }
    
    // Fetch calls from Calls table
    var allCalls = await fetchAnalyticsCalls();
    
    console.log('Analytics: Period:', currentAnalyticsPeriod);
    console.log('Analytics: Start date:', startDate);
    console.log('Analytics: End date:', endDate);
    console.log('Analytics: Total calls available:', allCalls.length);
    
    // Filter calls by timestamp in date range and that have an Outcome
    var periodCalls = allCalls.filter(function(c) {
        var timestamp = c.fields['Timestamp'];
        if (!timestamp) return false;
        var callDate = new Date(timestamp);
        return callDate >= startDate && callDate <= endDate && c.fields['Outcome'];
    });
    
    console.log('Analytics: Calls in period:', periodCalls.length);
    
    // Count outcomes
    var outcomes = {
        booked: 0, interested: 0, timeline: 0, not_interested: 0,
        voicemail: 0, no_answer: 0, wrong_person: 0, dnc: 0,
        invalid: 0, inconclusive: 0, max_attempts: 0
    };
    
    var bookedLeads = [], interestedLeads = [], timelineLeads = [];
    
    periodCalls.forEach(function(call) {
        var outcome = (call.fields['Outcome'] || '').trim();
        var f = call.fields;
        var leadName = Array.isArray(f['Lead Name']) ? (f['Lead Name'][0] || 'Unknown') : (f['Lead Name'] || 'Unknown');
        var leadPhone = Array.isArray(f['Lead Phone']) ? (f['Lead Phone'][0] || '') : (f['Lead Phone'] || '');
        var phone = formatPhone(leadPhone);
        var summaryRaw = f['summary'] || f['Agent Notes'] || '';
        var summary = String(summaryRaw).replace(/^Result\s*=\s*\w+\s*-\s*/i, '');
        var meetingTime = Array.isArray(f['Meeting Time']) ? (f['Meeting Time'][0] || '') : (f['Meeting Time'] || '');
        var callbackDate = Array.isArray(f['Callback Date']) ? (f['Callback Date'][0] || '') : (f['Callback Date'] || '');
        var leadStatus = Array.isArray(f['Lead Status']) ? (f['Lead Status'][0] || '') : (f['Lead Status'] || '');
        var leadId = Array.isArray(f['Leads']) ? (f['Leads'][0] || '') : (f['Leads'] || '');
        
        switch(outcome) {
            case 'Booked':
                outcomes.booked++;
                bookedLeads.push({ name: leadName, phone: phone, summary: summary, meetingTime: meetingTime, leadId: leadId });
                break;
            case 'Interested':
                outcomes.interested++;
                // Only add to table if Lead Status is "Callback" (within 90 days)
                if (leadStatus === 'Callback') {
                    interestedLeads.push({ name: leadName, phone: phone, summary: summary, callbackDate: callbackDate, leadId: leadId });
                }
                break;
            case 'Timeline':
                outcomes.timeline++;
                timelineLeads.push({ name: leadName, phone: phone, summary: summary, callbackDate: callbackDate, leadId: leadId });
                break;
            case 'Not Interested':
                outcomes.not_interested++;
                break;
            case 'Voicemail':
                outcomes.voicemail++;
                break;
            case 'No Answer':
                outcomes.no_answer++;
                break;
            case 'Wrong Person':
                outcomes.wrong_person++;
                break;
            case 'DNC':
                outcomes.dnc++;
                break;
            case 'Invalid':
                outcomes.invalid++;
                break;
            case 'Inconclusive':
                outcomes.inconclusive++;
                break;
            case 'Max Attempts':
                outcomes.max_attempts++;
                break;
        }
    });
    
    var totalCalls = periodCalls.length;
    var qualifiedConvos = outcomes.booked + outcomes.interested + outcomes.timeline + outcomes.not_interested;
    
    // Update key metrics
    document.getElementById('analyticsTotalCalls').textContent = totalCalls;
    document.getElementById('analyticsQualifiedConvos').textContent = qualifiedConvos;
    
    // Update qualified breakdown
    document.getElementById('analyticsBooked').textContent = outcomes.booked;
    document.getElementById('analyticsInterested').textContent = outcomes.interested;
    document.getElementById('analyticsTimeline').textContent = outcomes.timeline;
    document.getElementById('analyticsNotInterested').textContent = outcomes.not_interested;
    
    // Build other outcomes pills
    var otherPills = [];
    if (outcomes.voicemail > 0) otherPills.push('<span class="outcome-pill">Voicemail: ' + outcomes.voicemail + '</span>');
    if (outcomes.no_answer > 0) otherPills.push('<span class="outcome-pill">No Answer: ' + outcomes.no_answer + '</span>');
    if (outcomes.wrong_person > 0) otherPills.push('<span class="outcome-pill">Wrong Person: ' + outcomes.wrong_person + '</span>');
    if (outcomes.max_attempts > 0) otherPills.push('<span class="outcome-pill">Max Attempts: ' + outcomes.max_attempts + '</span>');
    if (outcomes.invalid > 0) otherPills.push('<span class="outcome-pill">Invalid: ' + outcomes.invalid + '</span>');
    if (outcomes.dnc > 0) otherPills.push('<span class="outcome-pill">DNC: ' + outcomes.dnc + '</span>');
    if (outcomes.inconclusive > 0) otherPills.push('<span class="outcome-pill">Inconclusive: ' + outcomes.inconclusive + '</span>');
    
    var otherSection = document.getElementById('analyticsOtherOutcomes');
    var otherPillsEl = document.getElementById('analyticsOtherPills');
    if (otherPills.length > 0) {
        otherSection.style.display = 'block';
        otherPillsEl.innerHTML = otherPills.join('');
    } else {
        otherSection.style.display = 'none';
    }
    
    // Helper function for date formatting
    function formatAnalyticsDate(dateStr) {
        if (!dateStr) return 'TBD';
        try {
            var date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        } catch (e) { return dateStr; }
    }
    
    function formatAnalyticsDateTime(dateStr) {
        if (!dateStr) return 'TBD';
        try {
            var date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' });
        } catch (e) { return dateStr; }
    }
    
    // Render booked table (clickable rows)
    var bookedSection = document.getElementById('analyticsBookedSection');
    var bookedTable = document.getElementById('analyticsBookedTable');
    if (bookedLeads.length > 0) {
        bookedSection.style.display = 'block';
        bookedTable.innerHTML = bookedLeads.map(function(l) {
            return '<tr class="analytics-lead-row" data-lead-id="' + l.leadId + '" style="cursor:pointer;"><td>' + l.name + '</td><td>' + l.phone + '</td><td title="' + l.summary.replace(/"/g, '&quot;') + '">' + l.summary + '</td><td>' + formatAnalyticsDateTime(l.meetingTime) + '</td></tr>';
        }).join('');
    } else {
        bookedSection.style.display = 'none';
    }
    
    // Render interested table (clickable rows)
    var interestedSection = document.getElementById('analyticsInterestedSection');
    var interestedTable = document.getElementById('analyticsInterestedTable');
    if (interestedLeads.length > 0) {
        interestedSection.style.display = 'block';
        interestedTable.innerHTML = interestedLeads.map(function(l) {
            return '<tr class="analytics-lead-row" data-lead-id="' + l.leadId + '" style="cursor:pointer;"><td>' + l.name + '</td><td>' + l.phone + '</td><td title="' + l.summary.replace(/"/g, '&quot;') + '">' + l.summary + '</td><td>' + formatAnalyticsDate(l.callbackDate) + '</td></tr>';
        }).join('');
    } else {
        interestedSection.style.display = 'none';
    }
    
    // Render timeline table (clickable rows)
    var timelineSection = document.getElementById('analyticsTimelineSection');
    var timelineTable = document.getElementById('analyticsTimelineTable');
    if (timelineLeads.length > 0) {
        timelineSection.style.display = 'block';
        timelineTable.innerHTML = timelineLeads.map(function(l) {
            return '<tr class="analytics-lead-row" data-lead-id="' + l.leadId + '" style="cursor:pointer;"><td>' + l.name + '</td><td>' + l.phone + '</td><td title="' + l.summary.replace(/"/g, '&quot;') + '">' + l.summary + '</td><td>' + formatAnalyticsDate(l.callbackDate) + '</td></tr>';
        }).join('');
    } else {
        timelineSection.style.display = 'none';
    }
    
    // Add click handlers for analytics rows
    document.querySelectorAll('.analytics-lead-row').forEach(function(row) {
        row.addEventListener('click', function() {
            var leadId = this.dataset.leadId;
            if (leadId) {
                openLeadModalById(leadId);
            }
        });
    });
    
    // Active pipeline (all non-closed leads)
    var activeStatuses = ['NEW', 'RETRY', 'Callback', 'Timeline', 'Follow Up', 'Interested'];
    var activePipeline = allLeads.filter(function(l) {
        var s = l.fields['Status'] || '';
        return activeStatuses.indexOf(s) !== -1 || activeStatuses.map(function(x) { return x.toLowerCase(); }).indexOf(s.toLowerCase()) !== -1;
    }).length;
    document.getElementById('analyticsActivePipeline').textContent = activePipeline;
}

// Open lead modal by ID (for analytics)
function openLeadModalById(leadId) {
    console.log('openLeadModalById called with:', leadId);
    var leadIndex = allLeads.findIndex(function(l) { return l.id === leadId; });
    console.log('Found lead at index:', leadIndex);
    if (leadIndex >= 0) {
        // Find in filtered leads too
        var filteredIndex = filteredLeads.findIndex(function(l) { return l.id === leadId; });
        if (filteredIndex >= 0) {
            openLeadModal(filteredIndex);
        } else {
            // Open directly with the lead data
            currentLeadId = leadId;
            var lead = allLeads[leadIndex];
            var f = lead.fields;
            var leadName = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Lead';
            document.getElementById('modalLeadName').textContent = leadName;
            document.getElementById('modalPhone').textContent = formatPhone(f['Phone #']);
            var statusEl = document.getElementById('modalStatus');
            var status = f['Status'] || '-';
            statusEl.textContent = status;
            statusEl.className = 'status-badge ' + getStatusClass(status);
            document.getElementById('modalLastCalled').textContent = formatDateTime(getMostRecentLastCalled(f));
            var hasBookedTime = !!f['Booked Time'];
            document.getElementById('modalBookedTime').innerHTML = hasBookedTime ? formatDateTime(f['Booked Time']) + ' <button class="btn-delete-booking-modal" onclick="deleteBookingFromModal()" title="Remove booking"></button>' : '';
            document.getElementById('modalBookedTime').style.display = hasBookedTime ? 'block' : 'none';
            document.getElementById('modalScheduleBtn').style.display = hasBookedTime ? 'none' : 'block';
            document.getElementById('editBookedTimeBtn').style.display = hasBookedTime ? 'inline' : 'none';
            document.getElementById('modalCallSummary').textContent = f['Last Call Summary'] || 'No summary available';
            var notesData = f['Client Notes'] || '';
            updateClientNotes(notesData, true);
            document.getElementById('agentNotesInput').value = '';
            editingNoteIndex = -1;
            updatePrioButton(f['Is Prio']);
            updateClientAttempts(f['Client Attempts'] || [], true);
            updateModalShareInfo(lead);
            document.getElementById('modalTranscript').textContent = f['Last Call Transcript'] || 'No transcript available';
            document.getElementById('leadModal').classList.add('active');
        }
    }
}

// Analytics period tab handlers
function showAnalyticsPicker(period) {
    var dateDisplay = document.getElementById('analyticsDateDisplay');
    var weekPicker = document.getElementById('analyticsWeekPicker');
    var monthPicker = document.getElementById('analyticsMonthPicker');
    var allTimeLabel = document.getElementById('analyticsAllTimeLabel');
    var calendarPopup = document.getElementById('analyticsCalendarPopup');
    
    dateDisplay.style.display = period === 'daily' ? 'flex' : 'none';
    weekPicker.style.display = period === 'weekly' ? 'block' : 'none';
    monthPicker.style.display = period === 'monthly' ? 'block' : 'none';
    allTimeLabel.style.display = period === 'all' ? 'inline' : 'none';
    if (calendarPopup) calendarPopup.style.display = 'none';
}

// Analytics calendar state
var analyticsCalendarDate = new Date();
var analyticsSelectedDate = new Date();
var analyticsDatesWithData = new Set();

function formatFriendlyDate(date) {
    return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
}

function toggleAnalyticsCalendar() {
    var popup = document.getElementById('analyticsCalendarPopup');
    if (popup.style.display === 'none' || popup.style.display === '') {
        popup.style.display = 'block';
        analyticsCalendarDate = new Date(analyticsSelectedDate.getFullYear(), analyticsSelectedDate.getMonth(), 1);
        renderAnalyticsCalendar();
    } else {
        popup.style.display = 'none';
    }
}

async function buildDatesWithData() {
    // Get all calls to find dates with data
    var allCalls = await fetchAnalyticsCalls();
    analyticsDatesWithData.clear();
    allCalls.forEach(function(c) {
        var ts = c.fields['Timestamp'];
        if (ts) {
            var dateStr = ts.split('T')[0];
            analyticsDatesWithData.add(dateStr);
        }
    });
}

function renderAnalyticsCalendar() {
    var year = analyticsCalendarDate.getFullYear();
    var month = analyticsCalendarDate.getMonth();
    var today = new Date();
    today.setHours(0, 0, 0, 0);
    
    document.getElementById('analyticsCalMonthYear').textContent = 
        analyticsCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    
    var firstDay = new Date(year, month, 1).getDay();
    var daysInMonth = new Date(year, month + 1, 0).getDate();
    var daysInPrevMonth = new Date(year, month, 0).getDate();
    
    var html = '';
    
    // Previous month days
    for (var i = firstDay - 1; i >= 0; i--) {
        var day = daysInPrevMonth - i;
        html += '<div style="padding:10px;text-align:center;color:var(--text-muted);opacity:0.4;font-size:0.875rem;">' + day + '</div>';
    }
    
    // Current month days
    for (var d = 1; d <= daysInMonth; d++) {
        var date = new Date(year, month, d);
        var dateStr = date.toISOString().split('T')[0];
        var isToday = date.getTime() === today.getTime();
        var isSelected = analyticsSelectedDate && date.toDateString() === analyticsSelectedDate.toDateString();
        var isFuture = date > today;
        var hasData = analyticsDatesWithData.has(dateStr);
        
        var style = 'padding:10px;text-align:center;border-radius:8px;font-size:0.875rem;transition:all 0.2s;';
        
        if (isFuture || !hasData) {
            // Future or no data - disabled
            style += 'color:var(--text-muted);opacity:0.3;cursor:not-allowed;';
            html += '<div style="' + style + '">' + d + '</div>';
        } else {
            // Has data - clickable
            if (isSelected) {
                style += 'background:var(--accent);color:white;cursor:pointer;font-weight:600;';
            } else if (isToday) {
                style += 'background:rgba(59,130,246,0.2);color:var(--accent);cursor:pointer;font-weight:600;';
            } else {
                style += 'background:var(--bg-secondary);color:var(--text-primary);cursor:pointer;';
            }
            html += '<div class="analytics-cal-day" data-date="' + dateStr + '" style="' + style + '">' + d + '</div>';
        }
    }
    
    // Next month days
    var totalCells = firstDay + daysInMonth;
    var remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
    for (var n = 1; n <= remaining; n++) {
        html += '<div style="padding:10px;text-align:center;color:var(--text-muted);opacity:0.4;font-size:0.875rem;">' + n + '</div>';
    }
    
    document.getElementById('analyticsCalDays').innerHTML = html;
    
    // Add click handlers
    document.querySelectorAll('.analytics-cal-day').forEach(function(el) {
        el.addEventListener('click', function() {
            analyticsSelectedDate = new Date(this.dataset.date + 'T12:00:00');
            document.getElementById('analyticsDatePicker').value = this.dataset.date;
            document.getElementById('analyticsDateText').textContent = formatFriendlyDate(analyticsSelectedDate);
            document.getElementById('analyticsCalendarPopup').style.display = 'none';
            updateAnalytics();
        });
        el.addEventListener('mouseenter', function() {
            if (!this.style.background.includes('var(--accent)')) {
                this.style.background = 'var(--bg-tertiary)';
            }
        });
        el.addEventListener('mouseleave', function() {
            if (!this.style.background.includes('var(--accent)')) {
                this.style.background = 'var(--bg-secondary)';
            }
        });
    });
}

// Initialize date pickers with dropdown options
(async function initAnalyticsPickers() {
    var now = new Date();
    var datePicker = document.getElementById('analyticsDatePicker');
    var dateText = document.getElementById('analyticsDateText');
    var weekPicker = document.getElementById('analyticsWeekPicker');
    var monthPicker = document.getElementById('analyticsMonthPicker');
    
    // Set date picker to today
    datePicker.value = now.toISOString().split('T')[0];
    analyticsSelectedDate = now;
    dateText.textContent = formatFriendlyDate(now);
    
    // Build dates with data
    await buildDatesWithData();
    
    // Add calendar navigation handlers
    document.getElementById('analyticsCalPrev').addEventListener('click', function() {
        analyticsCalendarDate.setMonth(analyticsCalendarDate.getMonth() - 1);
        renderAnalyticsCalendar();
    });
    
    document.getElementById('analyticsCalNext').addEventListener('click', function() {
        analyticsCalendarDate.setMonth(analyticsCalendarDate.getMonth() + 1);
        renderAnalyticsCalendar();
    });
    
    // Close calendar when clicking outside
    document.addEventListener('click', function(e) {
        var popup = document.getElementById('analyticsCalendarPopup');
        var display = document.getElementById('analyticsDateDisplay');
        if (popup && !popup.contains(e.target) && !display.contains(e.target)) {
            popup.style.display = 'none';
        }
    });
    
    // Populate week dropdown (from Dec 2025 to now)
    weekPicker.innerHTML = '';
    var startWeekDate = new Date(2025, 11, 1); // Dec 1, 2025
    var currentDate = new Date(startWeekDate);
    var weeks = [];
    
    while (currentDate <= now) {
        // Get Monday of this week
        var dayOfWeek = currentDate.getDay();
        var mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
        var monday = new Date(currentDate);
        monday.setDate(monday.getDate() + mondayOffset);
        var sunday = new Date(monday);
        sunday.setDate(sunday.getDate() + 6);
        
        var weekLabel = monday.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' - ' + 
                       sunday.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        var weekValue = monday.toISOString().split('T')[0];
        
        // Avoid duplicates
        if (!weeks.find(function(w) { return w.value === weekValue; })) {
            weeks.push({ value: weekValue, label: weekLabel });
        }
        currentDate.setDate(currentDate.getDate() + 7);
    }
    
    // Reverse so most recent is first
    weeks.reverse();
    weeks.forEach(function(w) {
        var opt = document.createElement('option');
        opt.value = w.value;
        opt.textContent = w.label;
        weekPicker.appendChild(opt);
    });
    
    // Populate month dropdown (from Dec 2025 to now)
    monthPicker.innerHTML = '';
    var months = [];
    var monthDate = new Date(2025, 11, 1); // Dec 2025
    while (monthDate <= now) {
        var monthLabel = monthDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        var monthValue = monthDate.getFullYear() + '-' + String(monthDate.getMonth() + 1).padStart(2, '0');
        months.push({ value: monthValue, label: monthLabel });
        monthDate.setMonth(monthDate.getMonth() + 1);
    }
    
    // Reverse so most recent is first
    months.reverse();
    months.forEach(function(m) {
        var opt = document.createElement('option');
        opt.value = m.value;
        opt.textContent = m.label;
        monthPicker.appendChild(opt);
    });
    
    // Show only date picker initially (daily is default)
    showAnalyticsPicker('daily');
})();

document.querySelectorAll('.analytics-period-tab').forEach(function(tab) {
    tab.addEventListener('click', function() {
        var period = this.dataset.period;
        window.location.hash = 'analytics-' + period;
        document.querySelectorAll('.analytics-period-tab').forEach(function(t) { t.classList.remove('active'); });
        this.classList.add('active');
        currentAnalyticsPeriod = period;
        showAnalyticsPicker(currentAnalyticsPeriod);
        updateAnalytics();
    });
});

// Add event listeners for date pickers
document.getElementById('analyticsDatePicker').addEventListener('change', updateAnalytics);
document.getElementById('analyticsWeekPicker').addEventListener('change', updateAnalytics);
document.getElementById('analyticsMonthPicker').addEventListener('change', updateAnalytics);

function openLeadModal(index) {
    if (index < 0 || index >= filteredLeads.length) return;
    currentLeadIndex = index;
    currentPrioIndex = -1; // Not from PRIO leads
    var lead = filteredLeads[index];
    currentLeadId = lead.id;
    
    // Update URL with lead ID
    window.history.pushState(null, '', '#lead-' + lead.id);
    
    var f = lead.fields;
    var leadName = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Lead';
    document.getElementById('modalLeadName').textContent = leadName;
    document.getElementById('modalPhone').textContent = formatPhone(f['Phone #']);
    
    // Status with badge styling
    var statusEl = document.getElementById('modalStatus');
    var status = f['Status'] || '-';
    statusEl.textContent = status;
    statusEl.className = 'status-badge ' + getStatusClass(status);
    
    document.getElementById('modalLastCalled').textContent = formatDateTime(getMostRecentLastCalled(f));
    
    // Update booked time display
    var hasBookedTime = !!f['Booked Time'];
    document.getElementById('modalBookedTime').innerHTML = hasBookedTime ? formatDateTime(f['Booked Time']) + ' <button class="btn-delete-booking-modal" onclick="deleteBookingFromModal()" title="Remove booking"></button>' : '';
    document.getElementById('modalBookedTime').style.display = hasBookedTime ? 'block' : 'none';
    document.getElementById('modalScheduleBtn').style.display = hasBookedTime ? 'none' : 'block';
    document.getElementById('editBookedTimeBtn').style.display = hasBookedTime ? 'inline' : 'none';
    
    document.getElementById('modalCallSummary').textContent = f['Last Call Summary'] || 'No summary available';
    
    // Handle notes as array
    var notesData = f['Client Notes'] || '';
    updateClientNotes(notesData, true);
    document.getElementById('agentNotesInput').value = '';
    editingNoteIndex = -1;
    
    // Update PRIO button state
    updatePrioButton(f['Is Prio']);
    
    // Update client call attempts
    updateClientAttempts(f['Client Attempts'] || [], true);
    
    // Update sharing info in modal
    updateModalShareInfo(lead);
    
    // Format transcript with name replacement
    var transcript = f['Transcript (from Calls)'] || '';
    if (Array.isArray(transcript)) transcript = transcript.join('\n\n---\n\n');
    document.getElementById('modalTranscript').innerHTML = formatTranscript(transcript, leadName) || 'No transcript available';
    
    var prevBtn = document.getElementById('modalPrev');
    var nextBtn = document.getElementById('modalNext');
    prevBtn.style.display = 'flex';
    nextBtn.style.display = 'flex';
    prevBtn.disabled = index === 0;
    nextBtn.disabled = index === filteredLeads.length - 1;
    document.getElementById('leadModal').classList.add('active');
    document.body.style.overflow = 'hidden';
}

// Update sharing info displayed in modal header
function updateModalShareInfo(lead) {
    var shareInfoEl = document.getElementById('modalShareInfo');
    var shareTextEl = document.getElementById('modalShareText');
    var shareEditBtn = document.getElementById('modalShareEditBtn');
    var f = lead.fields;
    
    var sharedWithEmailRaw = f['Shared With Email'];
    var sharedWithEmail = Array.isArray(sharedWithEmailRaw) ? (sharedWithEmailRaw[0] || '') : (sharedWithEmailRaw || '');
    
    // Reset classes and always show
    shareInfoEl.className = 'modal-share-info';
    shareInfoEl.style.display = 'flex';
    
    if (lead.isShared) {
        // Lead is shared WITH current user - show who shared it
        var ownerEmails = f['Client Email'] || [];
        var ownerEmail = Array.isArray(ownerEmails) ? ownerEmails[0] : ownerEmails;
        var ownerName = getAgentNameByEmail(ownerEmail) || 'Another agent';
        
        shareInfoEl.classList.add('shared-with-me');
        shareTextEl.innerHTML = ' Shared with you by <strong>' + ownerName + '</strong>';
        shareEditBtn.style.display = 'none';
        shareInfoEl.onclick = null;
        shareInfoEl.style.cursor = 'default';
    } else if (sharedWithEmail) {
        // Current user owns this lead and shared it
        var sharedAgentName = getAgentNameByEmail(sharedWithEmail);
        
        shareTextEl.innerHTML = ' Shared with <strong>' + sharedAgentName + '</strong>';
        shareEditBtn.style.display = 'inline-block';
        shareEditBtn.textContent = '';
        shareEditBtn.onclick = function(e) {
            e.stopPropagation();
            openShareInfoPopup(lead.id, true, sharedWithEmail, shareEditBtn);
        };
        shareInfoEl.onclick = null;
        shareInfoEl.style.cursor = 'default';
    } else {
        // Not shared - show option to share (only if user owns the prospect)
        shareInfoEl.classList.add('not-shared');
        shareTextEl.innerHTML = ' Share this prospect with another agent';
        shareEditBtn.style.display = 'none';
        shareInfoEl.style.cursor = 'pointer';
        shareInfoEl.onclick = function() {
            openSharePopup(lead.id, shareInfoEl);
        };
    }
}

// Format transcript - replace Agent/User and add styling
function formatTranscript(text, leadName) {
    if (!text) return '';
    return text
        .replace(/^Agent:/gm, '<span class="transcript-name transcript-ai">Prio AI:</span>')
        .replace(/^User:/gm, '<span class="transcript-name">' + leadName + ':</span>');
}

function hasUnsavedChanges() {
    var currentNoteText = document.getElementById('agentNotesInput').value.trim();
    return currentNoteText !== '';
}

function closeModal() {
    document.getElementById('leadModal').classList.remove('active');
    document.getElementById('modalPrev').style.display = 'none';
    document.getElementById('modalNext').style.display = 'none';
    document.getElementById('modalShareInfo').style.display = 'none';
    document.getElementById('modalShareInfo').className = 'modal-share-info';
    document.body.style.overflow = '';
    currentLeadId = null;
    currentLeadIndex = -1;
    originalClientAttempts = [];
    originalClientNotes = [];
    editingNoteIndex = -1;
    
    // Clear lead hash from URL
    if (window.location.hash.startsWith('#lead-')) {
        window.history.pushState(null, '', window.location.pathname);
    }
}

function tryCloseModal() {
    if (hasUnsavedChanges()) document.getElementById('confirmCloseModal').classList.add('active');
    else closeModal();
}

document.getElementById('modalClose').addEventListener('click', tryCloseModal);
document.getElementById('leadModal').addEventListener('click', function(e) { if (e.target === this) tryCloseModal(); });

document.getElementById('confirmDiscard').addEventListener('click', function() {
    document.getElementById('confirmCloseModal').classList.remove('active');
    // Just close without saving the unsaved note
    closeModal();
});

document.getElementById('confirmKeepEditing').addEventListener('click', function() {
    document.getElementById('confirmCloseModal').classList.remove('active');
});

document.getElementById('confirmSaveClose').addEventListener('click', async function() {
    document.getElementById('confirmCloseModal').classList.remove('active');
    await saveCurrentNote();
    closeModal();
});

document.getElementById('confirmCloseModal').addEventListener('click', function(e) {
    if (e.target === this) this.classList.remove('active');
});

document.getElementById('modalPrev').addEventListener('click', function() {
    if (hasUnsavedChanges()) { showToast('Please save your note first', 'warning'); return; }
    
    // Check if navigating PRIO leads
    if (currentPrioIndex >= 0) {
        if (currentPrioIndex > 0) {
            openPrioLeadModal(currentPrioIndex - 1);
        }
    } else if (currentLeadIndex > 0) {
        openLeadModal(currentLeadIndex - 1);
    }
});
document.getElementById('modalNext').addEventListener('click', function() {
    if (hasUnsavedChanges()) { showToast('Please save your note first', 'warning'); return; }
    
    // Check if navigating PRIO leads
    if (currentPrioIndex >= 0) {
        if (currentPrioIndex < filteredPrioLeads.length - 1) {
            openPrioLeadModal(currentPrioIndex + 1);
        }
    } else if (currentLeadIndex < filteredLeads.length - 1) {
        openLeadModal(currentLeadIndex + 1);
    }
});

document.getElementById('sendBackToAIBtn').addEventListener('click', function() {
    // No longer requires notes - just open the modal
    openFollowupModal();
});

// Calendar state
var calendarDate = new Date();
var selectedDate = null;
var selectedTime = 'afternoon'; // default
var selectedReason = null;
var selectedPeriod = null;

function openFollowupModal() {
    // Reset selections
    selectedReason = null;
    selectedPeriod = null;
    selectedTime = 'afternoon';
    selectedDate = null;
    
    // Reset UI - remove selected class from all
    document.querySelectorAll('.followup-reason-btn').forEach(function(btn) {
        btn.classList.remove('selected');
    });
    document.querySelectorAll('.followup-period-btn').forEach(function(btn) {
        btn.classList.remove('selected');
    });
    document.querySelectorAll('.followup-time-btn').forEach(function(btn) {
        if (btn.dataset.time === 'afternoon') {
            btn.classList.add('selected');
        } else {
            btn.classList.remove('selected');
        }
    });
    
    document.getElementById('followupCalendarSection').style.display = 'none';
    document.getElementById('followupError').textContent = '';
    document.getElementById('followupModal').classList.add('active');
    
    // Add event listeners for reason buttons
    document.querySelectorAll('.followup-reason-btn').forEach(function(btn) {
        btn.onclick = function() {
            selectedReason = this.dataset.reason;
            document.querySelectorAll('.followup-reason-btn').forEach(function(b) {
                b.classList.remove('selected');
            });
            this.classList.add('selected');
        };
    });
    
    // Add event listeners for period buttons
    document.querySelectorAll('.followup-period-btn').forEach(function(btn) {
        btn.onclick = function() {
            selectedPeriod = this.dataset.months;
            document.querySelectorAll('.followup-period-btn').forEach(function(b) {
                b.classList.remove('selected');
            });
            this.classList.add('selected');
            
            // Show/hide calendar based on selection
            if (selectedPeriod === 'custom') {
                document.getElementById('followupCalendarSection').style.display = 'block';
                var tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                calendarDate = new Date(tomorrow.getFullYear(), tomorrow.getMonth(), 1);
                selectedDate = tomorrow;
                renderFollowupCalendar();
            } else {
                document.getElementById('followupCalendarSection').style.display = 'none';
                selectedDate = null;
            }
        };
    });
    
    // Add event listeners for time buttons
    document.querySelectorAll('.followup-time-btn').forEach(function(btn) {
        btn.onclick = function() {
            selectedTime = this.dataset.time;
            document.querySelectorAll('.followup-time-btn').forEach(function(b) {
                b.classList.remove('selected');
            });
            this.classList.add('selected');
        };
    });
}

function renderFollowupCalendar() {
    var year = calendarDate.getFullYear();
    var month = calendarDate.getMonth();
    var today = new Date();
    today.setHours(0, 0, 0, 0);
    
    document.getElementById('followupCalendarMonthYear').textContent = 
        calendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    
    var firstDay = new Date(year, month, 1).getDay();
    var daysInMonth = new Date(year, month + 1, 0).getDate();
    var daysInPrevMonth = new Date(year, month, 0).getDate();
    
    var html = '';
    
    // Previous month days
    for (var i = firstDay - 1; i >= 0; i--) {
        var day = daysInPrevMonth - i;
        html += '<div class="calendar-day other-month disabled">' + day + '</div>';
    }
    
    // Current month days
    for (var d = 1; d <= daysInMonth; d++) {
        var date = new Date(year, month, d);
        var isToday = date.getTime() === today.getTime();
        var isPast = date <= today; // Include today as disabled - only future dates allowed
        var isSelected = selectedDate && date.toDateString() === selectedDate.toDateString();
        
        var classes = 'calendar-day';
        if (isToday) classes += ' today';
        if (isPast) classes += ' disabled';
        if (isSelected && !isPast) classes += ' selected';
        
        html += '<div class="' + classes + '" data-date="' + date.toISOString() + '">' + d + '</div>';
    }
    
    // Next month days
    var totalCells = firstDay + daysInMonth;
    var remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
    for (var n = 1; n <= remaining; n++) {
        html += '<div class="calendar-day other-month disabled">' + n + '</div>';
    }
    
    document.getElementById('followupCalendarDays').innerHTML = html;
    
    // Add click handlers
    document.querySelectorAll('#followupCalendarDays .calendar-day:not(.disabled)').forEach(function(el) {
        el.addEventListener('click', function() {
            selectedDate = new Date(this.dataset.date);
            renderFollowupCalendar();
        });
    });
}

function updateTimeSelection() {
    document.querySelectorAll('.time-option').forEach(function(btn) {
        btn.classList.toggle('selected', btn.dataset.time === selectedTime);
    });
}

document.getElementById('followupCalendarPrev').addEventListener('click', function() {
    calendarDate.setMonth(calendarDate.getMonth() - 1);
    renderFollowupCalendar();
});

document.getElementById('followupCalendarNext').addEventListener('click', function() {
    calendarDate.setMonth(calendarDate.getMonth() + 1);
    renderFollowupCalendar();
});

function closeFollowupModal() { document.getElementById('followupModal').classList.remove('active'); }

async function confirmFollowup() {
    if (!currentLeadId) return;
    
    var errorEl = document.getElementById('followupError');
    
    // Validate selections
    if (!selectedReason) { errorEl.textContent = 'Please select a reason'; return; }
    if (!selectedPeriod) { errorEl.textContent = 'Please select when AI should call back'; return; }
    if (selectedPeriod === 'custom' && !selectedDate) { errorEl.textContent = 'Please select a date'; return; }
    
    // Calculate the scheduled date
    var scheduledDate;
    if (selectedPeriod === 'custom') {
        scheduledDate = new Date(selectedDate);
    } else {
        scheduledDate = new Date();
        scheduledDate.setMonth(scheduledDate.getMonth() + parseInt(selectedPeriod));
    }
    
    // Set time based on selection
    var hours = { morning: 9, afternoon: 13, evening: 17 };
    scheduledDate.setHours(hours[selectedTime], 0, 0, 0);
    
    // Map reason to a note
    var reasonTexts = {
        'no_longer_interested': 'Client no longer interested - sent back for long-term follow-up',
        'did_not_pickup': 'Client did not pick up - sent back for follow-up',
        'stopped_responding': 'Client stopped responding - sent back for follow-up'
    };
    
    // Add reason as a note
    if (!window.currentClientNotes) window.currentClientNotes = [];
    window.currentClientNotes.push({ time: new Date().toISOString(), text: reasonTexts[selectedReason] });
    
    // Save any unsaved note in textarea
    var unsavedNote = document.getElementById('agentNotesInput').value.trim();
    if (unsavedNote) {
        window.currentClientNotes.push({ time: new Date().toISOString(), text: unsavedNote });
    }
    
    var notesJson = JSON.stringify(window.currentClientNotes || []);
    var btn = document.getElementById('followupConfirm');
    
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span>Sending...';
    try {
        var response = await fetch('https://api.airtable.com/v0/' + AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + currentLeadId, {
            method: 'PATCH',
            headers: { 'Authorization': 'Bearer ' + AIRTABLE_TOKEN, 'Content-Type': 'application/json' },
            body: JSON.stringify({ fields: { 'Status': 'Follow Up', 'Next Call Date': scheduledDate.toISOString(), 'Client Notes': notesJson }})
        });
        if (response.ok) {
            btn.textContent = ' Sent!';
            btn.style.background = '#22C55E';
            setTimeout(function() { 
                closeFollowupModal(); 
                closeModal(); 
                btn.textContent = 'Send to AI'; 
                btn.style.background = ''; 
                btn.disabled = false; 
                fetchAllLeads().then(function() {
                    renderPrio();
                }); 
            }, 1500);
        } else throw new Error('Failed');
    } catch (err) { errorEl.textContent = 'Error. Please try again.'; btn.disabled = false; btn.textContent = 'Send to AI'; }
}

document.getElementById('followupCancel').addEventListener('click', closeFollowupModal);
document.getElementById('followupConfirm').addEventListener('click', confirmFollowup);
document.getElementById('followupModal').addEventListener('click', function(e) { if (e.target === this) closeFollowupModal(); });

document.getElementById('displayForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    var btn = document.getElementById('saveDisplayBtn');
    var successEl = document.getElementById('displaySuccess');
    var errorEl = document.getElementById('displayError');
    var displayName = document.getElementById('settingsDisplayName').value.trim();
    successEl.textContent = ''; errorEl.textContent = '';
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span>Saving...';
    try {
        var result = await supabase.auth.updateUser({ data: { display_name: displayName } });
        if (result.error) throw result.error;
        updateUserUI(result.data.user);
        successEl.textContent = 'Saved!';
        successEl.classList.add('visible');
    } catch (err) { errorEl.textContent = err.message || 'Error saving.'; errorEl.classList.add('visible'); }
    btn.disabled = false;
    btn.textContent = 'Save';
});

document.getElementById('settingsForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    if (!currentUserRecord) return;
    var btn = document.getElementById('saveSettingsBtn');
    var successEl = document.getElementById('settingsSuccess');
    var errorEl = document.getElementById('settingsError');
    successEl.textContent = ''; errorEl.textContent = '';
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span>Saving...';
    try {
        var response = await fetch('https://api.airtable.com/v0/' + AIRTABLE_BASE + '/' + AIRTABLE_CLIENTS_TABLE + '/' + currentUserRecord.id, {
            method: 'PATCH',
            headers: { 'Authorization': 'Bearer ' + AIRTABLE_TOKEN, 'Content-Type': 'application/json' },
            body: JSON.stringify({ fields: { 'Phone': document.getElementById('settingsPhone').value, 'Google Calendar Email': document.getElementById('settingsCalendar').value, 'Available Start': document.getElementById('settingsStart').value, 'Available End': document.getElementById('settingsEnd').value }})
        });
        if (response.ok) { successEl.textContent = 'Saved!'; successEl.classList.add('visible'); }
        else throw new Error('Failed');
    } catch (err) { errorEl.textContent = 'Error saving.'; errorEl.classList.add('visible'); }
    btn.disabled = false;
    btn.textContent = 'Save Changes';
});

document.getElementById('passwordForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    var newPass = document.getElementById('newPassword').value;
    var confirmPass = document.getElementById('confirmNewPassword').value;
    var successEl = document.getElementById('passwordSuccess');
    var errorEl = document.getElementById('passwordError');
    var btn = document.getElementById('changePasswordBtn');
    successEl.textContent = ''; errorEl.textContent = '';
    if (newPass !== confirmPass) { errorEl.textContent = 'Passwords do not match'; errorEl.classList.add('visible'); return; }
    if (newPass.length < 8) { errorEl.textContent = 'Minimum 8 characters'; errorEl.classList.add('visible'); return; }
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span>Updating...';
    try {
        var result = await supabase.auth.updateUser({ password: newPass });
        if (result.error) throw result.error;
        successEl.textContent = 'Password updated!';
        successEl.classList.add('visible');
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmNewPassword').value = '';
    } catch (err) { errorEl.textContent = err.message || 'Error'; errorEl.classList.add('visible'); }
    btn.disabled = false;
    btn.textContent = 'Update Password';
});

document.getElementById('feedbackForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    var type = document.getElementById('feedbackType').value;
    var message = document.getElementById('feedbackMessage').value;
    var successEl = document.getElementById('feedbackSuccess');
    var errorEl = document.getElementById('feedbackError');
    var btn = document.getElementById('submitFeedbackBtn');
    if (!type) { errorEl.textContent = 'Please select a type'; errorEl.classList.add('visible'); return; }
    successEl.textContent = ''; errorEl.textContent = '';
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span>Sending...';
    try {
        await fetch('https://n8n.prioai.ca/webhook/feedback', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ type, message, email: currentUserEmail, name: currentUserRecord?.fields['Agent Name'] || 'Unknown', timestamp: new Date().toISOString() }) });
        successEl.textContent = ' Feedback sent! Thank you.';
        successEl.classList.add('visible');
        document.getElementById('feedbackMessage').value = '';
        document.getElementById('feedbackType').value = '';
        document.querySelectorAll('.feedback-type').forEach(function(t) { t.classList.remove('selected'); });
    } catch (err) { window.location.href = 'mailto:info@prioai.ca?subject=' + encodeURIComponent('[' + type + '] Feedback') + '&body=' + encodeURIComponent(message); }
    btn.disabled = false;
    btn.textContent = 'Send Feedback';
});

// === IMPORT LEADS TAB SWITCHING ===
document.querySelectorAll('.import-tab').forEach(function(tab) {
    tab.addEventListener('click', function() {
        document.querySelectorAll('.import-tab').forEach(function(t) { t.classList.remove('active'); });
        document.querySelectorAll('.import-panel').forEach(function(p) { p.classList.remove('active'); });
        this.classList.add('active');
        var panelId = this.dataset.import === 'single' ? 'importSingle' : 'importBulk';
        document.getElementById(panelId).classList.add('active');
    });
});

// === SINGLE LEAD IMPORT ===
function validateCanadianPhone(phone) {
    var cleaned = phone.replace(/\D/g, '');
    if (cleaned.length === 11 && cleaned[0] === '1') cleaned = cleaned.slice(1);
    return cleaned.length === 10;
}

function formatPhoneForAirtable(phone) {
    var cleaned = phone.replace(/\D/g, '');
    if (cleaned.length === 11 && cleaned[0] === '1') cleaned = cleaned.slice(1);
    return '+1' + cleaned;
}

document.getElementById('submitSingleLeadBtn').addEventListener('click', async function() {
    var btn = this;
    var firstName = document.getElementById('singleLeadFirstName').value.trim();
    var lastName = document.getElementById('singleLeadLastName').value.trim();
    var phone = document.getElementById('singleLeadPhone').value.trim();
    var interest = document.getElementById('singleLeadInterest').value;
    var email = document.getElementById('singleLeadEmail').value.trim();
    var maxAttempts = document.getElementById('singleLeadMaxAttempts').value;
    
    var successEl = document.getElementById('singleLeadSuccess');
    var errorEl = document.getElementById('singleLeadError');
    successEl.textContent = ''; successEl.classList.remove('visible');
    errorEl.textContent = ''; errorEl.classList.remove('visible');
    
    // Reset errors
    document.querySelectorAll('.single-lead-form .form-error-msg').forEach(function(el) { el.classList.remove('visible'); });
    document.querySelectorAll('.single-lead-form input').forEach(function(el) { el.classList.remove('error'); });
    
    // Validation
    var hasError = false;
    if (!firstName) {
        document.getElementById('singleLeadFirstName').classList.add('error');
        document.getElementById('singleLeadFirstNameError').classList.add('visible');
        hasError = true;
    }
    if (!phone || !validateCanadianPhone(phone)) {
        document.getElementById('singleLeadPhone').classList.add('error');
        document.getElementById('singleLeadPhoneError').classList.add('visible');
        hasError = true;
    }
    if (!interest) {
        document.getElementById('singleLeadInterestError').classList.add('visible');
        hasError = true;
    }
    
    if (hasError) return;
    
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Adding Lead...';
    
    try {
        var fields = {
            'First Name': firstName,
            'Phone #': formatPhoneForAirtable(phone),
            'Interest': interest,
            'Status': 'New',
            'Client Email': [currentUserEmail]
        };
        
        if (lastName) fields['Last Name'] = lastName;
        if (email) fields['Email'] = email;
        if (maxAttempts) fields['Max Attempts'] = parseInt(maxAttempts);
        
        var response = await fetch('https://api.airtable.com/v0/' + AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE, {
            method: 'POST',
            headers: { 
                'Authorization': 'Bearer ' + AIRTABLE_TOKEN,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ fields: fields })
        });
        
        if (!response.ok) {
            var errData = await response.json();
            throw new Error(errData.error?.message || 'Failed to add lead');
        }
        
        successEl.textContent = ' Lead added successfully! The AI will start calling soon.';
        successEl.classList.add('visible');
        
        // Clear form
        document.getElementById('singleLeadFirstName').value = '';
        document.getElementById('singleLeadLastName').value = '';
        document.getElementById('singleLeadPhone').value = '';
        document.getElementById('singleLeadInterest').value = '';
        document.getElementById('singleLeadEmail').value = '';
        document.getElementById('singleLeadMaxAttempts').value = '';
        
        // Refresh leads
        setTimeout(function() { fetchAllLeads().then(function() { renderPrio(); fetchDisplayedLeads(); }); }, 1500);
        
    } catch (err) {
        console.error('Error adding lead:', err);
        errorEl.textContent = ' ' + (err.message || 'Failed to add lead. Please try again.');
        errorEl.classList.add('visible');
    }
    
    btn.disabled = false;
    btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px;"><path d="M12 5v14M5 12h14"/></svg> Add Lead';
});

// === SHARE LEAD FUNCTIONALITY ===
var shareableAgents = [];
var allActiveAgents = [];
var currentShareLeadId = null;

// Fetch ALL active agents for name lookups
async function fetchAllActiveAgents() {
    if (allActiveAgents.length > 0) return allActiveAgents;
    
    try {
        var filterFormula = '{Status}="Active"';
        var url = 'https://api.airtable.com/v0/' + AIRTABLE_BASE + '/' + AIRTABLE_CLIENTS_TABLE + '?filterByFormula=' + encodeURIComponent(filterFormula);
        var response = await fetch(url, { headers: { 'Authorization': 'Bearer ' + AIRTABLE_TOKEN } });
        var data = await response.json();
        
        if (data.records) {
            allActiveAgents = data.records.map(function(r) {
                return {
                    id: r.id,
                    email: r.fields['Email'] || '',
                    name: r.fields['Agent Name'] || r.fields['Email'] || 'Unknown'
                };
            }).filter(function(a) { return a.email; });
        }
    } catch (err) {
        console.error('Error fetching all agents:', err);
    }
    
    return allActiveAgents;
}

// Fetch agents that current user is allowed to share with (based on "Can Share With" field)
async function fetchShareableAgents() {
    // Always refetch to get latest permissions
    shareableAgents = [];
    
    try {
        // Get allowed emails from current user's "Can Share With" field
        var canShareWith = currentUserRecord?.fields['Can Share With'] || '';
        if (!canShareWith.trim()) {
            // No one to share with
            return shareableAgents;
        }
        
        // Parse comma-separated emails and clean them up
        var allowedEmails = canShareWith.split(',').map(function(e) { 
            return e.trim().toLowerCase(); 
        }).filter(function(e) { return e; });
        
        if (allowedEmails.length === 0) {
            return shareableAgents;
        }
        
        // Use allActiveAgents if already fetched, otherwise fetch
        if (allActiveAgents.length === 0) {
            await fetchAllActiveAgents();
        }
        
        // Filter to only allowed agents
        shareableAgents = allActiveAgents.filter(function(a) { 
            return a.email && 
                   a.email.toLowerCase() !== currentUserEmail.toLowerCase() &&
                   allowedEmails.includes(a.email.toLowerCase()); 
        });
    } catch (err) {
        console.error('Error fetching agents:', err);
    }
    
    return shareableAgents;
}

function getAgentNameByEmail(email) {
    // Handle array (from Airtable linked records) or string
    if (Array.isArray(email)) email = email[0] || '';
    if (!email) return 'Unknown';
    
    // Look up in allActiveAgents first (contains all agents)
    var agent = allActiveAgents.find(function(a) { return a.email && a.email.toLowerCase() === email.toLowerCase(); });
    if (agent) return agent.name;
    
    // Fallback to shareableAgents
    agent = shareableAgents.find(function(a) { return a.email && a.email.toLowerCase() === email.toLowerCase(); });
    if (agent) return agent.name;
    
    // Last resort: extract name from email
    return email.split('@')[0];
}

async function openSharePopup(leadId, buttonEl) {
    // Close any existing popups first
    document.getElementById('shareLeadPopup').classList.remove('active');
    document.getElementById('shareInfoPopup').classList.remove('active');
    document.getElementById('sharePopupOverlay').classList.remove('active');
    
    currentShareLeadId = leadId;
    var popup = document.getElementById('shareLeadPopup');
    var overlay = document.getElementById('sharePopupOverlay');
    var agentsList = document.getElementById('shareAgentsList');
    var confirmBtn = document.getElementById('sharePopupConfirm');
    
    // Fetch agents
    var agents = await fetchShareableAgents();
    
    if (agents.length === 0) {
        agentsList.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:12px;">You don\'t have permission to share prospects with other agents. Contact your admin to set up sharing.</p>';
        confirmBtn.disabled = true;
    } else {
        agentsList.innerHTML = agents.map(function(agent) {
            return '<label class="share-agent-option" data-email="' + agent.email + '">' +
                '<input type="radio" name="shareAgent" value="' + agent.id + '" data-email="' + agent.email + '">' +
                '<span class="share-agent-radio"></span>' +
                '<span class="share-agent-name">' + agent.name + '</span>' +
            '</label>';
        }).join('');
        
        // Add click handlers
        agentsList.querySelectorAll('.share-agent-option').forEach(function(opt) {
            opt.addEventListener('click', function() {
                agentsList.querySelectorAll('.share-agent-option').forEach(function(o) { o.classList.remove('selected'); });
                this.classList.add('selected');
                this.querySelector('input').checked = true;
                confirmBtn.disabled = false;
            });
        });
        
        confirmBtn.disabled = true;
    }
    
    overlay.classList.add('active');
    popup.classList.add('active');
}

function closeSharePopup() {
    document.getElementById('shareLeadPopup').classList.remove('active');
    document.getElementById('sharePopupOverlay').classList.remove('active');
    currentShareLeadId = null;
}

document.getElementById('sharePopupClose').addEventListener('click', closeSharePopup);
document.getElementById('sharePopupCancel').addEventListener('click', closeSharePopup);

document.getElementById('sharePopupConfirm').addEventListener('click', async function() {
    if (!currentShareLeadId) return;
    
    var selectedAgent = document.querySelector('input[name="shareAgent"]:checked');
    if (!selectedAgent) return;
    
    var selectedAgentId = selectedAgent.value; // Airtable record ID
    var selectedAgentEmail = selectedAgent.dataset.email; // Email for webhook
    
    var btn = this;
    btn.disabled = true;
    btn.textContent = 'Sharing...';
    
    try {
        // Get lead info for email notification
        var lead = allLeads.find(function(l) { return l.id === currentShareLeadId; });
        var leadName = lead ? ((lead.fields['First Name'] || '') + ' ' + (lead.fields['Last Name'] || '')).trim() : 'Unknown';
        var leadPhone = lead ? (lead.fields['Phone #'] || '') : '';
        var leadSummary = lead ? (lead.fields['Last Call Summary'] || '') : '';
        var leadTranscript = lead ? (lead.fields['Transcript (from Calls)'] || '') : '';
        if (Array.isArray(leadTranscript)) leadTranscript = leadTranscript[0] || '';
        
        // Log what we're sending
        console.log('Sharing lead:', currentShareLeadId, 'with agent ID:', selectedAgentId, 'email:', selectedAgentEmail);
        
        // Update Airtable - write to "Shared With" linked record field (not the lookup)
        var patchBody = { fields: { 'Shared With': [selectedAgentId] } };
        console.log('PATCH body:', JSON.stringify(patchBody));
        
        var patchResponse = await fetch('https://api.airtable.com/v0/' + AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + currentShareLeadId, {
            method: 'PATCH',
            headers: { 'Authorization': 'Bearer ' + AIRTABLE_TOKEN, 'Content-Type': 'application/json' },
            body: JSON.stringify(patchBody)
        });
        
        if (!patchResponse.ok) {
            var errorData = await patchResponse.json();
            console.error('Airtable PATCH error:', errorData);
            console.error('Error details:', JSON.stringify(errorData, null, 2));
            showToast('Error: ' + (errorData.error?.message || 'Failed to share'), 'error');
            throw new Error('Failed to update Airtable: ' + (errorData.error?.message || 'Unknown error'));
        }
        
        // Send email notification via n8n webhook
        try {
            await fetch('https://n8n.prioai.ca/webhook/lead-shared', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sharedByEmail: currentUserEmail,
                    sharedByName: currentUserRecord?.fields['Agent Name'] || 'An agent',
                    sharedWithEmail: selectedAgentEmail,
                    leadName: leadName,
                    leadPhone: leadPhone,
                    leadSummary: leadSummary,
                    leadTranscript: leadTranscript,
                    leadId: currentShareLeadId,
                    timestamp: new Date().toISOString()
                })
            });
        } catch (emailErr) {
            console.log('Email notification failed (non-critical):', emailErr);
        }
        
        // Update local data in allLeads (use email for display, the lookup field will show this)
        if (lead) {
            lead.fields['Shared With Email'] = selectedAgentEmail;
            lead.fields['Shared With'] = [selectedAgentId];
        }
        
        // Also update in prioLeads if it exists there
        var prioLead = prioLeads.find(function(l) { return l.id === currentShareLeadId; });
        if (prioLead) {
            prioLead.fields['Shared With Email'] = selectedAgentEmail;
            prioLead.fields['Shared With'] = [selectedAgentId];
        }
        
        // Also update in displayedLeads (used for rendering)
        var displayedLead = displayedLeads.find(function(l) { return l.id === currentShareLeadId; });
        if (displayedLead) {
            displayedLead.fields['Shared With Email'] = selectedAgentEmail;
            displayedLead.fields['Shared With'] = [selectedAgentId];
        }
        
        // Save the lead ID before closing popup (closeSharePopup sets it to null)
        var sharedLeadId = currentShareLeadId;
        
        showToast('Prospect shared successfully!', 'success');
        closeSharePopup();
        
        // Update modal share info if the modal is showing this lead
        if (currentLeadId === sharedLeadId && lead) {
            updateModalShareInfo(lead);
        }
        
        // Re-render tables immediately with local data
        renderPrio();
        renderLeads();
        
        // Then refresh from Airtable to confirm
        setTimeout(function() {
            fetchAllLeads().then(function() {
                renderPrio();
                fetchDisplayedLeads(); // This fetches displayedLeads AND calls renderLeads()
            });
        }, 1000);
        
    } catch (err) {
        console.error('Error sharing lead:', err);
        showToast('Failed to share prospect', 'error');
    }
    
    btn.disabled = false;
    btn.textContent = 'Share';
});

// === SHARE INFO POPUP ===
var currentShareInfoLeadId = null;

function openShareInfoPopup(leadId, isOwner, sharedWithEmail, buttonEl) {
    // Close any existing popups first
    document.getElementById('shareLeadPopup').classList.remove('active');
    document.getElementById('shareInfoPopup').classList.remove('active');
    
    currentShareInfoLeadId = leadId;
    var popup = document.getElementById('shareInfoPopup');
    var title = document.getElementById('shareInfoTitle');
    var content = document.getElementById('shareInfoContent');
    
    // Get lead info
    var lead = allLeads.find(function(l) { return l.id === leadId; });
    
    if (isOwner) {
        // Current user owns this prospect and shared it with someone
        title.textContent = 'Shared Prospect';
        var sharedAgentName = getAgentNameByEmail(sharedWithEmail);
        content.innerHTML = 
            '<div class="share-info-label">Shared with</div>' +
            '<div class="share-info-name">' + sharedAgentName + '</div>' +
            '<button class="btn-stop-sharing" id="btnStopSharing">Stop Sharing</button>';
        
        // Add stop sharing handler
        setTimeout(function() {
            var stopBtn = document.getElementById('btnStopSharing');
            if (stopBtn) {
                stopBtn.addEventListener('click', function() {
                    stopSharingLead(leadId);
                });
            }
        }, 0);
    } else {
        // Current user is receiving this shared prospect
        title.textContent = 'Shared Prospect';
        // Find who shared it - it's the original owner
        var ownerEmails = lead?.fields['Client Email'] || [];
        var ownerEmail = Array.isArray(ownerEmails) ? ownerEmails[0] : ownerEmails;
        var ownerName = getAgentNameByEmail(ownerEmail) || ownerEmail || 'Unknown';
        
        content.innerHTML = 
            '<div class="share-info-label">Shared by</div>' +
            '<div class="share-info-name">' + ownerName + '</div>' +
            '<p style="font-size:0.8125rem;color:var(--text-muted);margin:0;">This prospect was shared with you.</p>';
    }
    
    document.getElementById('sharePopupOverlay').classList.add('active');
    popup.classList.add('active');
}

function closeShareInfoPopup() {
    document.getElementById('shareInfoPopup').classList.remove('active');
    document.getElementById('sharePopupOverlay').classList.remove('active');
    currentShareInfoLeadId = null;
}

document.getElementById('shareInfoClose').addEventListener('click', closeShareInfoPopup);

// Close popups when clicking overlay
document.getElementById('sharePopupOverlay').addEventListener('click', function() {
    closeSharePopup();
    closeShareInfoPopup();
});

// Close popups when clicking outside (backup)
document.addEventListener('click', function(e) {
    var sharePopup = document.getElementById('shareLeadPopup');
    var infoPopup = document.getElementById('shareInfoPopup');
    var overlay = document.getElementById('sharePopupOverlay');
    
    // Don't close if clicking inside popup or on triggers
    if (e.target === overlay) return; // handled by overlay click
    
    if (infoPopup.classList.contains('active') && !infoPopup.contains(e.target) && !e.target.closest('.btn-shared-indicator') && !e.target.closest('.modal-share-info')) {
        closeShareInfoPopup();
    }
});

async function stopSharingLead(leadId) {
    try {
        // Clear the "Shared With" linked record field (not the lookup)
        var patchResponse = await fetch('https://api.airtable.com/v0/' + AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + leadId, {
            method: 'PATCH',
            headers: { 'Authorization': 'Bearer ' + AIRTABLE_TOKEN, 'Content-Type': 'application/json' },
            body: JSON.stringify({ fields: { 'Shared With': [] } })
        });
        
        if (!patchResponse.ok) {
            var errorData = await patchResponse.json();
            console.error('Airtable PATCH error:', errorData);
            throw new Error('Failed to update Airtable');
        }
        
        // Update local data in allLeads
        var lead = allLeads.find(function(l) { return l.id === leadId; });
        if (lead) {
            lead.fields['Shared With Email'] = '';
            lead.fields['Shared With'] = [];
        }
        
        // Also update in prioLeads if it exists there
        var prioLead = prioLeads.find(function(l) { return l.id === leadId; });
        if (prioLead) {
            prioLead.fields['Shared With Email'] = '';
            prioLead.fields['Shared With'] = [];
        }
        
        // Also update in displayedLeads (used for rendering)
        var displayedLead = displayedLeads.find(function(l) { return l.id === leadId; });
        if (displayedLead) {
            displayedLead.fields['Shared With Email'] = '';
            displayedLead.fields['Shared With'] = [];
        }
        
        showToast('Sharing removed', 'success');
        closeShareInfoPopup();
        
        // Update modal share info if the modal is showing this lead
        if (currentLeadId === leadId && lead) {
            updateModalShareInfo(lead);
        }
        
        // Re-render tables immediately
        renderPrio();
        renderLeads();
        
        // Then refresh from Airtable to confirm
        setTimeout(function() {
            fetchAllLeads().then(function() {
                renderPrio();
                fetchDisplayedLeads(); // This fetches displayedLeads AND calls renderLeads()
            });
        }, 1000);
        
    } catch (err) {
        console.error('Error unsharing lead:', err);
        showToast('Failed to remove sharing', 'error');
    }
}

// === HELP SECTION ===
// Category accordions
document.querySelectorAll('.help-category-header').forEach(function(header) {
    header.addEventListener('click', function() {
        var category = this.parentElement;
        category.classList.toggle('open');
    });
});

// Item accordions
document.querySelectorAll('.help-item-header').forEach(function(header) {
    header.addEventListener('click', function() {
        var item = this.parentElement;
        item.classList.toggle('open');
    });
});

// Quick links
document.querySelectorAll('.help-quick-link').forEach(function(link) {
    link.addEventListener('click', function() {
        var topic = this.dataset.topic;
        var category = document.querySelector('.help-category[data-category="' + topic + '"]');
        if (category) {
            category.classList.add('open');
            category.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    });
});

// Help search functionality
document.getElementById('helpSearchInput').addEventListener('input', function() {
    var query = this.value.toLowerCase().trim();
    var categories = document.querySelectorAll('.help-category');
    var noResults = document.getElementById('helpNoResults');
    var searchTermSpan = document.getElementById('helpSearchTerm');
    var hasResults = false;
    
    if (!query) {
        // Show all, collapse all
        categories.forEach(function(cat) {
            cat.style.display = '';
            cat.classList.remove('open');
            cat.querySelectorAll('.help-item').forEach(function(item) {
                item.style.display = '';
                item.classList.remove('open');
                // Remove highlights
                var question = item.querySelector('.help-item-question');
                var answer = item.querySelector('.help-item-answer');
                question.innerHTML = question.textContent;
            });
        });
        noResults.style.display = 'none';
        return;
    }
    
    categories.forEach(function(cat) {
        var catHasMatch = false;
        var items = cat.querySelectorAll('.help-item');
        
        items.forEach(function(item) {
            var keywords = (item.dataset.keywords || '').toLowerCase();
            var question = item.querySelector('.help-item-question');
            var answer = item.querySelector('.help-item-answer');
            var questionText = question.textContent.toLowerCase();
            var answerText = answer.textContent.toLowerCase();
            
            if (keywords.includes(query) || questionText.includes(query) || answerText.includes(query)) {
                item.style.display = '';
                catHasMatch = true;
                hasResults = true;
                // Highlight matching text in question
                var regex = new RegExp('(' + query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
                question.innerHTML = question.textContent.replace(regex, '<span class="help-highlight">$1</span>');
            } else {
                item.style.display = 'none';
            }
        });
        
        if (catHasMatch) {
            cat.style.display = '';
            cat.classList.add('open');
        } else {
            cat.style.display = 'none';
        }
    });
    
    if (hasResults) {
        noResults.style.display = 'none';
    } else {
        noResults.style.display = 'block';
        searchTermSpan.textContent = query;
    }
});

document.getElementById('downloadTemplateBtn').addEventListener('click', function() {
    var csv = 'First Name,Last Name,Phone,Context,Interest\nJohn,Smith,+1 416 555 1234,,Buy\nJane,Doe,+1 647 555 5678,Interested in condos,Sell\n';
    var blob = new Blob([csv], { type: 'text/csv' });
    var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'prio-ai-lead-template.csv'; a.click();
});

var uploadZone = document.getElementById('fileUploadZone');
var fileInput = document.getElementById('leadFileInput');
uploadZone.addEventListener('click', function() { fileInput.click(); });
uploadZone.addEventListener('dragover', function(e) { e.preventDefault(); this.classList.add('dragover'); });
uploadZone.addEventListener('dragleave', function() { this.classList.remove('dragover'); });
uploadZone.addEventListener('drop', function(e) { e.preventDefault(); this.classList.remove('dragover'); if (e.dataTransfer.files.length) handleFileUpload(e.dataTransfer.files[0]); });
fileInput.addEventListener('change', function() { if (this.files.length) handleFileUpload(this.files[0]); });

async function handleFileUpload(file) {
    var statusEl = document.getElementById('uploadStatus');
    if (!file.name.match(/\.(csv|xlsx|xls)$/i)) { statusEl.className = 'upload-status error'; statusEl.textContent = ' Invalid file type'; return; }
    if (file.size > 10 * 1024 * 1024) { statusEl.className = 'upload-status error'; statusEl.textContent = ' File too large (max 10MB)'; return; }
    uploadZone.classList.add('uploading');
    statusEl.className = 'upload-status loading';
    statusEl.innerHTML = ' Uploading...';
    try {
        var base64 = await new Promise(function(resolve, reject) { var reader = new FileReader(); reader.onload = function() { resolve(reader.result.split(',')[1]); }; reader.onerror = reject; reader.readAsDataURL(file); });
        var response = await fetch(UPLOAD_WEBHOOK, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: currentUserEmail, fileName: file.name, fileType: file.type, fileData: base64, agentName: currentUserRecord?.fields['Agent Name'] || 'Unknown' }) });
        var result = await response.json();
        if (result.success) { statusEl.className = 'upload-status success'; statusEl.innerHTML = ' Uploaded! Processing...'; setTimeout(function() { fetchAllLeads().then(fetchDisplayedLeads); }, 2000); }
        else throw new Error(result.message);
    } catch (err) { statusEl.className = 'upload-status error'; statusEl.textContent = ' ' + (err.message || 'Upload failed'); }
    uploadZone.classList.remove('uploading');
}

document.getElementById('searchLeads').addEventListener('input', renderLeads);
document.getElementById('filterStatus').addEventListener('change', renderLeads);
document.getElementById('filterTimeframe').addEventListener('change', renderLeads);
document.getElementById('filterShared').addEventListener('change', renderLeads);

// Column sorting
document.querySelectorAll('.sortable-header').forEach(function(header) {
    header.addEventListener('click', function() {
        var field = this.dataset.sort;
        if (currentSort.field === field) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.field = field;
            currentSort.direction = 'asc';
        }
        
        // Update sort icons
        document.querySelectorAll('.sortable-header .sort-icon').forEach(function(icon) {
            icon.textContent = '';
            icon.classList.remove('active');
        });
        var icon = this.querySelector('.sort-icon');
        icon.textContent = currentSort.direction === 'asc' ? '' : '';
        icon.classList.add('active');
        
        renderLeads();
    });
});

// Search Lead functionality
document.getElementById('searchLeadBtn').addEventListener('click', searchLead);
document.getElementById('searchLeadPhone').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') searchLead();
});

var currentSearchLeadId = null;
var searchResults = [];

async function searchLead() {
    var searchInput = document.getElementById('searchLeadPhone').value.trim().toLowerCase();
    var errorEl = document.getElementById('searchLeadError');
    var resultsEl = document.getElementById('searchLeadResults');
    var emptyEl = document.getElementById('searchLeadEmpty');
    var multipleEl = document.getElementById('searchLeadMultiple');
    
    errorEl.textContent = '';
    resultsEl.style.display = 'none';
    emptyEl.style.display = 'none';
    multipleEl.style.display = 'none';
    document.getElementById('searchLeadSaveStatus').textContent = '';
    
    if (!searchInput) {
        errorEl.textContent = 'Please enter a name or last 4 digits of phone';
        return;
    }
    
    if (searchInput.length < 3) {
        errorEl.textContent = 'Please enter at least 3 characters';
        return;
    }
    
    try {
        // Determine if searching by phone (digits only) or name
        var isPhoneSearch = /^\d+$/.test(searchInput);
        var email = currentUserEmail.toLowerCase();
        var filterFormula;
        
        if (isPhoneSearch) {
            // Search by last digits of phone
            filterFormula = 'AND(FIND("' + email + '", LOWER(ARRAYJOIN({Client Email}))), FIND("' + searchInput + '", SUBSTITUTE(SUBSTITUTE(SUBSTITUTE({Phone #}, "-", ""), "(", ""), ")", "")))';
        } else {
            // Search by name (first or last)
            filterFormula = 'AND(FIND("' + email + '", LOWER(ARRAYJOIN({Client Email}))), OR(FIND("' + searchInput + '", LOWER({First Name})), FIND("' + searchInput + '", LOWER({Last Name}))))';
        }
        
        var url = 'https://api.airtable.com/v0/' + AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '?filterByFormula=' + encodeURIComponent(filterFormula);
        
        var response = await fetch(url, { headers: { 'Authorization': 'Bearer ' + AIRTABLE_TOKEN } });
        var data = await response.json();
        
        if (!data.records || data.records.length === 0) {
            emptyEl.style.display = 'block';
            document.getElementById('searchLeadEmptyText').textContent = 'No lead found matching: ' + searchInput;
            return;
        }
        
        searchResults = data.records;
        
        // If multiple results, show selection list
        if (data.records.length > 1) {
            var listEl = document.getElementById('searchLeadList');
            listEl.innerHTML = data.records.map(function(lead, index) {
                var f = lead.fields;
                var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Unknown';
                var phone = formatPhone(f['Phone #']);
                var status = f['Status'] || 'Unknown';
                return '<div class="search-result-item" data-index="' + index + '">' +
                    '<div class="lead-info">' +
                    '<span class="lead-name">' + name + '</span>' +
                    '<span class="lead-phone">' + phone + '</span>' +
                    '</div>' +
                    '<span class="status-badge ' + getStatusClass(status) + '">' + status + '</span>' +
                    '</div>';
            }).join('');
            
            // Add click handlers
            listEl.querySelectorAll('.search-result-item').forEach(function(item) {
                item.addEventListener('click', function() {
                    displaySearchLead(searchResults[parseInt(this.dataset.index)]);
                    multipleEl.style.display = 'none';
                });
            });
            
            multipleEl.style.display = 'block';
            return;
        }
        
        // Single result - display directly
        displaySearchLead(data.records[0]);
        
    } catch (err) {
        console.error('Error searching lead:', err);
        errorEl.textContent = 'Error searching for lead. Please try again.';
    }
}

function displaySearchLead(lead) {
    var f = lead.fields;
    currentSearchLeadId = lead.id;
    
    var fullName = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Unknown';
    document.getElementById('searchLeadName').textContent = fullName;
    document.getElementById('searchLeadPhone2').textContent = formatPhone(f['Phone #']);
    document.getElementById('searchLeadEmail').textContent = f['Email'] || f['email'] || 'N/A';
    
    var statusEl = document.getElementById('searchLeadStatus');
    var status = f['Status'] || 'Unknown';
    statusEl.textContent = status;
    statusEl.className = 'status-badge ' + getStatusClass(status);
    
    // Show Take Over button for statuses that are in AI pipeline
    var statusLower = (status || '').toLowerCase().trim();
    var takeOverBtn = document.getElementById('searchLeadTakeOver');
    var showTakeOver = ['timeline', 'follow up', 'follow-up', 'followup', 'retry', 'new', 'fresh'].includes(statusLower);
    takeOverBtn.style.display = showTakeOver ? 'inline-flex' : 'none';
    console.log('Search lead status:', status, 'showTakeOver:', showTakeOver);
    
    var totalCalls = f['Attempts'] || f['Total Attempts'] || f['Total Calls'] || f['Call Count'] || '-';
    document.getElementById('searchLeadCalls').textContent = totalCalls;
    
    var lastCallTimestamp = f['Last Call Timestamp'];
    if (Array.isArray(lastCallTimestamp)) lastCallTimestamp = lastCallTimestamp[0];
    document.getElementById('searchLeadLastCall').textContent = formatDateTime(lastCallTimestamp) || 'Never';
    
    var nextCallContainer = document.getElementById('searchLeadNextCallContainer');
    if (statusLower === 'booked' || statusLower === 'callback') {
        nextCallContainer.style.display = 'none';
    } else {
        nextCallContainer.style.display = 'block';
        document.getElementById('searchLeadNextCall').textContent = formatDateTime(f['Next Call Date']) || 'Not scheduled';
    }
    
    document.getElementById('searchLeadBookedTime').textContent = formatDateTime(f['Booked Time']) || 'N/A';
    document.getElementById('searchLeadNotesInput').value = f['Client Notes'] || f['Notes'] || '';
    
    var summary = f['Last Call Summary'] || f['Summary'] || 'No AI summary available';
    if (Array.isArray(summary)) summary = summary[0];
    document.getElementById('searchLeadSummary').textContent = summary;
    
    var lastOutcome = f['Last Outcome'] || '';
    var outcomeSection = document.getElementById('searchLeadOutcomeSection');
    if (statusLower === 'closed' || statusLower === 'dnc') {
        outcomeSection.style.display = 'block';
        document.getElementById('searchLeadOutcome').textContent = lastOutcome || 'No outcome recorded';
    } else {
        outcomeSection.style.display = 'none';
    }
    
    var transcript = f['Transcript (from Calls)'] || f['Transcript'] || '';
    if (Array.isArray(transcript)) transcript = transcript[0];
    
    var transcriptSection = document.getElementById('searchLeadTranscriptSection');
    
    // Always show transcript section for searched leads if transcript exists
    if (transcript) {
        transcriptSection.style.display = 'block';
        document.getElementById('searchLeadTranscript').innerHTML = formatTranscript(transcript, fullName) || 'No transcript available';
    } else {
        transcriptSection.style.display = 'block';
        document.getElementById('searchLeadTranscript').innerHTML = '<span style="color:var(--text-muted);">No transcript available</span>';
    }
    
    // Fetch individual call records
    fetchCallHistory(lead.id, f['Phone #'], fullName, f);
    
    document.getElementById('searchLeadResults').style.display = 'block';
}

// Fetch individual call history for a lead
async function fetchCallHistory(leadId, phone, leadName, leadData) {
    var historyEl = document.getElementById('searchLeadHistory');
    historyEl.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:20px;">Loading call history...</p>';
    
    try {
        // Check if lead has linked call IDs
        var callIds = leadData['Calls'] || [];
        console.log('Lead Calls field:', callIds);
        
        if (callIds.length > 0) {
            // Fetch specific calls by IDs
            var calls = [];
            for (var i = 0; i < callIds.length; i++) {
                try {
                    var url = 'https://api.airtable.com/v0/' + AIRTABLE_BASE + '/' + AIRTABLE_CALLS_TABLE + '/' + callIds[i];
                    var response = await fetch(url, { headers: { 'Authorization': 'Bearer ' + AIRTABLE_TOKEN } });
                    var call = await response.json();
                    if (call.fields) calls.push(call);
                } catch (e) { console.log('Error fetching call:', callIds[i]); }
            }
            
            // Sort by timestamp descending
            calls.sort(function(a, b) {
                return new Date(b.fields['Timestamp'] || 0) - new Date(a.fields['Timestamp'] || 0);
            });
            
            if (calls.length > 0) {
                historyEl.innerHTML = calls.map(function(call, index) {
                    var cf = call.fields;
                    var callTime = cf['Timestamp'] || '';
                    var outcome = cf['Outcome'] || 'Call';
                    var callSummary = cf['summary'] || '';
                    var duration = cf['Duration'] || '';
                    var durationStr = duration ? Math.round(duration) + 's' : '';
                    
                    return '<div style="background:var(--bg-primary);border-radius:8px;padding:16px;border-left:3px solid var(--accent);margin-bottom:8px;">' +
                        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:8px;">' +
                        '<span style="font-weight:500;">' + formatDateTime(callTime) + '</span>' +
                        '<span style="font-size:0.75rem;padding:4px 8px;background:var(--bg-secondary);border-radius:4px;">' + outcome + (durationStr ? '  ' + durationStr : '') + '</span>' +
                        '</div>' +
                        (callSummary ? '<p style="color:var(--text-secondary);font-size:0.875rem;margin:0;">' + callSummary + '</p>' : '') +
                        '</div>';
                }).join('');
                return;
            }
        }
        
        // Fallback to search by Leads field
        var url = 'https://api.airtable.com/v0/' + AIRTABLE_BASE + '/' + AIRTABLE_CALLS_TABLE + '?sort[0][field]=Timestamp&sort[0][direction]=desc&maxRecords=200';
        
        var response = await fetch(url, { headers: { 'Authorization': 'Bearer ' + AIRTABLE_TOKEN } });
        var data = await response.json();
        
        if (data.error || !data.records || data.records.length === 0) {
            showFallbackHistory(historyEl, leadData);
            return;
        }
        
        // Filter calls that belong to this lead
        var leadCalls = data.records.filter(function(call) {
            var leads = call.fields['Leads'] || [];
            if (Array.isArray(leads)) return leads.includes(leadId);
            return false;
        });
        
        if (leadCalls.length === 0) {
            showFallbackHistory(historyEl, leadData);
            return;
        }
        
        historyEl.innerHTML = leadCalls.map(function(call, index) {
            var cf = call.fields;
            var callTime = cf['Timestamp'] || '';
            var outcome = cf['Outcome'] || 'Call';
            var callSummary = cf['summary'] || '';
            var duration = cf['Duration'] || '';
            var durationStr = duration ? Math.round(duration) + 's' : '';
            
            return '<div style="background:var(--bg-primary);border-radius:8px;padding:16px;border-left:3px solid var(--accent);margin-bottom:8px;">' +
                '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:8px;">' +
                '<span style="font-weight:500;">' + formatDateTime(callTime) + '</span>' +
                '<span style="font-size:0.75rem;padding:4px 8px;background:var(--bg-secondary);border-radius:4px;">' + outcome + (durationStr ? '  ' + durationStr : '') + '</span>' +
                '</div>' +
                (callSummary ? '<p style="color:var(--text-secondary);font-size:0.875rem;margin:0;">' + callSummary + '</p>' : '') +
                '</div>';
        }).join('');
        
    } catch (err) {
        console.error('Error fetching call history:', err);
        showFallbackHistory(historyEl, leadData);
    }
}

function showFallbackHistory(historyEl, leadData) {
    if (!leadData) {
        historyEl.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:20px;">No call history available</p>';
        return;
    }
    
    var lastCall = leadData['Last Call Timestamp'];
    if (Array.isArray(lastCall)) lastCall = lastCall[0];
    var attempts = leadData['Attempts'] || 1;
    var outcome = leadData['Last Outcome'] || 'Call completed';
    var summary = leadData['Last Call Summary'];
    if (Array.isArray(summary)) summary = summary[0];
    
    if (!lastCall) {
        historyEl.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:20px;">No call history available</p>';
        return;
    }
    
    historyEl.innerHTML = '<div style="background:var(--bg-primary);border-radius:8px;padding:16px;border-left:3px solid var(--accent);">' +
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:8px;">' +
        '<span style="font-weight:500;">' + formatDateTime(lastCall) + '</span>' +
        '<span style="font-size:0.75rem;padding:4px 8px;background:var(--bg-secondary);border-radius:4px;">' + outcome + '  ' + attempts + ' attempt' + (attempts !== 1 ? 's' : '') + '</span>' +
        '</div>' +
        (summary ? '<p style="color:var(--text-secondary);font-size:0.875rem;">' + summary + '</p>' : '') +
        '</div>';
}

// Save notes for searched lead
document.getElementById('searchLeadSaveNotes').addEventListener('click', async function() {
    if (!currentSearchLeadId) return;
    
    var btn = this;
    var statusEl = document.getElementById('searchLeadSaveStatus');
    var notes = document.getElementById('searchLeadNotesInput').value;
    
    btn.disabled = true;
    btn.textContent = 'Saving...';
    statusEl.textContent = '';
    
    try {
        var response = await fetch('https://api.airtable.com/v0/' + AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + currentSearchLeadId, {
            method: 'PATCH',
            headers: {
                'Authorization': 'Bearer ' + AIRTABLE_TOKEN,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ fields: { 'Client Notes': notes, 'Last Note Change': new Date().toISOString() }})
        });
        
        if (response.ok) {
            statusEl.style.color = 'var(--success)';
            statusEl.textContent = ' Notes saved successfully!';
            // Refresh the main leads list
            fetchAllLeads().then(fetchDisplayedLeads);
        } else {
            throw new Error('Failed to save');
        }
    } catch (err) {
        console.error('Error saving notes:', err);
        statusEl.style.color = 'var(--danger)';
        statusEl.textContent = ' Failed to save notes. Please try again.';
    }
    
    btn.disabled = false;
    btn.textContent = 'Save Changes';
});

// Take Over from search results


document.getElementById('searchLeadTakeOver').addEventListener('click', function() {
    if (!currentSearchLeadId) return;
    searchLeadTakeoverPending = true;
    document.getElementById('takeoverModal').classList.add('active');
});

async function executeSearchLeadTakeover() {
    var btn = document.getElementById('searchLeadTakeOver');
    btn.disabled = true;
    btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation:spin 1s linear infinite;"><circle cx="12" cy="12" r="10" stroke-dasharray="32" stroke-dashoffset="12"/></svg> Taking over...';
    
    try {
        var response = await fetch('https://api.airtable.com/v0/' + AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + currentSearchLeadId, {
            method: 'PATCH',
            headers: {
                'Authorization': 'Bearer ' + AIRTABLE_TOKEN,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ fields: { 'Status': 'Callback', 'Next Call Date': null }})
        });
        
        if (response.ok) {
            showToast('Lead taken over! Status changed to Callback.', 'success');
            // Update the display
            document.getElementById('searchLeadStatus').textContent = 'Callback';
            document.getElementById('searchLeadStatus').className = 'status-badge ' + getStatusClass('Callback');
            btn.style.display = 'none';
            document.getElementById('searchLeadNextCallContainer').style.display = 'none';
            // Refresh leads list
            fetchAllLeads().then(fetchDisplayedLeads);
        } else {
            throw new Error('Failed to update');
        }
    } catch (err) {
        console.error('Error taking over lead:', err);
        showToast('Failed to take over lead. Please try again.', 'error');
        btn.disabled = false;
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg> Take Over';
    }
}

// Escape key to close modals
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        var transcriptModal = document.getElementById('transcriptModal');
        var leadModal = document.getElementById('leadModal');
        var takeoverModal = document.getElementById('takeoverModal');
        var followupModal = document.getElementById('followupModal');
        var confirmModal = document.getElementById('confirmCloseModal');
        var scheduleModal = document.getElementById('scheduleModal');
        
        if (scheduleModal.classList.contains('active')) {
            scheduleModal.classList.remove('active');
        } else if (transcriptModal.classList.contains('active')) {
            transcriptModal.classList.remove('active');
        } else if (confirmModal.classList.contains('active')) {
            confirmModal.classList.remove('active');
        } else if (followupModal.classList.contains('active')) {
            followupModal.classList.remove('active');
        } else if (takeoverModal.classList.contains('active')) {
            takeoverModal.classList.remove('active');
        } else if (leadModal.classList.contains('active')) {
            tryCloseModal();
        }
    }
});

// Transcript font size toggle
var transcriptLargeFont = false;
document.getElementById('transcriptSizeBtn').addEventListener('click', function() {
    transcriptLargeFont = !transcriptLargeFont;
    document.getElementById('modalTranscript').classList.toggle('large-font', transcriptLargeFont);
    this.classList.toggle('active', transcriptLargeFont);
});

// Transcript expand popup
document.getElementById('transcriptExpandBtn').addEventListener('click', function() {
    var transcriptContent = document.getElementById('modalTranscript').innerHTML;
    document.getElementById('transcriptModalBody').innerHTML = transcriptContent;
    document.getElementById('transcriptModal').classList.add('active');
});

document.getElementById('transcriptModalClose').addEventListener('click', function() {
    document.getElementById('transcriptModal').classList.remove('active');
});

document.getElementById('transcriptModal').addEventListener('click', function(e) {
    if (e.target === this) this.classList.remove('active');
});

// Report bug button
document.getElementById('reportBugBtn').addEventListener('click', function() {
    var lead = filteredLeads[currentLeadIndex];
    if (!lead) return;
    var f = lead.fields;
    var leadInfo = 'Lead: ' + (f['First Name'] || '') + ' ' + (f['Last Name'] || '') + '\nPhone: ' + (f['Phone #'] || '') + '\nStatus: ' + (f['Status'] || '') + '\nID: ' + lead.id;
    
    // Switch to feedback tab and pre-fill
    window.location.hash = 'feedback';
    switchToTab('feedback');
    
    // Pre-select bug type and fill context
    document.querySelectorAll('.feedback-type').forEach(function(t) { t.classList.remove('selected'); });
    document.querySelector('.feedback-type[data-type="bug"]').classList.add('selected');
    document.getElementById('feedbackType').value = 'bug';
    document.getElementById('feedbackMessage').value = '--- Lead Reference ---\n' + leadInfo + '\n\n--- Issue Description ---\n';
    document.getElementById('feedbackMessage').focus();
    
    closeModal();
});

// Billing button - create Stripe customer portal session
document.getElementById('manageBillingBtn').addEventListener('click', async function() {
    var btn = this;
    var statusEl = document.getElementById('billingStatus');
    btn.disabled = true;
    btn.textContent = 'Loading...';
    statusEl.textContent = '';
    
    try {
        // For now, link to mailto - you can replace with Stripe customer portal URL
        window.open('mailto:info@prioai.ca?subject=Billing Inquiry - ' + encodeURIComponent(currentUserEmail), '_blank');
        statusEl.textContent = 'Opening email client...';
    } catch (err) {
        statusEl.style.color = 'var(--danger)';
        statusEl.textContent = 'Error. Please contact info@prioai.ca';
    }
    
    btn.disabled = false;
    btn.textContent = 'Manage Subscription';
});

// === PRIO LEADS FUNCTIONALITY ===
function renderPrio() {
    prioLeads = allLeads.filter(function(l) { return l.fields['Is Prio'] === true; });
    var searchTerm = document.getElementById('searchPrio').value.toLowerCase();
    var timeframe = document.getElementById('filterPrioTimeframe').value;
    var ownershipFilter = document.getElementById('filterPrioOwnership').value;
    
    filteredPrioLeads = prioLeads.filter(function(l) {
        var f = l.fields;
        var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).toLowerCase();
        var phone = (f['Phone #'] || '').replace(/\D/g, '');
        var matchesSearch = name.includes(searchTerm) || phone.includes(searchTerm.replace(/\D/g, ''));
        
        if (!matchesSearch) return false;
        
        // Ownership filter
        var sharedWithEmailRaw = f['Shared With Email'];
        var sharedWithEmail = Array.isArray(sharedWithEmailRaw) ? (sharedWithEmailRaw[0] || '') : (sharedWithEmailRaw || '');
        var isOwned = !l.isShared;
        var isSharedByMe = isOwned && sharedWithEmail;
        var isNotShared = isOwned && !sharedWithEmail;
        var isSharedWithMe = l.isShared;
        
        if (ownershipFilter === 'owned' && !isOwned) return false;
        if (ownershipFilter === 'shared_by_me' && !isSharedByMe) return false;
        if (ownershipFilter === 'not_shared' && !isNotShared) return false;
        if (ownershipFilter === 'shared_with_me' && !isSharedWithMe) return false;
        
        if (timeframe) {
            var lastCall = f['Last Call Timestamp'];
            if (!lastCall) return false;
            var callDate = new Date(lastCall);
            var cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - parseInt(timeframe));
            if (callDate < cutoff) return false;
        }
        return true;
    });
    
    document.getElementById('prioCount').textContent = filteredPrioLeads.length;
    document.getElementById('prioEmpty').style.display = filteredPrioLeads.length === 0 ? 'block' : 'none';
    document.getElementById('prioTableWrapper').style.display = filteredPrioLeads.length === 0 ? 'none' : 'block';
    
    var tbody = document.getElementById('prioTableBody');
    tbody.innerHTML = filteredPrioLeads.map(function(lead, index) {
        var f = lead.fields;
        var firstName = f['First Name'] || '-';
        var lastName = f['Last Name'] || '-';
        var phone = formatPhone(f['Phone #']);
        var lastCalled = formatDateTime(getMostRecentLastCalled(f));
        var bookedTime = f['Booked Time'] 
            ? formatDateTime(f['Booked Time'])
            : '<button class="btn-schedule-inline" data-prio-index="' + index + '">Schedule</button>';
        var summary = f['Last Call Summary'] || '-';
        var notes = getLastNoteText(f['Client Notes']);
        
        // Share indicator and button logic
        var sharedWithEmailRaw = f['Shared With Email'];
        var sharedWithEmail = Array.isArray(sharedWithEmailRaw) ? (sharedWithEmailRaw[0] || '') : (sharedWithEmailRaw || '');
        var shareHtml = '';
        if (lead.isShared) {
            // This lead is shared WITH current user - show clickable chain icon
            shareHtml = '<button class="btn-shared-indicator" data-lead-id="' + lead.id + '" data-is-owner="false" title="View sharing info"></button>';
        } else if (sharedWithEmail) {
            // This lead is owned by current user and shared with someone else
            shareHtml = '<button class="btn-shared-indicator" data-lead-id="' + lead.id + '" data-is-owner="true" data-shared-with="' + sharedWithEmail + '" title="View sharing info"></button>';
        } else {
            shareHtml = '<button class="btn-share-lead" data-lead-id="' + lead.id + '" data-prio-index="' + index + '" title="Share with another agent">+</button>';
        }
        
        var summaryHtml = '<div class="summary-text">' + summary + '</div>';
        var notesHtml = '<div class="notes-cell">' + notes + '</div>';
        return '<tr data-prio-index="' + index + '"><td>' + firstName + '</td><td>' + lastName + '</td><td>' + phone + '</td><td>' + lastCalled + '</td><td>' + bookedTime + '</td><td>' + summaryHtml + '</td><td>' + notesHtml + '</td><td class="col-sharing">' + shareHtml + '</td><td><button class="btn-remove-prio" data-id="' + lead.id + '">Unprio</button></td></tr>';
    }).join('');
    
    tbody.querySelectorAll('tr').forEach(function(row) {
        row.addEventListener('click', function(e) {
            if (!e.target.closest('.btn-remove-prio') && !e.target.closest('.btn-schedule-inline') && !e.target.closest('.btn-share-lead') && !e.target.closest('.btn-shared-indicator')) openPrioLeadModal(parseInt(this.dataset.prioIndex));
        });
    });
    
    tbody.querySelectorAll('.btn-remove-prio').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            removePrioLead(this.dataset.id, this);
        });
    });
    
    tbody.querySelectorAll('.btn-share-lead').forEach(function(btn) {
        btn.addEventListener('click', function(e) { 
            e.stopPropagation(); 
            openSharePopup(this.dataset.leadId, this); 
        });
    });
    
    tbody.querySelectorAll('.btn-shared-indicator').forEach(function(btn) {
        btn.addEventListener('click', function(e) { 
            e.stopPropagation(); 
            openShareInfoPopup(this.dataset.leadId, this.dataset.isOwner === 'true', this.dataset.sharedWith || '', this); 
        });
    });
    
    tbody.querySelectorAll('.btn-schedule-inline').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            var idx = parseInt(this.dataset.prioIndex);
            var lead = filteredPrioLeads[idx];
            if (lead) openScheduleModal(lead.id, lead.fields);
        });
    });
}

document.getElementById('filterPrioTimeframe').addEventListener('change', renderPrio);
document.getElementById('filterPrioOwnership').addEventListener('change', renderPrio);

var currentPrioIndex = -1;

function openPrioLeadModal(index) {
    if (index < 0 || index >= filteredPrioLeads.length) return;
    currentPrioIndex = index;
    currentLeadIndex = -1; // Not from regular leads
    var lead = filteredPrioLeads[index];
    currentLeadId = lead.id;
    
    // Update URL with lead ID
    window.history.pushState(null, '', '#lead-' + lead.id);
    
    var f = lead.fields;
    var leadName = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Lead';
    document.getElementById('modalLeadName').textContent = leadName;
    document.getElementById('modalPhone').textContent = formatPhone(f['Phone #']);
    var statusEl = document.getElementById('modalStatus');
    var status = f['Status'] || '-';
    statusEl.textContent = status;
    statusEl.className = 'status-badge ' + getStatusClass(status);
    document.getElementById('modalLastCalled').textContent = formatDateTime(getMostRecentLastCalled(f));
    
    // Update booked time display
    var hasBookedTime = !!f['Booked Time'];
    document.getElementById('modalBookedTime').innerHTML = hasBookedTime ? formatDateTime(f['Booked Time']) + ' <button class="btn-delete-booking-modal" onclick="deleteBookingFromModal()" title="Remove booking"></button>' : '';
    document.getElementById('modalBookedTime').style.display = hasBookedTime ? 'block' : 'none';
    document.getElementById('modalScheduleBtn').style.display = hasBookedTime ? 'none' : 'block';
    document.getElementById('editBookedTimeBtn').style.display = hasBookedTime ? 'inline' : 'none';
    
    document.getElementById('modalCallSummary').textContent = f['Last Call Summary'] || 'No summary available';
    
    // Handle notes as array
    var notesData = f['Client Notes'] || '';
    updateClientNotes(notesData, true);
    document.getElementById('agentNotesInput').value = '';
    editingNoteIndex = -1;
    
    var transcript = f['Transcript (from Calls)'] || '';
    if (Array.isArray(transcript)) transcript = transcript[0];
    document.getElementById('modalTranscript').innerHTML = formatTranscript(transcript, leadName) || 'No transcript available';
    
    updatePrioButton(f['Is Prio']);
    updateClientAttempts(f['Client Attempts'] || [], true);
    
    // Update sharing info in modal
    updateModalShareInfo(lead);
    
    document.getElementById('leadModal').classList.add('active');
    
    // Show arrows for PRIO navigation
    var prevBtn = document.getElementById('modalPrev');
    var nextBtn = document.getElementById('modalNext');
    prevBtn.style.display = 'flex';
    nextBtn.style.display = 'flex';
    prevBtn.style.opacity = index > 0 ? '1' : '0.3';
    nextBtn.style.opacity = index < filteredPrioLeads.length - 1 ? '1' : '0.3';
}

async function removePrioLead(leadId, btn) {
    btn.disabled = true;
    btn.textContent = '...';
    try {
        await fetch('https://api.airtable.com/v0/' + AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + leadId, {
            method: 'PATCH',
            headers: { 'Authorization': 'Bearer ' + AIRTABLE_TOKEN, 'Content-Type': 'application/json' },
            body: JSON.stringify({ fields: { 'Is Prio': false }})
        });
        showToast('Lead removed from PRIO', 'success');
        fetchAllLeads().then(function() { renderPrio(); fetchDisplayedLeads(); });
    } catch (err) {
        showToast('Failed to remove lead', 'error');
        btn.disabled = false;
        btn.textContent = 'Remove';
    }
}

document.getElementById('searchPrio').addEventListener('input', renderPrio);

// PRIO button in modal
document.getElementById('prioLeadBtn').addEventListener('click', async function() {
    if (!currentLeadId) return;
    var btn = this;
    var isPrio = btn.classList.contains('is-prio');
    btn.disabled = true;
    
    try {
        await fetch('https://api.airtable.com/v0/' + AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + currentLeadId, {
            method: 'PATCH',
            headers: { 'Authorization': 'Bearer ' + AIRTABLE_TOKEN, 'Content-Type': 'application/json' },
            body: JSON.stringify({ fields: { 'Is Prio': !isPrio }})
        });
        
        if (!isPrio) {
            showToast('Lead marked as PRIO! Find it in the PRIO tab.', 'success');
            btn.classList.add('is-prio');
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg> PRIO\'D';
        } else {
            showToast('Lead removed from PRIO', 'success');
            btn.classList.remove('is-prio');
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg> PRIO LEAD';
        }
        fetchAllLeads().then(function() { renderPrio(); fetchDisplayedLeads(); });
    } catch (err) {
        showToast('Failed to update lead', 'error');
    }
    btn.disabled = false;
});

function updatePrioButton(isPrio) {
    var btn = document.getElementById('prioLeadBtn');
    if (isPrio) {
        btn.classList.add('is-prio');
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg> PRIO\'D';
    } else {
        btn.classList.remove('is-prio');
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg> PRIO LEAD';
    }
}

// === SCHEDULE MODAL ===
var scheduleLeadId = null;
var scheduleLeadData = null;
var selectedDate = null;
var selectedTime = null;
var calendarMonth = new Date();

function openScheduleModal(leadId, leadData) {
    scheduleLeadId = leadId;
    scheduleLeadData = leadData;
    var leadName = ((leadData['First Name'] || '') + ' ' + (leadData['Last Name'] || '')).trim() || 'Lead';
    document.getElementById('scheduleLeadName').textContent = 'Scheduling for: ' + leadName;
    
    // Reset selections - default to today
    var today = new Date();
    today.setHours(0, 0, 0, 0);
    selectedDate = today;
    selectedTime = null;
    calendarMonth = new Date();
    
    // Clear time slot selection
    document.querySelectorAll('.time-slot').forEach(function(slot) {
        slot.classList.remove('selected');
    });
    
    // Render calendar
    renderCalendar();
    
    document.getElementById('scheduleModal').classList.add('active');
}

function openScheduleFromModal() {
    var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
    if (lead) {
        openScheduleModal(lead.id, lead.fields);
    }
}

// Delete booking function
async function deleteBooking(leadId, leadIndex, prioIndex) {
    if (!confirm('Remove this booking/callback time?')) return;
    
    try {
        await fetch('https://api.airtable.com/v0/' + AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + leadId, {
            method: 'PATCH',
            headers: { 'Authorization': 'Bearer ' + AIRTABLE_TOKEN, 'Content-Type': 'application/json' },
            body: JSON.stringify({ fields: { 'Booked Time': null }})
        });
        
        showToast('Booking removed', 'success');
        
        // Update local data and re-render
        var lead = allLeads.find(function(l) { return l.id === leadId; });
        if (lead) {
            lead.fields['Booked Time'] = null;
        }
        
        // Re-render tables
        renderLeads();
        renderPrio();
        
        // Update modal if open
        if (currentLeadId === leadId) {
            document.getElementById('modalBookedTime').innerHTML = '';
            document.getElementById('modalBookedTime').style.display = 'none';
            document.getElementById('modalScheduleBtn').style.display = 'inline-block';
        }
    } catch (err) {
        console.error('Failed to delete booking:', err);
        showToast('Failed to remove booking', 'error');
    }
}

// Delete booking from modal
function deleteBookingFromModal() {
    if (currentLeadId) {
        deleteBooking(currentLeadId, null, null);
    }
}

function renderCalendar() {
    var year = calendarMonth.getFullYear();
    var month = calendarMonth.getMonth();
    var today = new Date();
    today.setHours(0, 0, 0, 0);
    
    var monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('calendarMonth').textContent = monthNames[month] + ' ' + year;
    
    var firstDay = new Date(year, month, 1).getDay();
    var daysInMonth = new Date(year, month + 1, 0).getDate();
    var daysInPrevMonth = new Date(year, month, 0).getDate();
    
    var daysHtml = '';
    
    // Previous month days
    for (var i = firstDay - 1; i >= 0; i--) {
        var day = daysInPrevMonth - i;
        daysHtml += '<button class="calendar-day other-month disabled">' + day + '</button>';
    }
    
    // Current month days
    for (var d = 1; d <= daysInMonth; d++) {
        var date = new Date(year, month, d);
        var isPast = date < today;
        var isToday = date.getTime() === today.getTime();
        var isSelected = selectedDate && date.getTime() === selectedDate.getTime();
        
        var classes = 'calendar-day';
        if (isPast) classes += ' disabled';
        if (isToday) classes += ' today';
        if (isSelected) classes += ' selected';
        
        daysHtml += '<button class="' + classes + '" data-date="' + date.toISOString().split('T')[0] + '"' + (isPast ? ' disabled' : '') + '>' + d + '</button>';
    }
    
    // Next month days
    var totalCells = firstDay + daysInMonth;
    var remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
    for (var n = 1; n <= remaining; n++) {
        daysHtml += '<button class="calendar-day other-month disabled">' + n + '</button>';
    }
    
    document.getElementById('calendarDays').innerHTML = daysHtml;
    
    // Add click handlers
    document.querySelectorAll('.calendar-day:not(.disabled)').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.calendar-day').forEach(function(d) { d.classList.remove('selected'); });
            this.classList.add('selected');
            // Parse date string as LOCAL time (not UTC)
            var parts = this.dataset.date.split('-');
            selectedDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            
            // Update available time slots if today is selected
            updateAvailableTimeSlots();
        });
    });
}

// Update time dropdown based on selected date
function updateAvailableTimeSlots() {
    var hourSelect = document.getElementById('scheduleHour');
    var minuteSelect = document.getElementById('scheduleMinute');
    var now = new Date();
    var isToday = selectedDate && selectedDate.toDateString() === now.toDateString();
    
    // Reset all options to enabled first
    Array.from(hourSelect.options).forEach(function(opt) { opt.disabled = false; });
    Array.from(minuteSelect.options).forEach(function(opt) { opt.disabled = false; });
    
    if (isToday) {
        // Disable hours that are in the past (need 15 min buffer)
        var minHour = now.getHours();
        var minMinute = now.getMinutes() + 15;
        
        // If we're past :45, bump to next hour
        if (minMinute >= 60) {
            minHour++;
            minMinute = minMinute - 60;
        }
        
        // Round up to next 15-min slot
        if (minMinute > 0 && minMinute <= 15) minMinute = 15;
        else if (minMinute > 15 && minMinute <= 30) minMinute = 30;
        else if (minMinute > 30 && minMinute <= 45) minMinute = 45;
        else if (minMinute > 45) { minMinute = 0; minHour++; }
        
        // Disable past hours
        Array.from(hourSelect.options).forEach(function(opt) {
            if (parseInt(opt.value) < minHour) {
                opt.disabled = true;
            }
        });
        
        // If current hour is selected, disable past minutes
        var selectedHour = parseInt(hourSelect.value);
        if (selectedHour === minHour) {
            Array.from(minuteSelect.options).forEach(function(opt) {
                if (parseInt(opt.value) < minMinute) {
                    opt.disabled = true;
                }
            });
        }
        
        // Auto-select first available time if current selection is disabled
        if (hourSelect.options[hourSelect.selectedIndex].disabled) {
            for (var i = 0; i < hourSelect.options.length; i++) {
                if (!hourSelect.options[i].disabled) {
                    hourSelect.selectedIndex = i;
                    break;
                }
            }
        }
        
        // Update minute dropdown
        updateMinuteOptions();
    }
}

// Update minute options based on hour selection
function updateMinuteOptions() {
    var hourSelect = document.getElementById('scheduleHour');
    var minuteSelect = document.getElementById('scheduleMinute');
    var now = new Date();
    var isToday = selectedDate && selectedDate.toDateString() === now.toDateString();
    
    // Reset all minute options
    Array.from(minuteSelect.options).forEach(function(opt) { opt.disabled = false; });
    
    if (isToday) {
        var selectedHour = parseInt(hourSelect.value);
        var minHour = now.getHours();
        var minMinute = now.getMinutes() + 15;
        
        if (minMinute >= 60) {
            minHour++;
            minMinute = minMinute - 60;
        }
        
        // Round up to next 15-min slot
        if (minMinute > 0 && minMinute <= 15) minMinute = 15;
        else if (minMinute > 15 && minMinute <= 30) minMinute = 30;
        else if (minMinute > 30 && minMinute <= 45) minMinute = 45;
        else if (minMinute > 45) { minMinute = 0; minHour++; }
        
        if (selectedHour === minHour) {
            Array.from(minuteSelect.options).forEach(function(opt) {
                if (parseInt(opt.value) < minMinute) {
                    opt.disabled = true;
                }
            });
            
            // Auto-select first available minute if current is disabled
            if (minuteSelect.options[minuteSelect.selectedIndex].disabled) {
                for (var i = 0; i < minuteSelect.options.length; i++) {
                    if (!minuteSelect.options[i].disabled) {
                        minuteSelect.selectedIndex = i;
                        break;
                    }
                }
            }
        }
    }
}

// Update minutes when hour changes
document.getElementById('scheduleHour').addEventListener('change', updateMinuteOptions);

document.getElementById('calendarPrev').addEventListener('click', function() {
    calendarMonth.setMonth(calendarMonth.getMonth() - 1);
    renderCalendar();
});

document.getElementById('calendarNext').addEventListener('click', function() {
    calendarMonth.setMonth(calendarMonth.getMonth() + 1);
    renderCalendar();
});

// Time slot selection
document.querySelectorAll('.time-slot').forEach(function(slot) {
    slot.addEventListener('click', function() {
        document.querySelectorAll('.time-slot').forEach(function(s) { s.classList.remove('selected'); });
        this.classList.add('selected');
        selectedTime = this.dataset.time;
    });
});

document.getElementById('scheduleCancelBtn').addEventListener('click', function() {
    document.getElementById('scheduleModal').classList.remove('active');
    scheduleLeadId = null;
    scheduleLeadData = null;
});

document.getElementById('scheduleModal').addEventListener('click', function(e) {
    if (e.target === this) {
        this.classList.remove('active');
        scheduleLeadId = null;
        scheduleLeadData = null;
    }
});

document.getElementById('scheduleSaveBtn').addEventListener('click', async function() {
    var btn = this;
    
    if (!selectedDate || !scheduleLeadId) {
        showToast('Please select a date', 'error');
        return;
    }
    
    var hour = parseInt(document.getElementById('scheduleHour').value);
    var minute = parseInt(document.getElementById('scheduleMinute').value);
    
    var bookedDateTime = new Date(selectedDate);
    bookedDateTime.setHours(hour, minute, 0, 0);
    
    // Validate time is at least 15 minutes in the future
    var now = new Date();
    var minTime = new Date(now.getTime() + 15 * 60000); // 15 minutes from now
    
    if (bookedDateTime < minTime) {
        showToast('Please select a time at least 15 minutes from now', 'error');
        return;
    }
    
    btn.disabled = true;
    btn.textContent = 'Saving...';
    
    try {
        await fetch('https://api.airtable.com/v0/' + AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + scheduleLeadId, {
            method: 'PATCH',
            headers: { 'Authorization': 'Bearer ' + AIRTABLE_TOKEN, 'Content-Type': 'application/json' },
            body: JSON.stringify({ fields: { 'Booked Time': bookedDateTime.toISOString() }})
        });
        
        // Auto-create Google Calendar event via webhook
        try {
            var leadName = ((scheduleLeadData['First Name'] || '') + ' ' + (scheduleLeadData['Last Name'] || '')).trim() || 'Prospect';
            var leadPhone = scheduleLeadData['Phone #'] || '';
            var endDateTime = new Date(bookedDateTime.getTime() + 30 * 60000); // 30 min meeting
            
            // Format datetime with proper timezone offset
            function formatWithTimezone(date) {
                var year = date.getFullYear();
                var month = String(date.getMonth() + 1).padStart(2, '0');
                var day = String(date.getDate()).padStart(2, '0');
                var hours = String(date.getHours()).padStart(2, '0');
                var minutes = String(date.getMinutes()).padStart(2, '0');
                var seconds = String(date.getSeconds()).padStart(2, '0');
                
                // Get the actual timezone offset in minutes and convert to hours:minutes
                var offsetMinutes = date.getTimezoneOffset();
                var offsetHours = Math.floor(Math.abs(offsetMinutes) / 60);
                var offsetMins = Math.abs(offsetMinutes) % 60;
                var offsetSign = offsetMinutes <= 0 ? '+' : '-';
                var offsetStr = offsetSign + String(offsetHours).padStart(2, '0') + ':' + String(offsetMins).padStart(2, '0');
                
                return year + '-' + month + '-' + day + 'T' + hours + ':' + minutes + ':' + seconds + offsetStr;
            }
            
            await fetch('https://n8n.prioai.ca/webhook/create-calendar-event', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    clientEmail: viewingAsClient || currentUserEmail,
                    title: 'Real Estate Consultation - ' + leadName,
                    description: 'Phone: ' + leadPhone + '\n\nBooked via Prio AI Dashboard',
                    startTime: formatWithTimezone(bookedDateTime),
                    endTime: formatWithTimezone(endDateTime),
                    leadName: leadName,
                    leadPhone: leadPhone
                })
            });
            console.log('Calendar event created');
        } catch (calErr) {
            console.error('Failed to create calendar event:', calErr);
            // Don't show error to user - booking still succeeded
        }
        
        showToast('Meeting scheduled!', 'success');
        document.getElementById('scheduleModal').classList.remove('active');
        
        // Update modal if open
        if (currentLeadId === scheduleLeadId) {
            document.getElementById('modalBookedTime').innerHTML = formatDateTime(bookedDateTime) + ' <button class="btn-delete-booking-modal" onclick="deleteBookingFromModal()" title="Remove booking"></button>';
            document.getElementById('modalBookedTime').style.display = 'block';
            document.getElementById('modalScheduleBtn').style.display = 'none';
            document.getElementById('editBookedTimeBtn').style.display = 'inline';
        }
        
        fetchAllLeads().then(function() { renderPrio(); fetchDisplayedLeads(); });
    } catch (err) {
        showToast('Failed to schedule meeting', 'error');
    }
    
    btn.disabled = false;
    btn.textContent = 'Save Booking';
    scheduleLeadId = null;
    scheduleLeadData = null;
});

// Google Calendar integration
function openGoogleCalendar() {
    var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
    if (!lead || !lead.fields['Booked Time']) {
        showToast('No booking to add to calendar', 'error');
        return;
    }
    
    var f = lead.fields;
    var leadName = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Lead';
    var phone = f['Phone #'] || '';
    var bookedTime = new Date(f['Booked Time']);
    var endTime = new Date(bookedTime.getTime() + 30 * 60000); // 30 min meeting
    
    var title = encodeURIComponent('Real Estate Consultation - ' + leadName);
    var details = encodeURIComponent('Phone: ' + phone + '\n\nBooked via Prio AI Dashboard');
    var startStr = bookedTime.toISOString().replace(/-|:|\.\d{3}/g, '');
    var endStr = endTime.toISOString().replace(/-|:|\.\d{3}/g, '');
    
    var gcalUrl = 'https://calendar.google.com/calendar/render?action=TEMPLATE' +
        '&text=' + title +
        '&dates=' + startStr + '/' + endStr +
        '&details=' + details;
    
    window.open(gcalUrl, '_blank');
}

// Edit booked time - opens schedule modal
document.getElementById('editBookedTimeBtn').addEventListener('click', function() {
    var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
    if (lead) {
        openScheduleModal(lead.id, lead.fields);
    }
});

// === POLISH NOTES WITH AI ===
var POLISH_NOTES_ENDPOINT = 'https://n8n.prioai.ca/webhook/clean-notes';

document.getElementById('polishNotesBtn').addEventListener('click', async function() {
    var btn = this;
    var textarea = document.getElementById('agentNotesInput');
    var notes = textarea.value.trim();
    
    if (!notes) {
        showToast('Please enter some notes first', 'warning');
        return;
    }
    
    if (notes.length < 10) {
        showToast('Notes too short to polish', 'warning');
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = ' Polishing...';
    btn.classList.add('loading');
    
    try {
        var response = await fetch(POLISH_NOTES_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ notes: notes })
        });
        
        if (!response.ok) {
            console.error('Polish API error:', response.status, response.statusText);
            throw new Error('API returned ' + response.status);
        }
        
        var responseText = await response.text();
        console.log('Polish API raw response:', responseText);
        
        if (!responseText || responseText.trim() === '') {
            throw new Error('Empty response from API');
        }
        
        var data;
        try {
            data = JSON.parse(responseText);
        } catch (parseErr) {
            console.error('JSON parse error:', parseErr, 'Raw:', responseText);
            throw new Error('Invalid JSON response');
        }
        
        if (data.success && data.cleaned) {
            // Set polished text and save the note
            textarea.value = data.cleaned;
            await saveCurrentNote();
            showToast('Note polished & saved! ', 'success');
        } else {
            throw new Error(data.error || 'Failed to polish notes');
        }
    } catch (err) {
        console.error('Polish notes error:', err);
        showToast('Polish failed: ' + err.message, 'error');
    }
    
    btn.disabled = false;
    btn.innerHTML = ' Polish';
    btn.classList.remove('loading');
});

// === VOICE INPUT ===
var voiceRecognition = null;
var isRecording = false;

if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    voiceRecognition = new SpeechRecognition();
    voiceRecognition.continuous = true;
    voiceRecognition.interimResults = true;
    voiceRecognition.lang = 'en-US';
    
    voiceRecognition.onresult = function(event) {
        var transcript = '';
        for (var i = event.resultIndex; i < event.results.length; i++) {
            transcript += event.results[i][0].transcript;
        }
        var textarea = document.getElementById('agentNotesInput');
        var currentText = textarea.value;
        if (currentText && !currentText.endsWith(' ') && !currentText.endsWith('\n')) {
            currentText += ' ';
        }
        // Only add final results
        if (event.results[event.results.length - 1].isFinal) {
            textarea.value = currentText + transcript;
        }
    };
    
    voiceRecognition.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
        stopVoiceRecording();
        if (event.error === 'not-allowed') {
            showToast('Microphone access denied. Please enable it in your browser settings.', 'error');
        }
    };
    
    voiceRecognition.onend = function() {
        if (isRecording) {
            // Restart if still supposed to be recording
            voiceRecognition.start();
        }
    };
}

function startVoiceRecording() {
    if (!voiceRecognition) {
        showToast('Voice input not supported in this browser', 'error');
        return;
    }
    isRecording = true;
    document.getElementById('voiceInputBtn').classList.add('recording');
    voiceRecognition.start();
    showToast('Listening... Click mic to stop', 'success');
}

function stopVoiceRecording() {
    isRecording = false;
    document.getElementById('voiceInputBtn').classList.remove('recording');
    if (voiceRecognition) {
        voiceRecognition.stop();
    }
}

document.getElementById('voiceInputBtn').addEventListener('click', function() {
    if (isRecording) {
        stopVoiceRecording();
    } else {
        startVoiceRecording();
    }
});

// === CLIENT NOTES ===
window.currentClientNotes = [];

function updateClientNotes(notes, isInitialLoad) {
    var list = document.getElementById('clientNotesList');
    var count = document.getElementById('clientNotesCount');
    var notesArray = [];
    
    if (typeof notes === 'string' && notes) {
        try { 
            var parsed = JSON.parse(notes);
            if (Array.isArray(parsed)) {
                notesArray = parsed;
            } else {
                notesArray = [{ time: new Date().toISOString(), text: notes }];
            }
        } catch(e) { 
            if (notes.trim()) {
                notesArray = [{ time: new Date().toISOString(), text: notes }];
            }
        }
    } else if (Array.isArray(notes)) {
        notesArray = notes;
    }
    
    window.currentClientNotes = notesArray;
    
    if (isInitialLoad) {
        originalClientNotes = JSON.parse(JSON.stringify(notesArray));
    }
    
    count.textContent = notesArray.length;
    
    if (notesArray.length === 0) {
        list.innerHTML = '<p style="color:var(--text-muted);font-size:0.875rem;text-align:center;padding:12px;">No notes yet</p>';
    } else {
        // Sort newest first (reverse the array for display)
        var sortedNotes = notesArray.slice().reverse();
        var displayLimit = 2;
        var hasMore = sortedNotes.length > displayLimit;
        
        var html = '';
        sortedNotes.forEach(function(n, displayIndex) {
            var originalIndex = notesArray.length - 1 - displayIndex; // Map back to original index
            var isHidden = displayIndex >= displayLimit;
            html += '<div class="note-item' + (isHidden ? ' note-hidden' : '') + '" style="' + (isHidden ? 'display:none;' : '') + '"><div class="note-item-header"><span class="note-item-time">' + formatDateTime(n.time) + '</span><div class="note-item-actions"><button class="btn-edit-note" data-index="' + originalIndex + '" title="Edit"></button><button class="btn-delete-note" data-index="' + originalIndex + '" title="Delete"></button></div></div><div class="note-item-text">' + escapeHtml(n.text) + '</div></div>';
        });
        
        if (hasMore) {
            html += '<button class="btn-expand-notes" id="expandNotesBtn" style="width:100%;padding:8px;background:transparent;border:1px solid var(--border);border-radius:6px;color:var(--text-secondary);font-size:0.8125rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;margin-top:8px;"><span class="expand-chevron" style="transition:transform 0.2s;"></span> View all ' + sortedNotes.length + ' notes</button>';
        }
        
        list.innerHTML = html;
        
        list.querySelectorAll('.btn-edit-note').forEach(function(btn) {
            btn.addEventListener('click', function() {
                editClientNote(parseInt(this.dataset.index));
            });
        });
        
        list.querySelectorAll('.btn-delete-note').forEach(function(btn) {
            btn.addEventListener('click', function() {
                deleteClientNote(parseInt(this.dataset.index));
            });
        });
        
        var expandBtn = document.getElementById('expandNotesBtn');
        if (expandBtn) {
            expandBtn.addEventListener('click', function() {
                var hiddenNotes = list.querySelectorAll('.note-hidden');
                var chevron = this.querySelector('.expand-chevron');
                var isExpanded = this.dataset.expanded === 'true';
                
                if (isExpanded) {
                    hiddenNotes.forEach(function(n) { n.style.display = 'none'; });
                    chevron.style.transform = 'rotate(0deg)';
                    this.innerHTML = '<span class="expand-chevron" style="transition:transform 0.2s;"></span> View all ' + sortedNotes.length + ' notes';
                    this.dataset.expanded = 'false';
                } else {
                    hiddenNotes.forEach(function(n) { n.style.display = 'flex'; });
                    chevron.style.transform = 'rotate(180deg)';
                    this.innerHTML = '<span class="expand-chevron" style="transition:transform 0.2s;transform:rotate(180deg);"></span> Show less';
                    this.dataset.expanded = 'true';
                }
            });
        }
    }
}

function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function editClientNote(index) {
    if (!window.currentClientNotes || index < 0 || index >= window.currentClientNotes.length) return;
    var note = window.currentClientNotes[index];
    document.getElementById('agentNotesInput').value = note.text;
    editingNoteIndex = index;
    document.getElementById('agentNotesInput').focus();
    showToast('Editing note - make changes and save', 'info');
}

function deleteClientNote(index) {
    if (!currentLeadId || !window.currentClientNotes) return;
    
    window.currentClientNotes.splice(index, 1);
    saveNotesToAirtable();
}

async function saveNotesToAirtable(isNewNote) {
    if (!currentLeadId) return;
    
    try {
        var notesJson = JSON.stringify(window.currentClientNotes);
        // Only update Client Notes - other timestamp fields are computed/formula
        var fieldsToUpdate = { 'Client Notes': notesJson };
        
        var response = await fetch('https://api.airtable.com/v0/' + AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + currentLeadId, {
            method: 'PATCH',
            headers: { 'Authorization': 'Bearer ' + AIRTABLE_TOKEN, 'Content-Type': 'application/json' },
            body: JSON.stringify({ fields: fieldsToUpdate })
        });
        
        if (!response.ok) {
            var errorData = await response.json();
            console.error('Airtable save error:', errorData);
            throw new Error(errorData.error?.message || 'Failed to save');
        }
        
        var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
        if (lead) {
            lead.fields['Client Notes'] = notesJson;
        }
        
        // Also update in displayedLeads and prioLeads
        var displayedLead = displayedLeads.find(function(l) { return l.id === currentLeadId; });
        if (displayedLead) {
            displayedLead.fields['Client Notes'] = notesJson;
        }
        var prioLead = prioLeads.find(function(l) { return l.id === currentLeadId; });
        if (prioLead) {
            prioLead.fields['Client Notes'] = notesJson;
        }
        
        originalClientNotes = JSON.parse(JSON.stringify(window.currentClientNotes));
        updateClientNotes(window.currentClientNotes, false);
        
        // Re-render tables to show updated notes
        renderPrio();
        renderLeads();
        showToast('Note saved', 'success');
        
    } catch (err) {
        console.error('Error saving notes:', err);
        showToast('Failed to save notes', 'error');
    }
}

async function saveCurrentNote() {
    var noteText = document.getElementById('agentNotesInput').value.trim();
    if (!noteText) {
        showToast('Please enter a note', 'warning');
        return;
    }
    
    var isNewNote = !(editingNoteIndex >= 0 && editingNoteIndex < window.currentClientNotes.length);
    
    if (editingNoteIndex >= 0 && editingNoteIndex < window.currentClientNotes.length) {
        // Editing existing note - update text and time
        window.currentClientNotes[editingNoteIndex] = {
            time: new Date().toISOString(),
            text: noteText
        };
    } else {
        // New note
        window.currentClientNotes.push({
            time: new Date().toISOString(),
            text: noteText
        });
    }
    
    await saveNotesToAirtable(isNewNote);
    document.getElementById('agentNotesInput').value = '';
    editingNoteIndex = -1;
    showToast('Note saved!', 'success');
}

document.getElementById('saveNoteBtn').addEventListener('click', saveCurrentNote);

// === CLIENT CALL ATTEMPTS ===
function updateClientAttempts(attempts, isInitialLoad) {
    var list = document.getElementById('clientAttemptsList');
    var count = document.getElementById('clientAttemptCount');
    var attemptsArray = [];
    
    if (typeof attempts === 'string' && attempts) {
        try { attemptsArray = JSON.parse(attempts); } catch(e) { attemptsArray = []; }
    } else if (Array.isArray(attempts)) {
        attemptsArray = attempts;
    }
    
    // Store globally for delete functionality
    window.currentClientAttempts = attemptsArray;
    
    // Store original on initial load
    if (isInitialLoad) {
        originalClientAttempts = JSON.parse(JSON.stringify(attemptsArray));
    }
    
    count.textContent = attemptsArray.length;
    
    if (attemptsArray.length === 0) {
        list.innerHTML = '<p style="color:var(--text-muted);font-size:0.8125rem;text-align:center;">No call attempts logged yet</p>';
    } else {
        list.innerHTML = attemptsArray.map(function(a, i) {
            return '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--bg-secondary);border-radius:6px;font-size:0.8125rem;"><span>' + formatDateTime(a.time) + '</span><div style="display:flex;align-items:center;gap:8px;"><span style="color:var(--text-muted);">#' + (i + 1) + '</span><button class="btn-delete-attempt" data-index="' + i + '" style="background:none;border:none;color:var(--text-muted);cursor:pointer;padding:2px 6px;font-size:0.75rem;opacity:0.6;transition:all 0.2s;" title="Delete attempt"></button></div></div>';
        }).join('');
        
        list.querySelectorAll('.btn-delete-attempt').forEach(function(btn) {
            btn.addEventListener('click', function() {
                deleteClientAttempt(parseInt(this.dataset.index));
            });
            btn.addEventListener('mouseenter', function() { this.style.opacity = '1'; this.style.color = '#EF4444'; });
            btn.addEventListener('mouseleave', function() { this.style.opacity = '0.6'; this.style.color = 'var(--text-muted)'; });
        });
    }
}

async function saveClientAttemptsToAirtable() {
    if (!currentLeadId) return;
    
    try {
        var attemptsJson = JSON.stringify(window.currentClientAttempts || []);
        var fieldsToUpdate = { 'Client Attempts': attemptsJson };
        
        // Update Client Last Call Timestamp to latest attempt time
        var lastCallTime = null;
        if (window.currentClientAttempts && window.currentClientAttempts.length > 0) {
            lastCallTime = window.currentClientAttempts[window.currentClientAttempts.length - 1].time;
            fieldsToUpdate['Client Last Call Timestamp'] = new Date(lastCallTime).toISOString();
        }
        
        console.log('Saving to Airtable:', fieldsToUpdate);
        
        var response = await fetch('https://api.airtable.com/v0/' + AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + currentLeadId, {
            method: 'PATCH',
            headers: { 'Authorization': 'Bearer ' + AIRTABLE_TOKEN, 'Content-Type': 'application/json' },
            body: JSON.stringify({ fields: fieldsToUpdate })
        });
        
        if (!response.ok) {
            var errorData = await response.json();
            console.error('Airtable error details:', JSON.stringify(errorData, null, 2));
            throw new Error(errorData.error?.message || 'Failed to save');
        }
        
        var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
        if (lead) {
            lead.fields['Client Attempts'] = attemptsJson;
            if (fieldsToUpdate['Client Last Call Timestamp']) {
                lead.fields['Client Last Call Timestamp'] = fieldsToUpdate['Client Last Call Timestamp'];
            }
        }
        
        // Also update in displayedLeads and prioLeads
        var displayedLead = displayedLeads.find(function(l) { return l.id === currentLeadId; });
        if (displayedLead) {
            displayedLead.fields['Client Attempts'] = attemptsJson;
            if (fieldsToUpdate['Client Last Call Timestamp']) {
                displayedLead.fields['Client Last Call Timestamp'] = fieldsToUpdate['Client Last Call Timestamp'];
            }
        }
        var prioLead = prioLeads.find(function(l) { return l.id === currentLeadId; });
        if (prioLead) {
            prioLead.fields['Client Attempts'] = attemptsJson;
            if (fieldsToUpdate['Client Last Call Timestamp']) {
                prioLead.fields['Client Last Call Timestamp'] = fieldsToUpdate['Client Last Call Timestamp'];
            }
        }
        
        // Update the modal Last Called display immediately using getMostRecentLastCalled
        var modalLastCalled = document.getElementById('modalLastCalled');
        if (modalLastCalled && lead) {
            modalLastCalled.textContent = formatDateTime(getMostRecentLastCalled(lead.fields));
        }
        
        // Update attempts display
        updateClientAttempts(window.currentClientAttempts, false);
        
        // Re-render tables to show updated data
        renderPrio();
        renderLeads();
        
        originalClientAttempts = JSON.parse(JSON.stringify(window.currentClientAttempts || []));
        
    } catch (err) {
        console.error('Error saving attempts:', err);
        showToast('Failed to save call attempt', 'error');
    }
}

function deleteClientAttempt(index) {
    if (!currentLeadId || !window.currentClientAttempts) return;
    
    window.currentClientAttempts.splice(index, 1);
    updateClientAttempts(window.currentClientAttempts, false);
    saveClientAttemptsToAirtable();
    showToast('Call attempt removed', 'success');
}

document.getElementById('addClientAttemptBtn').addEventListener('click', async function() {
    if (!currentLeadId) return;
    
    if (!window.currentClientAttempts) {
        window.currentClientAttempts = [];
    }
    
    window.currentClientAttempts.push({ time: new Date().toISOString() });
    updateClientAttempts(window.currentClientAttempts, false);
    await saveClientAttemptsToAirtable();
    showToast('Call attempt logged', 'success');
});

document.getElementById('logoutBtn').addEventListener('click', function() { supabase.auth.signOut().then(function() { window.location.href = '/'; }); });
document.getElementById('mobileLogoutBtn').addEventListener('click', function() { supabase.auth.signOut().then(function() { window.location.href = '/'; }); });
</script>

<script>
var html = document.documentElement;
var savedTheme = localStorage.getItem('theme') || 'dark';
html.setAttribute('data-theme', savedTheme);
document.getElementById('themeToggle').addEventListener('click', function() {
    var newTheme = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
});
var mobileMenuBtn = document.getElementById('mobileMenuBtn');
var mobileMenu = document.getElementById('mobileMenu');
var mobileMenuClose = document.getElementById('mobileMenuClose');
if (mobileMenuBtn && mobileMenu) {
    mobileMenuBtn.addEventListener('click', function() { mobileMenu.classList.add('active'); document.body.style.overflow = 'hidden'; });
    if (mobileMenuClose) mobileMenuClose.addEventListener('click', function() { mobileMenu.classList.remove('active'); document.body.style.overflow = ''; });
}
var userMenuBtn = document.getElementById('userMenuBtn');
var userDropdown = document.getElementById('userDropdown');
if (userMenuBtn && userDropdown) {
    userMenuBtn.addEventListener('click', function() { userDropdown.classList.toggle('active'); });
    document.addEventListener('click', function(e) { if (!e.target.closest('.user-menu')) userDropdown.classList.remove('active'); });
}
</script>

<script>
supabase.auth.getSession().then(async function(result) {
    if (!result.data.session) { window.location.href = '/login/'; return; }
    currentUser = result.data.session.user;
    currentUserEmail = currentUser.email;
    updateUserUI(currentUser);
    
    // Check if user is admin
    isAdmin = currentUserEmail.toLowerCase() === ADMIN_EMAIL.toLowerCase();
    if (isAdmin) {
        await initAdminPanel();
    }
    
    try {
        var data = await fetchUserData();
        if (data.records && data.records.length > 0) {
            if (data.records[0].fields.Status !== 'Active' && !isAdmin) { window.location.href = '/pricing/?status=' + (data.records[0].fields.Status || 'unpaid'); return; }
            showDashboard();
            // Show loading spinners for tables
            document.getElementById('leadsLoadingRow').style.display = 'table-row';
            document.getElementById('prioLoadingRow').style.display = 'table-row';
            fetchAllActiveAgents(); // Fetch agent names for sharing display
            fetchAllLeads().then(function() { 
                document.getElementById('prioLoadingRow').style.display = 'none';
                renderPrio(); 
                fetchDisplayedLeads();
                handleHashChange();
            });
        } else if (!isAdmin) { window.location.href = '/onboarding/'; } else { 
            showDashboard(); 
            document.getElementById('leadsLoadingRow').style.display = 'table-row';
            document.getElementById('prioLoadingRow').style.display = 'table-row';
            fetchAllActiveAgents(); 
            fetchAllLeads().then(function() { 
                document.getElementById('prioLoadingRow').style.display = 'none';
                renderPrio(); 
                fetchDisplayedLeads(); 
            }); 
        }
    } catch (err) { 
        console.error(err); 
        showDashboard(); 
        document.getElementById('leadsLoadingRow').style.display = 'table-row';
        document.getElementById('prioLoadingRow').style.display = 'table-row';
        fetchAllActiveAgents(); 
        fetchAllLeads().then(function() { 
            document.getElementById('prioLoadingRow').style.display = 'none';
            renderPrio(); 
            fetchDisplayedLeads(); 
        }); 
    }
});

// === ADMIN FUNCTIONALITY ===
async function initAdminPanel() {
    document.getElementById('adminPanel').style.display = 'block';
    
    // Fetch all clients
    try {
        var allRecords = [];
        var offset = null;
        do {
            var url = 'https://api.airtable.com/v0/' + AIRTABLE_BASE + '/' + AIRTABLE_CLIENTS_TABLE + '?pageSize=100';
            if (offset) url += '&offset=' + offset;
            var response = await fetch(url, { headers: { 'Authorization': 'Bearer ' + AIRTABLE_TOKEN } });
            var data = await response.json();
            if (data.records) allRecords = allRecords.concat(data.records);
            offset = data.offset;
        } while (offset);
        
        allClients = allRecords.sort(function(a, b) {
            var nameA = (a.fields['Agent Name'] || a.fields['Email'] || '').toLowerCase();
            var nameB = (b.fields['Agent Name'] || b.fields['Email'] || '').toLowerCase();
            return nameA.localeCompare(nameB);
        });
        
        // Populate dropdown
        var select = document.getElementById('adminClientSelect');
        select.innerHTML = '<option value="">-- View as yourself --</option>';
        allClients.forEach(function(client) {
            var name = client.fields['Agent Name'] || 'Unknown';
            var email = client.fields['Email'] || '';
            var status = client.fields['Status'] || 'Unknown';
            var calls = client.fields['Total Calls'] || 0;
            var opt = document.createElement('option');
            opt.value = email;
            opt.textContent = name + ' (' + email + ') - ' + status + ' - ' + calls + ' calls';
            opt.dataset.status = status;
            opt.dataset.calls = calls;
            opt.dataset.name = name;
            select.appendChild(opt);
        });
        
        // Update admin stats
        updateAdminStats();
    } catch (err) {
        console.error('Error fetching clients:', err);
    }
}

function updateAdminStats() {
    var totalLeads = allClients.reduce(function(sum, c) { return sum + (parseInt(c.fields['Total Leads']) || 0); }, 0);
    var totalCalls = allClients.reduce(function(sum, c) { return sum + (parseInt(c.fields['Total Calls']) || 0); }, 0);
    var activeClients = allClients.filter(function(c) { return c.fields['Status'] === 'Active'; }).length;
    
    document.getElementById('adminTotalLeads').textContent = totalLeads;
    document.getElementById('adminTotalCalls').textContent = totalCalls;
    document.getElementById('adminBookedLeads').textContent = activeClients;
    document.getElementById('adminClientStatus').textContent = allClients.length + ' total';
}

document.getElementById('adminViewBtn').addEventListener('click', async function() {
    var select = document.getElementById('adminClientSelect');
    var selectedEmail = select.value;
    
    if (selectedEmail) {
        viewingAsClient = selectedEmail;
        var selectedOpt = select.options[select.selectedIndex];
        document.getElementById('dashboardUserName').textContent = selectedOpt.dataset.name + ' (Admin View)';
        document.getElementById('adminStats').style.display = 'grid';
        
        // Update individual client stats
        var client = allClients.find(function(c) { return c.fields['Email'] === selectedEmail; });
        if (client) {
            document.getElementById('adminTotalLeads').textContent = client.fields['Total Leads'] || 0;
            document.getElementById('adminTotalCalls').textContent = client.fields['Total Calls'] || 0;
            document.getElementById('adminBookedLeads').textContent = client.fields['Booked Leads'] || 0;
            document.getElementById('adminClientStatus').textContent = client.fields['Status'] || '-';
        }
    } else {
        viewingAsClient = null;
        document.getElementById('dashboardUserName').textContent = currentUserRecord?.fields['Agent Name'] || currentUser.email.split('@')[0];
        document.getElementById('adminStats').style.display = 'none';
    }
    
    showToast(selectedEmail ? 'Viewing dashboard as ' + selectedEmail : 'Viewing your own dashboard', 'success');
    
    // Refresh all data
    await fetchAllLeads();
    renderPrio();
    fetchDisplayedLeads();
});

document.getElementById('adminClientSelect').addEventListener('change', function() {
    var selectedEmail = this.value;
    if (selectedEmail) {
        document.getElementById('adminStats').style.display = 'grid';
        var client = allClients.find(function(c) { return c.fields['Email'] === selectedEmail; });
        if (client) {
            document.getElementById('adminTotalLeads').textContent = client.fields['Total Leads'] || 0;
            document.getElementById('adminTotalCalls').textContent = client.fields['Total Calls'] || 0;
            document.getElementById('adminBookedLeads').textContent = client.fields['Booked Leads'] || 0;
            document.getElementById('adminClientStatus').textContent = client.fields['Status'] || '-';
        }
    } else {
        document.getElementById('adminStats').style.display = 'none';
    }
});

// ========== NOTIFICATION SYSTEM ==========
var notifications = [];
var notificationStorageKey = 'prioai_notifications';

function loadNotifications() {
    try {
        var stored = localStorage.getItem(notificationStorageKey + '_' + currentUserEmail);
        if (stored) {
            notifications = JSON.parse(stored);
        }
    } catch (e) {
        notifications = [];
    }
    renderNotifications();
}

function saveNotifications() {
    try {
        localStorage.setItem(notificationStorageKey + '_' + currentUserEmail, JSON.stringify(notifications));
    } catch (e) {}
}

function addNotification(type, title, message, data) {
    var notification = {
        id: Date.now(),
        type: type, // 'booked', 'callback', 'stats', 'reminder'
        title: title,
        message: message,
        data: data || {},
        time: new Date().toISOString(),
        read: false
    };
    notifications.unshift(notification);
    // Keep only last 50 notifications
    if (notifications.length > 50) notifications = notifications.slice(0, 50);
    saveNotifications();
    renderNotifications();
}

function renderNotifications() {
    var list = document.getElementById('notificationList');
    var badge = document.getElementById('notificationBadge');
    var unreadCount = notifications.filter(function(n) { return !n.read; }).length;
    
    badge.textContent = unreadCount > 0 ? (unreadCount > 9 ? '9+' : unreadCount) : '';
    
    if (notifications.length === 0) {
        list.innerHTML = '<div class="notification-empty">No notifications yet</div>';
        return;
    }
    
    list.innerHTML = notifications.slice(0, 20).map(function(n) {
        var iconClass = n.type === 'booked' ? 'booked' : n.type === 'callback' ? 'callback' : n.type === 'stats' ? 'stats' : 'reminder';
        var icon = n.type === 'booked' ? '' : n.type === 'callback' ? '' : n.type === 'stats' ? '' : '';
        var timeAgo = getTimeAgo(n.time);
        return '<div class="notification-item ' + (n.read ? '' : 'unread') + '" data-id="' + n.id + '">' +
            '<span class="notification-icon ' + iconClass + '">' + icon + '</span>' +
            '<span class="notification-content">' +
            '<div class="notification-title">' + n.title + '</div>' +
            '<div class="notification-time">' + timeAgo + '</div>' +
            '</span></div>';
    }).join('');
    
    // Add click handlers
    list.querySelectorAll('.notification-item').forEach(function(item) {
        item.addEventListener('click', function() {
            var id = parseInt(this.dataset.id);
            markNotificationRead(id);
            // Could navigate to relevant section based on notification type
        });
    });
}

function markNotificationRead(id) {
    var n = notifications.find(function(n) { return n.id === id; });
    if (n) {
        n.read = true;
        saveNotifications();
        renderNotifications();
    }
}

function markAllNotificationsRead() {
    notifications.forEach(function(n) { n.read = true; });
    saveNotifications();
    renderNotifications();
}

function getTimeAgo(isoString) {
    var date = new Date(isoString);
    var now = new Date();
    var diff = Math.floor((now - date) / 1000);
    
    if (diff < 60) return 'Just now';
    if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
    if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
    if (diff < 604800) return Math.floor(diff / 86400) + 'd ago';
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

// Check for new bookings/callbacks (compare with previous state)
var previousBookedIds = [];
var previousCallbackIds = [];

function checkForNewBookingsAndCallbacks() {
    var currentBooked = allLeads.filter(function(l) { return l.fields['Status'] === 'Booked'; });
    var currentCallbacks = allLeads.filter(function(l) { return l.fields['Status'] === 'Callback'; });
    
    // Check for new bookings
    currentBooked.forEach(function(lead) {
        if (previousBookedIds.indexOf(lead.id) === -1 && previousBookedIds.length > 0) {
            var name = ((lead.fields['First Name'] || '') + ' ' + (lead.fields['Last Name'] || '')).trim() || 'Lead';
            addNotification('booked', 'New Booking!', name + ' booked a meeting', { leadId: lead.id });
        }
    });
    
    // Check for new callbacks
    currentCallbacks.forEach(function(lead) {
        if (previousCallbackIds.indexOf(lead.id) === -1 && previousCallbackIds.length > 0) {
            var name = ((lead.fields['First Name'] || '') + ' ' + (lead.fields['Last Name'] || '')).trim() || 'Lead';
            addNotification('callback', 'New Callback!', name + ' wants a callback', { leadId: lead.id });
        }
    });
    
    previousBookedIds = currentBooked.map(function(l) { return l.id; });
    previousCallbackIds = currentCallbacks.map(function(l) { return l.id; });
}

// Daily stats reminder at 8pm EST
function checkDailyStatsReminder() {
    var now = new Date();
    var estHour = now.getUTCHours() - 5; // EST offset
    if (estHour < 0) estHour += 24;
    
    var lastReminderKey = 'prioai_last_stats_reminder_' + currentUserEmail;
    var lastReminder = localStorage.getItem(lastReminderKey);
    var today = now.toISOString().split('T')[0];
    
    // If it's after 8pm EST and we haven't shown reminder today
    if (estHour >= 20 && lastReminder !== today) {
        addNotification('reminder', 'Check Your Daily Stats', 'Your daily performance summary is ready!', {});
        localStorage.setItem(lastReminderKey, today);
    }
}

// Weekly stats notification (Monday 8am EST)
function checkWeeklyStatsNotification() {
    var now = new Date();
    var estHour = now.getUTCHours() - 5;
    if (estHour < 0) estHour += 24;
    var dayOfWeek = now.getDay();
    
    var lastWeeklyKey = 'prioai_last_weekly_' + currentUserEmail;
    var lastWeekly = localStorage.getItem(lastWeeklyKey);
    var thisWeek = now.toISOString().split('T')[0].substring(0, 7) + '-W' + Math.ceil(now.getDate() / 7);
    
    // Monday after 8am EST
    if (dayOfWeek === 1 && estHour >= 8 && lastWeekly !== thisWeek) {
        addNotification('stats', 'Weekly Stats Ready', 'Your weekly performance summary has been updated!', {});
        localStorage.setItem(lastWeeklyKey, thisWeek);
    }
}

// Monthly stats notification (1st at 8:30am EST)
function checkMonthlyStatsNotification() {
    var now = new Date();
    var estHour = now.getUTCHours() - 5;
    if (estHour < 0) estHour += 24;
    var dayOfMonth = now.getDate();
    
    var lastMonthlyKey = 'prioai_last_monthly_' + currentUserEmail;
    var lastMonthly = localStorage.getItem(lastMonthlyKey);
    var thisMonth = now.toISOString().split('T')[0].substring(0, 7);
    
    // 1st of month after 8:30am EST
    if (dayOfMonth === 1 && estHour >= 8 && lastMonthly !== thisMonth) {
        addNotification('stats', 'Monthly Stats Ready', 'Your monthly performance summary has been updated!', {});
        localStorage.setItem(lastMonthlyKey, thisMonth);
    }
}

// Notification bell click handler
document.getElementById('notificationBell').addEventListener('click', function(e) {
    e.stopPropagation();
    var dropdown = document.getElementById('notificationDropdown');
    dropdown.classList.toggle('active');
});

document.getElementById('markAllReadBtn').addEventListener('click', function(e) {
    e.stopPropagation();
    markAllNotificationsRead();
});

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    var dropdown = document.getElementById('notificationDropdown');
    var bell = document.getElementById('notificationBell');
    if (!bell.contains(e.target)) {
        dropdown.classList.remove('active');
    }
});

// Initialize notifications after login
var origFetchAllLeads = fetchAllLeads;
fetchAllLeads = async function() {
    var result = await origFetchAllLeads.apply(this, arguments);
    checkForNewBookingsAndCallbacks();
    return result;
};

// Check for timed notifications on load and every 5 minutes
setTimeout(function() {
    loadNotifications();
    checkDailyStatsReminder();
    checkWeeklyStatsNotification();
    checkMonthlyStatsNotification();
}, 2000);

setInterval(function() {
    checkDailyStatsReminder();
    checkWeeklyStatsNotification();
    checkMonthlyStatsNotification();
}, 300000); // Every 5 minutes
</script>
</body>
</html>
